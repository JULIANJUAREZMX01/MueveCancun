name: Delegate to Claude (unscoped tasks)

on:
  workflow_dispatch:
    inputs:
      instructions:
        description: "Context or tasks to delegate (leave blank to let Claude plan)."
        required: false
        type: string

concurrency:
  group: claude-delegation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  claude-delegation:
    name: Send unplanned work to Claude
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare delegation instructions
        id: prepare
        run: |
          INPUT="${{ github.event.inputs.instructions }}"
          if [ -z "$INPUT" ]; then
            INPUT="No user input provided. Generate a minimal plan, then propose changes via PR against the current branch. Do not push directly to protected branches."
          fi
          echo "prepared_instructions<<'EOF'" >> "$GITHUB_OUTPUT"
          echo "$INPUT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Claude Code Base Action (plan and apply)
        uses: anthropics/claude-code-base-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          instructions: |
            Perform planning and application in one run. Outline steps, assumptions, and ambiguities, then apply or propose changes via a branch/PRâ€”not direct pushes to protected branches.
            User input: ${{ steps.prepare.outputs.prepared_instructions }}
