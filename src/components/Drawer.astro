---
import { SITE, LINKS } from "@consts"
import { cn } from "@lib/utils"
const { pathname } = Astro.url
const subpath = pathname.match(/[^/]+/g)
---

<div id="drawer" popover class="fixed inset-0 w-screen h-screen z-40 flex flex-col items-center justify-center md:hidden bg-neutral-100 dark:bg-neutral-900 transition-colors duration-300">
  <nav class="flex flex-col items-center space-y-2">
    {
      LINKS.map((LINK) => (
        <a href={LINK.HREF} class={cn("flex items-center justify-center px-3 py-1 rounded-full", "text-current hover:text-black dark:hover:text-white", "hover:bg-black/5 dark:hover:bg-white/20", "transition-colors duration-300 ease-in-out", pathname === LINK.HREF || "/" + subpath?.[0] === LINK.HREF ? "pointer-events-none bg-black dark:bg-white text-white dark:text-black" : "")}>
          {LINK.TEXT}
        </a>
      ))
    }
  </nav>

  <div class="flex gap-1 mt-5">
    <a href="/search" aria-label={`Search blog posts and projects on ${SITE.TITLE}`} class={cn("size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out", pathname === "/search" || "/" + subpath?.[0] === "search" ? "pointer-events-none bg-black dark:bg-white text-white dark:text-black" : "")}>
      <svg class="size-full">
        <use href="/ui.svg#search"></use>
      </svg>
    </a>

    <a href="/rss.xml" target="_blank" aria-label={`Rss feed for ${SITE.TITLE}`} class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out">
      <svg class="size-full">
        <use href="/ui.svg#rss"></use>
      </svg>
    </a>

    <button id="drawer-theme-button" aria-label={`Toggle light and dark theme`} class="size-9 rounded-full p-2 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 stroke-current hover:stroke-black hover:dark:stroke-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out">
      <svg class="block dark:hidden size-full">
        <use href="/ui.svg#sun"></use>
      </svg>
      <svg class="hidden dark:block size-full">
        <use href="/ui.svg#moon"></use>
      </svg>
    </button>
    <button id="drawer-lang-button" aria-label="Cambiar idioma / Switch language" class="size-9 rounded-full p-1 items-center justify-center bg-transparent hover:bg-black/5 dark:hover:bg-white/20 text-current hover:text-black hover:dark:text-white border border-black/10 dark:border-white/25 transition-colors duration-300 ease-in-out font-bold text-xs uppercase tracking-wide">
      <span class="lang-text">ES</span>
    </button>
  </div>
</div>

<style>
  #drawer {
    /* Native Popover Reset */
    margin: 0;
    padding: 0;
    border: none;

    /* Full Screen Overlay */
    width: 100vw;
    height: 100vh;
    max-width: 100vw;
    max-height: 100vh;

    /* Animation Base State (Closed) */
    opacity: 0;
    transform: translateY(-20px);

    /* Transition Properties */
    transition:
      opacity 0.3s ease-out,
      transform 0.3s cubic-bezier(0.32, 0.72, 0, 1),
      display 0.3s allow-discrete,
      overlay 0.3s allow-discrete;
  }

  #drawer:popover-open {
    opacity: 1;
    transform: translateY(0);
  }

  @starting-style {
    #drawer:popover-open {
      opacity: 0;
      transform: translateY(-20px);
    }
  }

  /* Backdrop Blur Effect */
  #drawer::backdrop {
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition:
      opacity 0.3s ease-out,
      display 0.3s allow-discrete,
      overlay 0.3s allow-discrete;
  }

  #drawer:popover-open::backdrop {
    opacity: 1;
  }

  @starting-style {
    #drawer:popover-open::backdrop {
      opacity: 0;
    }
  }
</style>

<script>
  function initDrawer() {
    const drawer = document.getElementById("drawer");
    if (!drawer) return;

    drawer.addEventListener("click", (event) => {
      const target = event.target as HTMLElement;
      if (target.closest("a") || target.closest("button")) {
        // Don't close if it's the theme or lang button (they need interaction)
        if (target.closest("#drawer-theme-button") || target.closest("#drawer-lang-button")) return;

        // Native method to hide popover
        (drawer as HTMLElement).hidePopover();
      }
    });

    // Language Toggle Logic for Drawer
    const btn = document.getElementById("drawer-lang-button");
    if (btn) {
        const updateUI = () => {
             const current = localStorage.getItem('lang') || 'es';
             const span = btn.querySelector('.lang-text');
             if (span) span.textContent = current.toUpperCase();
        };
        updateUI();
        
        // Remove old listeners by cloning
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', () => {
             const current = localStorage.getItem('lang') || 'es';
             const next = current === 'es' ? 'en' : 'es';
             localStorage.setItem('lang', next);
             document.documentElement.lang = next;
             window.dispatchEvent(new CustomEvent('LANGUAGE_CHANGE', { detail: next }));
             updateUI();
        });
        
        window.addEventListener('LANGUAGE_CHANGE', updateUI);
    }
  }

  // Initial load
  initDrawer();

  // View Transitions support
  document.addEventListener("astro:after-swap", initDrawer);
</script>
