---
interface Props {
  center?: [number, number];
  zoom?: number;
}

const {
  center = [21.1619, -86.8515], // Cancún
  zoom = 12
} = Astro.props;
---

<div class="relative w-full h-[500px] overflow-hidden rounded-xl border border-gray-200 shadow-inner z-0">
  <div id="map-container" class="w-full h-full z-0" data-center={JSON.stringify(center)} data-zoom={zoom}></div>

  <div id="map-loader" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-[1000]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary-500 border-t-transparent mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium">Cargando mapa...</p>
    </div>
  </div>
</div>

<script>
  let map;
  let layerGroup;
  let coordinatesDB = {};

  async function initMap() {
    const container = document.getElementById('map-container');
    const loader = document.getElementById('map-loader');

    if (!container || window.L === undefined) {
        console.warn("Leaflet not loaded or container missing");
        return;
    }

    if (container._leaflet_id) return; // Prevent double init

    const center = JSON.parse(container.dataset.center);
    const zoom = parseFloat(container.dataset.zoom);

    // Initialize Leaflet
    map = window.L.map('map-container', { preferCanvas: true }).setView(center, zoom);

    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    layerGroup = window.L.layerGroup().addTo(map);

    // Fetch Coordinates
    try {
        const res = await fetch('/coordinates.json');
        coordinatesDB = await res.json();
        console.log("Coordinates loaded:", Object.keys(coordinatesDB).length);
    } catch (e) {
        console.error("Failed to load coordinates:", e);
    }

    if (loader) loader.classList.add('hidden');

    // Check for pending route from other pages
    const pendingRoute = localStorage.getItem('pending_route');
    if (pendingRoute) {
        try {
            const stops = JSON.parse(pendingRoute);
            drawRoute({ stops });
            localStorage.removeItem('pending_route');
        } catch (e) {
            console.error("Error parsing pending route", e);
        }
    }

    // Default markers for key hubs if no route
    if (!pendingRoute) {
        const markers = [];
        Object.entries(coordinatesDB).forEach(([name, coords]) => {
            if (["El Crucero", "Zona Hotelera", "Aeropuerto T2", "Plaza Las Américas"].includes(name)) {
                 markers.push(window.L.marker(coords).bindPopup(`<b>${name}</b>`));
            }
        });
        markers.forEach(layer => layer.addTo(layerGroup));
    }
  }

  function drawRoute({ stops }) {
    if (!map) return;

    // Remove old layer group to avoid overhead during additions
    if (layerGroup) {
        layerGroup.clearLayers();
        layerGroup.remove();
    }

    // Prepare new layers array for batch addition
    const newLayers = [];

    if (!stops || stops.length === 0) {
        layerGroup = window.L.layerGroup().addTo(map);
        return;
    }

    const routeCoords = [];
    const validStops = [];

    stops.forEach(stopName => {
        // Fuzzy match or exact match
        let coords = coordinatesDB[stopName];

        // Simple fuzzy fallback if exact missing (e.g. "Av. Kabah" vs "Hospital General (Av. Kabah)")
        if (!coords) {
             const key = Object.keys(coordinatesDB).find(k => stopName.includes(k) || k.includes(stopName));
             if (key) coords = coordinatesDB[key];
        }

        if (coords) {
            routeCoords.push(coords);
            validStops.push({ name: stopName, latlng: coords });
        } else {
            console.warn(`[InteractiveMap] Skipping stop with missing coordinates: ${stopName}`);
        }
    });

    if (routeCoords.length > 0) {
        const layers = [];

        // Draw Polyline
        const polyline = window.L.polyline(routeCoords, { color: '#F97316', weight: 4, opacity: 0.8 });
        newLayers.push(polyline);

        // Add Markers (Start and End)
        const start = validStops[0];
        const end = validStops[validStops.length - 1];

        const startMarker = window.L.marker(start.latlng)
            .bindPopup(`<b>Inicio:</b> ${start.name}`);

        const endMarker = window.L.marker(end.latlng)
            .bindPopup(`<b>Fin:</b> ${end.name}`);

        newLayers.push(startMarker);
        newLayers.push(endMarker);

        // Intermediate dots (optimized with Canvas via map preference)
        validStops.slice(1, -1).forEach(stop => {
             newLayers.push(
                window.L.circleMarker(stop.latlng, { radius: 5, color: '#334155', fillOpacity: 1 })
                .bindPopup(stop.name)
             );
        });

        // Batch add to map
        layerGroup = window.L.layerGroup(newLayers).addTo(map);

        map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
        startMarker.openPopup();

    } else {
        console.warn("No coordinates found for stops:", stops);
        if (window.showToast) window.showToast("No se pudieron visualizar los puntos de esta ruta.", "error");
        layerGroup = window.L.layerGroup().addTo(map);
    }
  }

  // Listen for global event
  window.addEventListener('SHOW_ROUTE_ON_MAP', (event) => {
    console.log("Event received:", event.detail);
    drawRoute(event.detail);
  });

  // Init on load
  if (document.readyState === 'complete') {
      initMap();
  } else {
      window.addEventListener('load', initMap);
  }

  // Re-init on view transition
  document.addEventListener('astro:page-load', () => {
      // Small delay to ensure container exists
      setTimeout(initMap, 100);
  });

</script>
