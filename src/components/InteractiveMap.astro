---
interface Props {
  center?: [number, number];
  zoom?: number;
  class?: string;
  offset?: boolean; // Whether to offset center for Desktop Dock
}

const {
  center = [21.1619, -86.8515], // Cancún
  zoom = 12,
  class: className = "relative w-full h-full z-0",
  offset = false
} = Astro.props;
---

<div class={className}>
  <div id="map-container" class="w-full h-full z-0" data-center={JSON.stringify(center)} data-zoom={zoom} data-offset={offset}></div>

  <div id="map-loader" class="absolute inset-0 flex items-center justify-center bg-gray-50 dark:bg-slate-900 z-[1000] transition-opacity duration-500">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary-500 border-t-transparent mx-auto mb-4"></div>
      <p class="text-gray-600 dark:text-gray-300 font-medium">Cargando mapa...</p>
    </div>
  </div>
</div>

<script>
  let map;
  let layerGroup;
  let tileLayer;
  let coordinatesDB = {};

  const TILES = {
      light: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
      dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
  };

  const ATTRIBUTION = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>';

  async function initMap() {
    const container = document.getElementById('map-container');
    const loader = document.getElementById('map-loader');

    if (!container || window.L === undefined) {
        // Retry logic if Leaflet not yet loaded
        if (!window.L) {
             setTimeout(initMap, 200);
             return;
        }
        return;
    }

    if (container._leaflet_id) return; // Prevent double init

    const center = JSON.parse(container.dataset.center);
    const zoom = parseFloat(container.dataset.zoom);
    const useOffset = container.dataset.offset === 'true';

    // Cancún Bounds: [20.8, -87.3] to [21.6, -86.5]
    const maxBounds = [
        [20.8, -87.3], // South-West
        [21.6, -86.5]  // North-East
    ];

    map = window.L.map('map-container', {
        preferCanvas: true,
        maxBounds: maxBounds,
        maxBoundsViscosity: 1.0,
        minZoom: 10,
        zoomControl: false // We will add it manually or hide it for UI cleanliness
    }).setView(center, zoom);

    // Initial Tile Load
    const isDark = document.documentElement.classList.contains('dark');
    tileLayer = window.L.tileLayer(isDark ? TILES.dark : TILES.light, {
        attribution: ATTRIBUTION,
        minZoom: 10,
        maxZoom: 19
    }).addTo(map);

    layerGroup = window.L.layerGroup().addTo(map);

    // Apply Offset if Desktop
    if (useOffset && window.innerWidth >= 1024) {
        // Shift center right by approx 225px (half of 450px sidebar)
        // If sidebar is on the left, we want the map center to move right so it isn't hidden.
        // panBy([x, y]) translates the map pane.
        map.panBy([225, 0], { animate: false });
    }

    // Fetch Coordinates
    try {
        const res = await fetch('/coordinates.json');
        coordinatesDB = await res.json();
    } catch (e) {
        console.error("Failed to load coordinates:", e);
    }

    if (loader) {
        loader.classList.add('opacity-0');
        setTimeout(() => loader.classList.add('hidden'), 500);
    }

    // Theme Change Listener
    window.addEventListener('THEME_CHANGE', (e) => {
        const newTheme = e.detail.theme; // 'dark' or 'light'
        if (tileLayer) {
            tileLayer.setUrl(newTheme === 'dark' ? TILES.dark : TILES.light);
        }
    });

    // Check for pending route
    const pendingRoute = localStorage.getItem('pending_route');
    if (pendingRoute) {
        try {
            const data = JSON.parse(pendingRoute);
            if (Array.isArray(data)) {
                drawRoute({ stops: data });
            } else {
                drawRoute(data);
            }
            localStorage.removeItem('pending_route');
        } catch (e) { console.error(e); }
    }
  }

  function drawRoute(data) {
    if (!map) return;
    if (layerGroup) {
        layerGroup.clearLayers();
        layerGroup.remove();
    }

    let legs = [];
    if (data.legs && Array.isArray(data.legs)) {
        legs = data.legs;
    } else if (data.stops && Array.isArray(data.stops)) {
        legs = [{ stops: data.stops }];
    } else {
         layerGroup = window.L.layerGroup().addTo(map);
         return;
    }

    const newLayers = [];
    const allBounds = [];

    legs.forEach((leg, index) => {
        const stops = leg.stops || [];
        const routeCoords = [];
        const validStops = [];

        stops.forEach(stopName => {
            let coords = coordinatesDB[stopName];
            if (!coords) {
                 const key = Object.keys(coordinatesDB).find(k => stopName.includes(k) || k.includes(stopName));
                 if (key) coords = coordinatesDB[key];
            }

            if (coords) {
                routeCoords.push(coords);
                validStops.push({ name: stopName, latlng: coords });
                allBounds.push(coords);
            }
        });

        if (routeCoords.length > 0) {
            const isFirst = index === 0;
            const color = index === 0 ? '#F97316' : '#3B82F6';
            const dashArray = isFirst ? null : '10, 10';
            const weight = 6;

            newLayers.push(window.L.polyline(routeCoords, {
                color,
                weight,
                opacity: 0.9,
                dashArray,
                lineCap: 'round',
                lineJoin: 'round'
            }));

            if (index === 0) {
                 const start = validStops[0];
                 newLayers.push(window.L.circleMarker(start.latlng, { radius: 6, color: '#F97316', fillColor: '#fff', fillOpacity: 1, weight: 3 })
                    .bindPopup(`<b>Inicio:</b> ${start.name}`));
            }

            if (index === legs.length - 1) {
                 const end = validStops[validStops.length - 1];
                 newLayers.push(window.L.marker(end.latlng) // Use default icon or custom later
                    .bindPopup(`<b>Fin:</b> ${end.name}`));
            }
        }
    });

    if (newLayers.length > 0) {
        layerGroup = window.L.layerGroup(newLayers).addTo(map);
        if (allBounds.length > 0) {
             const container = document.getElementById('map-container');
             const useOffset = container.dataset.offset === 'true';
             const paddingLeft = (useOffset && window.innerWidth >= 1024) ? 450 : 50;

             map.fitBounds(allBounds, {
                 paddingTopLeft: [paddingLeft + 20, 50],
                 paddingBottomRight: [50, 50]
             });
        }
    }
  }

  window.addEventListener('SHOW_ROUTE_ON_MAP', (event) => {
    drawRoute(event.detail);
  });

  window.addEventListener('HIGHLIGHT_ROUTE', (event) => {
    drawRoute(event.detail);
  });

  // Re-init logic
  document.addEventListener('astro:page-load', () => {
      setTimeout(initMap, 100);
  });

  if (document.readyState === 'complete') initMap();
  else window.addEventListener('load', initMap);

</script>
