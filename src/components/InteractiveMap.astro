---
interface Props {
  center?: [number, number];
  zoom?: number;
}

const { center = [21.1619, -86.8515], zoom = 13 } = Astro.props;
---

<div id="map-container" class="w-full h-full relative" data-center={JSON.stringify(center)} data-zoom={zoom}>
    <!-- Map Element -->
    <div id="leaflet-map" class="w-full h-full z-0"></div>

    <!-- Map Controls (Custom) -->
    <div class="absolute bottom-24 right-4 z-[400] flex flex-col gap-2">
        <button id="gps-center-btn" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-xl shadow-lg flex items-center justify-center text-slate-600 dark:text-slate-300 hover:text-primary-500 transition-colors active:scale-95" style="anchor-name: --gps-map-btn" aria-label="Centrar en mi ubicaci√≥n">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
        </button>
        <div id="gps-tooltip" class="graffiti-tooltip left" style="position-anchor: --gps-map-btn">Mi Ubicaci√≥n</div>
    </div>
</div>

<script>

  import { coordinatesStore } from '../utils/CoordinatesStore';
  import { drawRoute } from '../utils/RouteDrawer';
  import { escapeHtml, safeUrl } from '../utils/utils';

  let map;
  let layerGroup;
  let coordinatesDB = {};

  async function initMap() {
    const container = document.getElementById('map-container');
    if (!container) return; // Not on a page with a map

    // CLEANUP: If map exists but container is new/different, destroy old map
    // Or if container has content (Leaflet artifact), clear it.
    if (map) {
        map.remove();
        map = null;
    }

    // Ensure Leaflet is loaded
    if (!window.L) {
        // Retry shortly
        setTimeout(initMap, 100);
        return;
    }

    const center = JSON.parse(container.dataset.center);
    const zoom = parseInt(container.dataset.zoom);

    map = window.L.map('leaflet-map', {
        zoomControl: false,
        attributionControl: false
    }).setView(center, zoom);

    // Add Tile Layer
    window.L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19
    }).addTo(map);

    // Load coordinates DB via Store (Optimized)
    try {
        await coordinatesStore.init();
        coordinatesDB = coordinatesStore.getDB() || {};
    } catch (e) {
        console.warn("Failed to load coordinates via Store", e);
    }

    // Map loading complete

    // Check for Picker Mode
    const urlParams = new URLSearchParams(window.location.search);
    const isPicker = urlParams.get('picker');

    if (isPicker) {
        if (window.showToast) window.showToast("Toque el mapa para seleccionar una parada cercana", "info");

        // Add visual indicator
        const indicator = document.createElement('div');
        indicator.className = 'absolute top-4 left-1/2 -translate-x-1/2 bg-primary-600 text-white px-4 py-2 rounded-full shadow-lg z-[1000] font-bold text-sm animate-bounce';
        indicator.textContent = "üìç Modo Selecci√≥n";
        container.parentElement.appendChild(indicator);

        map.on('click', (e) => {
            const { lat, lng } = e.latlng;

            // Use Store for Spatial Search
            const nearest = coordinatesStore.findNearest(lat, lng);
            let minDist = Infinity;

            if (nearest && coordinatesDB[nearest]) {
                 // Calculate distance to verify threshold (Store does it, but we need it for UI logic if we want strict < 1000m)
                 // Store fallback is 1.5km. Map logic was 1000m.
                 // We can trust the store or re-verify. Let's re-verify with Leaflet's distance to be consistent with previous logic.
                 const coords = coordinatesDB[nearest];
                 minDist = map.distance(e.latlng, coords);
            }

            // Threshold: 1000 meters
            if (nearest && minDist < 1000) {
                // Show confirmation popup at location
                window.L.popup()
                    .setLatLng(e.latlng)
                    .setContent(`
                        <div class="text-center">
                            <p class="font-bold mb-2">¬øSeleccionar "${escapeHtml(nearest)}"?</p>
                            <button id="confirm-pick-btn" class="bg-primary-500 text-white px-3 py-1 rounded text-xs font-bold">
                                ‚úÖ Confirmar
                            </button>
                        </div>
                    `)
                    .openOn(map);

                // Bind click to button (need delay for DOM)
                setTimeout(() => {
                    document.getElementById('confirm-pick-btn')?.addEventListener('click', () => {
                         window.location.href = `/?selected_stop=${encodeURIComponent(nearest)}`;
                    });
                }, 100);

            } else {
                 if (window.showToast) window.showToast("No hay paradas registradas cerca", "warning");
            }
        });

        // Return early to avoid drawing routes or default markers that might confuse
        return;
    }

    // Check for pending route from other pages
    const pendingRoute = localStorage.getItem('pending_route');
    if (pendingRoute) {
        try {
            const data = JSON.parse(pendingRoute);
            const newLg = drawRoute(map, data, layerGroup, coordinatesDB); if(newLg) layerGroup = newLg;
            localStorage.removeItem('pending_route');
        } catch (e) {
            console.error("Error parsing pending route", e);
        }
    }


    // Draw all points from DB as refined markers
    if (!pendingRoute) {
        const newLayers = [];
        const allStops = Object.entries(coordinatesDB);

        // üõ°Ô∏è SECURITY: Prevent Client-Side DoS
        // Rendering 1000+ markers crashes the browser. Only render if count is low (< 100).
        if (allStops.length > 100) {
                console.warn(`[Map] Too many stops (${allStops.length}) to render safely. Showing optimized view.`);
                if (window.showToast) window.showToast("Zoom to explore area", "info");
        } else {
            allStops.forEach(([name, coords]) => {
                const isRoute = name.startsWith('RUTA') || name.startsWith('Ruta');

                // Premium Marker Styling
                const marker = window.L.circleMarker(coords, {
                    radius: isRoute ? 8 : 5,
                    fillColor: isRoute ? '#F97316' : '#3B82F6',
                    color: '#FFFFFF',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).bindPopup(`
                    <div class="p-1">
                        <p class="font-bold text-gray-900">${escapeHtml(name)}</p>
                        <p class="text-xs text-gray-500">${isRoute ? 'üöå Ruta Detectada' : 'üìç Punto de Inter√©s'}</p>
                        <button onclick="window.location.href='/rutas?search=${safeUrl(name)}'" class="mt-2 w-full text-xs bg-primary-600 text-white rounded py-1 font-bold">Ver Detalles</button>
                    </div>
                `);
                newLayers.push(marker);
            });
        }
        
        if (newLayers.length > 0) {
            layerGroup = window.L.layerGroup(newLayers).addTo(map);
            // Optionally fit bounds to all points if database is not empty
            const allCoords = Object.values(coordinatesDB);
            if (allCoords.length > 0) {
                map.fitBounds(allCoords, { padding: [40, 40], maxZoom: 15 });
            }
        }
    }
  }




  // --- Event Listeners ---

  window.addEventListener('SHOW_ROUTE_ON_MAP', (event) => {
      const { journey } = event.detail;
      const newLg = drawRoute(map, journey, layerGroup, coordinatesDB); if(newLg) layerGroup = newLg;
  });

  // Cleanup on page swap (Astro)
  document.addEventListener('astro:before-swap', () => {
      if (map) {
          map.remove();
          map = null;
      }
  });

  // Re-init on page load
  document.addEventListener('astro:page-load', () => {
      initMap();
      setupGPS();
  });

  // Initial load
  if (document.readyState === 'complete') {
      initMap();
      setupGPS();
  } else {
      window.addEventListener('load', () => {
        initMap();
        setupGPS();
      });
  }

  // --- GPS Logic ---
  function setupGPS() {
      const btn = document.getElementById('gps-center-btn');
      if (!btn) return;

      btn.addEventListener('click', () => {
          if (!navigator.geolocation) return;
          btn.classList.add('animate-pulse', 'text-primary-500');

          navigator.geolocation.getCurrentPosition(pos => {
              btn.classList.remove('animate-pulse', 'text-primary-500');
              const { latitude, longitude } = pos.coords;
              if (map) {
                  map.setView([latitude, longitude], 15);
                  window.L.marker([latitude, longitude], {
                      icon: window.L.divIcon({
                          className: 'user-location-marker',
                          html: '<div class="pulse-ring"></div><div class="dot"></div>',
                          iconSize: [24, 24]
                      })
                  }).addTo(map);
              }
          }, () => {
              btn.classList.remove('animate-pulse', 'text-primary-500');
          });
      });
  }

</script>

<style>
  /* GraffitiWarrior: Native Tooltip via Anchor Positioning */
  .graffiti-tooltip {
    position: absolute;
    margin: 0;
    padding: 6px 12px;
    background: #1e293b; /* slate-800 */
    color: white;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s cubic-bezier(0.16, 1, 0.3, 1), translate 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    z-index: 50;

    /* Anchor Positioning */
    right: anchor(left);
    top: anchor(top);
    translate: -12px 6px; /* Offset to center vertically relative to 40px btn */
  }

  /* Reveal logic */
  #gps-center-btn:hover + .graffiti-tooltip,
  #gps-center-btn:focus-visible + .graffiti-tooltip {
    opacity: 1;
    translate: -16px 6px; /* Slide out effect */
  }
</style>

<style is:global>
  .user-location-marker {
      display: flex;
      align-items: center;
      justify-content: center;
  }
  .user-location-marker .dot {
      width: 12px;
      height: 12px;
      background: #3B82F6;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      z-index: 2;
  }
  .user-location-marker .pulse-ring {
      position: absolute;
      width: 30px;
      height: 30px;
      background: rgba(59, 130, 246, 0.4);
      border-radius: 50%;
      z-index: 1;
      animation: map-marker-pulse 2s infinite;
  }
  @keyframes map-marker-pulse {
      0% { transform: scale(0.5); opacity: 1; }
      100% { transform: scale(2.5); opacity: 0; }
  }
</style>
