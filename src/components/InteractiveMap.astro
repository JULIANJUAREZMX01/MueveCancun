---
interface Props {
  center?: [number, number];
  zoom?: number;
}

const {
  center = [21.1619, -86.8515], // Cancun Center
  zoom = 12
} = Astro.props;
---

<div class="relative w-full h-full min-h-[300px] overflow-hidden rounded-xl border border-gray-200 shadow-inner z-0">
  <div id="map-container" class="w-full h-full z-0" data-center={JSON.stringify(center)} data-zoom={zoom}></div>

  <div id="map-loader" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-[1000]">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary-500 border-t-transparent mx-auto mb-4"></div>
      <p class="text-gray-600 font-medium">Cargando mapa...</p>
    </div>
  </div>
</div>

<script>
  import { coordinatesStore } from '../lib/CoordinatesStore';

  // üõ°Ô∏è SECURITY: Prevent DOM-based XSS by using strict DOM creation instead of innerHTML
  function createSafePopup(title, subtitle, actionUrl) {
      const div = document.createElement('div');
      div.className = 'p-3 min-w-[200px]';

      const pTitle = document.createElement('h3');
      pTitle.className = 'font-bold text-slate-900 text-sm mb-0.5 leading-tight';
      pTitle.textContent = title;
      div.appendChild(pTitle);

      if (subtitle) {
          const pSub = document.createElement('p');
          pSub.className = 'text-xs text-slate-500 font-medium mb-2';
          pSub.textContent = subtitle;
          div.appendChild(pSub);
      }

      if (actionUrl) {
          const btn = document.createElement('button');
          btn.className = 'w-full text-xs bg-slate-900 text-white rounded-lg py-1.5 font-bold hover:bg-primary-600 transition-colors shadow-md';
          btn.textContent = 'Ver Rutas Cercanas';
          btn.onclick = () => window.location.href = actionUrl;
          div.appendChild(btn);
      }
      return div;
  }

  function createLabelPopup(label, text) {
      const div = document.createElement('div');
      div.className = "text-center px-1";
      const b = document.createElement('div');
      b.className = "text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-0.5";
      b.textContent = label;
      div.appendChild(b);
      const span = document.createElement('div');
      span.className = "font-bold text-slate-800 text-sm leading-tight";
      span.textContent = text;
      div.appendChild(span);
      return div;
  }

  function createSimplePopup(text) {
      const div = document.createElement('div');
      div.className = "font-medium text-slate-700 text-xs";
      div.textContent = text;
      return div;
  }

  // --- CUSTOM ICONS ---
  const createIcon = (type) => {
      const isStart = type === 'start';
      const isEnd = type === 'end';
      const isTransfer = type === 'transfer';
      const isLocation = type === 'location';

      let html = '';
      
      if (isStart) {
          html = `
            <div class="relative w-10 h-10 -ml-5 -mt-10 flex flex-col items-center justify-end group cursor-pointer z-50">
                <div class="w-8 h-8 rounded-full bg-emerald-500 border-[3px] border-white shadow-xl flex items-center justify-center text-white relative z-10 font-bold transform transition-transform group-hover:scale-110">
                    <span class="text-xs font-mono">A</span>
                </div>
                <div class="w-1 h-3 bg-emerald-600 rounded-b-sm"></div>
                <div class="absolute bottom-0 w-8 h-2 bg-black/20 blur-sm rounded-full translate-y-1"></div>
            </div>`;
      } else if (isEnd) {
          html = `
             <div class="relative w-10 h-10 -ml-5 -mt-10 flex flex-col items-center justify-end group cursor-pointer z-50">
                <div class="w-8 h-8 rounded-full bg-rose-500 border-[3px] border-white shadow-xl flex items-center justify-center text-white relative z-10 font-bold transform transition-transform group-hover:scale-110">
                    <span class="text-xs font-mono">B</span>
                </div>
                <div class="w-1 h-3 bg-rose-600 rounded-b-sm"></div>
                <div class="absolute bottom-0 w-8 h-2 bg-black/20 blur-sm rounded-full translate-y-1"></div>
            </div>`;
      } else if (isTransfer) {
           html = `
            <div class="relative w-8 h-8 -ml-4 -mt-4 flex items-center justify-center group cursor-pointer">
                <div class="w-6 h-6 rounded-full bg-amber-400 border-2 border-white shadow-lg flex items-center justify-center text-slate-900 z-10 animate-pulse">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </div>
            </div>`;
      } else if (isLocation) {
          html = `
             <div class="w-3 h-3 bg-primary-500 rounded-full border border-white shadow-sm hover:scale-150 transition-transform cursor-pointer"></div>
          `;
      }

      return window.L.divIcon({
          className: '!bg-transparent !border-0', 
          html: html,
          iconSize: [40, 40],
          iconAnchor: [20, 40],
          popupAnchor: [0, -40]
      });
  };

  class CoordinateFinder {
      constructor(db) {
          this.db = db;
          this.cache = new Map();
          this.tokenIndex = new Map();
          this.keys = Object.keys(db);
          this.buildIndex();
      }

      buildIndex() {
          for (const key of this.keys) {
              const tokens = key.toLowerCase().split(/[^a-z0-9\u00C0-\u017F]+/);
              for (const token of tokens) {
                  if (token.length < 3) continue;
                  if (!this.tokenIndex.has(token)) {
                      this.tokenIndex.set(token, []);
                  }
                  this.tokenIndex.get(token).push(key);
              }
          }
      }

      find(stopName) {
          if (this.db[stopName]) return this.db[stopName];
          if (this.cache.has(stopName)) return this.cache.get(stopName);

          const searchTokens = stopName.toLowerCase().split(/[^a-z0-9\u00C0-\u017F]+/);
          const candidates = new Set();

          for (const token of searchTokens) {
              if (token.length < 3) continue;
              const matches = this.tokenIndex.get(token);
              if (matches) {
                  for (const m of matches) candidates.add(m);
              }
          }

          let bestKey = null;
          if (candidates.size > 0) {
               bestKey = Array.from(candidates).find(k => stopName.includes(k) || k.includes(stopName));
          }

          const result = bestKey ? this.db[bestKey] : null;
          this.cache.set(stopName, result);
          return result;
      }
  }

  let map;
  let layerGroup;
  let coordinatesDB = {};
  let finder;

  async function initMap() {
    const container = document.getElementById('map-container');
    const loader = document.getElementById('map-loader');

    if (!container || window.L === undefined) {
        console.warn("Leaflet not loaded or container missing");
        return;
    }

    if (container._leaflet_id) return;

    const center = JSON.parse(container.dataset.center);
    const zoom = parseFloat(container.dataset.zoom);

    // Bounds for Cancun
    const maxBounds = [
        [20.8, -87.3],
        [21.6, -86.5]
    ];

    map = window.L.map('map-container', {
        preferCanvas: true,
        maxBounds: maxBounds,
        maxBoundsViscosity: 0.8,
        minZoom: 11,
        zoomControl: false // Custom position if needed, or default
    }).setView(center, zoom);
    
    // Add zoom control to bottom right for better UX on mobile
    window.L.control.zoom({ position: 'bottomright' }).addTo(map);

    window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        minZoom: 11,
        maxZoom: 18,
        opacity: 0.8 // Slightly faded for better overlay visibility
    }).addTo(map);

    layerGroup = window.L.layerGroup().addTo(map);

    // Initialize Store
    try {
        await coordinatesStore.init();
        coordinatesDB = coordinatesStore.getDB() || {};
        finder = new CoordinateFinder(coordinatesDB);
    } catch (e) {
        console.error("Failed to load coordinates:", e);
    }

    if (loader) loader.classList.add('hidden');

    // Picker Mode Logic
    const urlParams = new URLSearchParams(window.location.search);
    const isPicker = urlParams.get('picker');

    if (isPicker) {
        if (window.showToast) window.showToast("Toque el mapa para seleccionar punto", "info");
        
        const badge = document.createElement('div');
        badge.className = 'absolute top-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-full shadow-lg z-[1000] font-bold text-xs flex items-center gap-2 animate-bounce-in';
        badge.innerHTML = '<span>üìç</span> MODO SELECCI√ìN';
        container.parentElement.appendChild(badge);

        map.on('click', (e) => {
            const nearest = coordinatesStore.findNearest(e.latlng.lat, e.latlng.lng);
            let minDist = 10000;
            
            if (nearest && coordinatesDB[nearest]) {
                 minDist = map.distance(e.latlng, coordinatesDB[nearest]);
            }

            if (nearest && minDist < 1500) { // 1.5km tolerance
                window.L.popup({
                    className: 'picker-popup'
                })
                .setLatLng(coordinatesDB[nearest]) // Snap to stop
                .setContent(createSafePopup(
                    "¬øConfirmar ubicaci√≥n?",
                    nearest,
                    null
                ).outerHTML + `
                    <button class="w-full mt-2 bg-primary-500 text-white rounded-lg py-2 font-bold text-xs shadow-md"
                        onclick="window.location.href='/?selected_stop=${encodeURIComponent(nearest)}'">
                        ‚úÖ USAR ESTA PARADA
                    </button>
                `)
                .openOn(map);
            } else {
                 if (window.showToast) window.showToast("No hay paradas oficiales cerca de este punto", "warning");
            }
        });
        return;
    }

    // Pending Route Logic
    const pendingRoute = localStorage.getItem('pending_route');
    if (pendingRoute) {
        try {
            const data = JSON.parse(pendingRoute);
            drawRoute(Array.isArray(data) ? { stops: data } : data);
            localStorage.removeItem('pending_route');
        } catch (e) {
            console.error("Error parsing pending route", e);
        }
    }

    // Draw All Points (Ambient Mode)
    if (!pendingRoute) {
        const points = [];
        Object.entries(coordinatesDB).forEach(([name, coords]) => {
            // Filter only main hubs/routes to avoid clutter? No, show all as small dots.
            // Using CircleMarker is faster for 100+ points than DivIcon
            const isHub = name.includes("Plaza") || name.includes("ADO") || name.includes("Crucero");
            
            const marker = window.L.circleMarker(coords, {
                radius: isHub ? 6 : 4,
                fillColor: isHub ? '#3B82F6' : '#94A3B8',
                color: '#FFFFFF',
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.9
            }).bindPopup(createSafePopup(name, isHub ? 'Punto de Inter√©s' : 'Parada', '/rutas?search=' + encodeURIComponent(name)));
            
            points.push(marker);
        });
        
        if (points.length > 0) {
            const group = window.L.featureGroup(points).addTo(map);
            // Don't fit bounds unless specific need, just set view to center
            // map.fitBounds(group.getBounds(), { padding: [50, 50] });
        }
    }
  }

  function drawRoute(data) {
    if (!map) return;

    if (layerGroup) {
        layerGroup.clearLayers();
        layerGroup.remove();
    }
    
    layerGroup = window.L.layerGroup().addTo(map);

    // Normalizing legs logic
    let legs = [];
    if (data.legs && Array.isArray(data.legs)) legs = data.legs;
    else if (data.stops && Array.isArray(data.stops)) legs = [{ stops: data.stops }];
    else return;

    const newLayers = [];
    const allBounds = [];

    legs.forEach((leg, index) => {
        try {
            const routeCoords = [];
            const validStops = [];

            // Determine source of coords
            const stopSource = leg.stops_info && leg.stops_info.length > 0 
                ? leg.stops_info.map(s => ({ name: s.name, latlng: [s.lat, s.lng] }))
                : (leg.stops || []).map(name => {
                    const c = finder ? finder.find(name) : coordinatesDB[name];
                    return c ? { name, latlng: c } : null;
                }).filter(Boolean);

            stopSource.forEach(s => {
                routeCoords.push(s.latlng);
                validStops.push(s);
                allBounds.push(s.latlng);
            });

            if (routeCoords.length > 0) {
                // 1. Background (Solid Dark)
                newLayers.push(window.L.polyline(routeCoords, {
                    color: '#0f172a', 
                    weight: 10,
                    opacity: 0.6,
                    lineCap: 'round',
                    lineJoin: 'round'
                }));

                // 2. Foreground (Animated Dash)
                const isFirst = index === 0;
                newLayers.push(window.L.polyline(routeCoords, {
                    color: isFirst ? '#10B981' : '#3B82F6', // Emerald vs Blue
                    weight: 5,
                    opacity: 1,
                    dashArray: '15, 20',
                    lineCap: 'round',
                    lineJoin: 'round',
                    className: 'animate-dash drop-shadow-lg'
                }));

                // Start Maker (Leg 1)
                if (index === 0) {
                    const s = validStops[0];
                    console.log("Adding Start Marker:", s.name);
                    newLayers.push(window.L.marker(s.latlng, { icon: createIcon('start') })
                        .bindPopup(createLabelPopup('Inicio', s.name)));
                }

                // End Marker (Last Leg)
                if (index === legs.length - 1) {
                    const e = validStops[validStops.length - 1];
                    console.log("Adding End Marker:", e.name);
                    newLayers.push(window.L.marker(e.latlng, { icon: createIcon('end') })
                        .bindPopup(createLabelPopup('Fin', e.name)));
                }

                // Transfer Marker
                if (index < legs.length - 1) {
                    const e = validStops[validStops.length - 1];
                    newLayers.push(window.L.marker(e.latlng, { icon: createIcon('transfer') })
                        .bindPopup(createLabelPopup('Transbordo', e.name)));
                }

                // Intermediate Stops (Dots)
                validStops.slice(1, -1).forEach(stop => {
                    newLayers.push(
                        window.L.circleMarker(stop.latlng, {
                            radius: 3,
                            fillColor: '#FFFFFF',
                            color: isFirst ? '#10B981' : '#3B82F6',
                            weight: 2,
                            fillOpacity: 1
                        }).bindPopup(createSimplePopup(stop.name))
                    );
                });
            }
        } catch (e) {
            console.error("Error drawing leg:", index, e);
        }
    });

    if (newLayers.length > 0) {
        layerGroup = window.L.featureGroup(newLayers).addTo(map);
        if (allBounds.length > 0) {
             map.fitBounds(allBounds, { padding: [80, 80], maxZoom: 15, animate: true });
        }
    } else {
         if (window.showToast) window.showToast("No se encontraron coordenadas para esta ruta.", "warning");
         layerGroup = window.L.layerGroup().addTo(map);
    }
  }

  window.addEventListener('SHOW_ROUTE_ON_MAP', (event) => {
    drawRoute(event.detail);
     // Scroll to map
    const mapEl = document.getElementById('map-container');
    if(mapEl) mapEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  });

  if (document.readyState === 'complete') initMap();
  else window.addEventListener('load', initMap);

  document.addEventListener('astro:page-load', () => setTimeout(initMap, 100));

</script>

<style is:global>
  @keyframes dash {
    from {
      stroke-dashoffset: 0;
    }
    to {
      stroke-dashoffset: -35;
    }
  }
  
  .animate-dash {
    animation: dash 1s linear infinite;
  }
</style>
