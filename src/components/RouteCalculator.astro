---
import { ui } from '../lib/i18n';
import Input from './ui/Input.astro';
import Switch from './ui/Switch.astro';
import PassengerSelector from './ui/PassengerSelector.astro';
---

<div class="space-y-6" id="route-calculator-wrapper">

  <div class="glass-card relative overflow-hidden !p-0 transition-all duration-500" id="search-card">

    <!-- Collapsible Header -->
    <div id="card-header" class="p-4 relative flex items-center justify-center min-h-[56px] transition-all duration-300" style="border-bottom: 1px solid var(--border-light);">

      <!-- <h2 class="font-display font-black text-lg tracking-tight text-center w-full text-slate-900 dark:text-white"
          id="title-text" data-i18n="calc.title">
        Where are we going?
      </h2> -->

      <div class="absolute right-4 flex items-center gap-2">
        <div id="balance-badge-container" class="hidden sm:block">
           <span class="price-tag text-xxs" id="balance-badge">Cargando...</span>
        </div>
        <button id="lang-toggle" class="text-xxs font-bold px-2 py-1 rounded-lg uppercase transition-colors" style="background: var(--surface-bg); border: 1px solid var(--border-light); color: var(--text-secondary);">EN</button>
      </div>
    </div>

    <!-- Summary Bar (Initially Hidden) -->
    <div id="search-summary" class="hidden p-3 flex items-center justify-between animate-fade-in z-20 relative" style="background: var(--surface-card); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border-light);">
        <div class="flex items-center gap-3 text-sm overflow-hidden">
            <div class="flex flex-col min-w-0">
               <div class="flex items-center gap-1.5 font-bold truncate text-slate-800 dark:text-white">
                  <span class="w-2 h-2 rounded-full bg-success-500 shrink-0"></span>
                  <span id="summary-origin" class="truncate text-xs" data-i18n="calc.origin">Origin</span>
               </div>
               <div class="h-3 border-l ml-1 my-0.5" style="border-color: var(--border-light);"></div>
               <div class="flex items-center gap-1.5 font-bold truncate text-slate-800 dark:text-white">
                  <span class="w-2 h-2 rounded-full bg-danger-500 shrink-0"></span>
                  <span id="summary-dest" class="truncate text-xs" data-i18n="calc.dest">Destination</span>
               </div>
            </div>
        </div>
        <button id="reset-search-btn" class="btn-sm ml-2 shrink-0 text-xxs font-black uppercase tracking-wider text-primary-600 bg-primary-50 dark:bg-primary-900/20 dark:text-primary-400 px-3 py-1.5 rounded-xl transition-colors hover:bg-primary-100" data-i18n="calc.reset">
            EDIT
        </button>
    </div>

    <!-- Main Search Form -->
    <div id="search-form-container" class="p-5 space-y-5 transition-all duration-500">
      <!-- Alerts -->
      <div id="balance-warning" class="hidden">
        <div class="bg-danger-50 dark:bg-danger-500/10 border-l-4 border-danger-500 p-3 rounded-r-xl flex items-start gap-3">
          <span class="material-symbols-rounded text-danger-500 text-lg mt-0.5" style="font-variation-settings: 'FILL' 1;">warning</span>
          <div>
            <p class="text-xxs font-black text-danger-600 dark:text-danger-400 uppercase tracking-wider" data-i18n="calc.balance.warning">Insufficient Balance</p>
            <p class="text-xs font-medium mt-1" style="color: var(--text-secondary);" id="warning-text" data-i18n="calc.balance.msg">Requires $180 MXN to operate.</p>
          </div>
        </div>
      </div>

      <!-- Inputs -->
      <div class="space-y-4 relative">
        <div class="relative z-10">
          <Input
            id="origin-input"
            label="Origin"
            icon="/icons/map-pin.svg"
            placeholder="Where are you?"
            list="locations"
            aria-controls="locations"
            aria-expanded="false"
            data-i18n-label="calc.origin"
            data-i18n-placeholder="calc.placeholder.origin"
          >
            <button slot="action" id="gps-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-primary-500 transition-colors" style="anchor-name: --gps-btn" aria-describedby="gps-tooltip">
              <img src="/icons/gps.svg" class="w-5 h-5" alt="GPS" />
            </button>
            <div slot="action" id="gps-tooltip" class="graffiti-tooltip bottom" style="position-anchor: --gps-btn" data-i18n="calc.gps">Use my location</div>
          </Input>
        </div>

        <!-- Swap Button -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 mt-2">
          <button id="swap-btn" class="w-10 h-10 bg-slate-50 border-2 border-slate-200 rounded-full flex items-center justify-center shadow-sm active:scale-95 transition-transform hover:bg-white text-slate-500">
            <img src="/icons/swap.svg" class="w-5 h-5 opacity-60" alt="Swap" />
          </button>
        </div>

        <div class="relative z-0">
          <Input
            id="destination-input"
            label="Destination"
            icon="/icons/flag.svg"
            placeholder="Where to?"
            list="locations"
            aria-controls="locations"
            aria-expanded="false"
            data-i18n-label="calc.dest"
            data-i18n-placeholder="calc.placeholder.dest"
          />
            <button slot="action" id="map-picker-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-primary-500 transition-colors" style="anchor-name: --map-btn" aria-describedby="map-tooltip">
              <img src="/icons/map-plus.svg" class="w-5 h-5" alt="Map Picker" />
            </button>
            <div slot="action" id="map-tooltip" class="graffiti-tooltip top" style="position-anchor: --map-btn" data-i18n="calc.map">Select on map</div>
          </Input>
        </div>
      </div>

      <!-- Quick Actions -->
      <div>
        <div class="section-label mb-2" data-i18n="calc.quick">Quick Actions</div>
        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar snap-x">
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Walmart" data-i18n-html="calc.home">
            <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">home</span> Home
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Plaza Las Am√©ricas" data-i18n-html="calc.work">
            <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">work</span> Work
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Aeropuerto Terminal 2" data-i18n-html="calc.airport">
            <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">flight</span> Airport
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Playa Delfines (El Mirador)" data-i18n-html="calc.beach">
            <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">beach_access</span> Beach
          </button>
        </div>
      </div>

      <!-- Options -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <div class="section-label mb-1.5" style="font-size: 0.6rem;" data-i18n="calc.passengers">Passengers</div>
          <PassengerSelector id="seats-input" />
        </div>
        <div>
          <div class="section-label mb-1.5" style="font-size: 0.6rem;" data-i18n="calc.mode">Mode</div>
          <div class="h-[44px] flex items-center">
            <Switch id="tourist-checkbox" label="Tourist" data-i18n-label="calc.tourist" />
          </div>
        </div>
      </div>

      <button id="search-btn" class="btn-primary btn-lg w-full">
        <span id="btn-text" class="uppercase tracking-wider" data-i18n="calc.btn">CALCULATE ROUTE</span>
        <span class="material-symbols-rounded text-lg animate-spin hidden" id="btn-spinner">progress_activity</span>
      </button>

    </div>

    <!-- Loading State -->
    <div id="calculation-loader" class="hidden p-5 space-y-3" style="border-top: 1px solid var(--border-light); background: var(--surface-bg);">
        <div class="skeleton h-24 rounded-xl"></div>
        <div class="skeleton h-12 rounded-xl"></div>
        <div class="skeleton h-12 rounded-xl"></div>
    </div>

  </div>

    <!-- Results Area -->
    <div id="results-info" class="mb-4 hidden animate-fade-in group">
        <div class="glass-card flex items-center justify-between px-4 py-3">
            <div class="flex flex-col">
                <span class="text-xxs font-black uppercase tracking-widest mb-0.5" style="color: var(--text-tertiary);" id="results-count-label">0 OPCIONES</span>
                <span class="badge-success font-mono" id="results-time-badge">M√ÅS R√ÅPIDA: 12min</span>
            </div>
            
            <button id="toggle-list-btn" class="chip">
                <span class="text-xs font-bold" id="toggle-list-text" data-i18n="calc.toggle.hide">Hide</span>
                <span class="material-symbols-rounded text-sm" id="toggle-list-icon">expand_more</span>
            </button>
        </div>
    </div>
    <div id="best-result-area" class="mb-6 space-y-4 empty:hidden">
        <!-- Best match card injected here -->
    </div>

    <div id="results-container" class="space-y-4 empty:hidden transition-all duration-500 origin-top">
        <!-- Other results injected here -->
    </div>

  <datalist id="locations">
    <option value="El Crucero Hub"></option>
    <option value="ADO Centro / Terminal"></option>
    <option value="Plaza Las Am√©ricas"></option>
    <option value="Aeropuerto Terminal 2"></option>
    <option value="Aeropuerto Terminal 4"></option>
    <option value="Muelle Ultramar (Puerto Ju√°rez)"></option>
    <option value="Playa Delfines (El Mirador)"></option>
    <option value="Playa del Carmen Centro"></option>
    <option value="Walmart"></option>
    <option value="Villas Otoch Para√≠so"></option>
    <option value="Hospital General (Av. Kabah)"></option>
  </datalist>

</div>

<div id="i18n-data" data-ui={JSON.stringify(ui)} class="hidden"></div>
<script>
  import { openDB } from 'idb';
  import { coordinatesStore } from '../lib/CoordinatesStore';
  import { CoordinateFinder } from '../lib/CoordinateFinder';
  import { analytics } from '../lib/Analytics';

  const dataUi = document.getElementById('i18n-data');
  const ui = dataUi ? JSON.parse(dataUi.dataset.ui || '{}') : {};
  window.APP_TRANSLATIONS = ui;
  let currentLang = localStorage.getItem('lang') || 'en';

  function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return unsafe;
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
  }

  function updateLanguage(lang) {
      document.documentElement.lang = lang;
      localStorage.setItem('lang', lang);
      currentLang = lang;
      window.currentLang = lang;
      
      const t = ui[lang];
      if (!t) return;
      
      // Update static text
      document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.dataset.i18n;
          if (t[key]) el.textContent = t[key];
      });
      
      // Update Inputs
      document.querySelectorAll('[data-i18n-label]').forEach(input => {
         const wrapper = input.closest('.input-field') || input.parentElement;
         const label = wrapper?.querySelector('label');
         if (label && t[input.dataset.i18nLabel]) label.textContent = t[input.dataset.i18nLabel];
      });
       document.querySelectorAll('[data-i18n-placeholder]').forEach(input => {
         if (t[input.dataset.i18nPlaceholder]) input.placeholder = t[input.dataset.i18nPlaceholder];
      });

      // Update HTML (chips)
       document.querySelectorAll('[data-i18n-html]').forEach(el => {
          const key = el.dataset.i18nHtml;
          if (t[key]) {
              const icon = el.querySelector('.material-symbols-rounded')?.outerHTML || '';
              el.innerHTML = icon + ' ' + t[key];
          }
      });
      
      // Dispatch event
      window.dispatchEvent(new CustomEvent('LANGUAGE_CHANGE', { detail: { lang, t } }));
      
      // Update dynamic elements if existing
      const btnText = document.getElementById('btn-text');
      if (btnText && t['calc.btn']) btnText.textContent = t['calc.btn'];

      // Rerender results if present? 
      // Ideally we would re-render, but for now we rely on next search or static updates.
      // Or we can manually update visible results text if we added data-i18n to them?
      // Since results are dynamic HTML strings, easiest is to clear them or let user re-search.
      // But we can update the "No routes" message if visible.
  }
  let balance = 0;
  let hasBalance = false;
  let wasmLoaded = false;
  let find_route, validate_operator_funds, load_stops_data;
  let finder; // Global Coordinate Finder instance

  const btn = document.getElementById('search-btn');
  const resultsContainer = document.getElementById('results-container');
  const langToggle = document.getElementById('lang-toggle');
  const balanceBadge = document.getElementById('balance-badge');
  const balanceWarning = document.getElementById('balance-warning');
  const btnSpinner = document.getElementById('btn-spinner');
  const btnText = document.getElementById('btn-text');
  const calculationLoader = document.getElementById('calculation-loader');
  const summaryView = document.getElementById('search-summary');
  const searchForm = document.getElementById('search-form-container');
  const cardHeader = document.getElementById('card-header');

  // Event Delegation for Results
  if (resultsContainer) {
    resultsContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('.view-map-btn');
      if (!btn) return;

      e.stopPropagation();
      const journeyData = btn.dataset.journey;
      if (journeyData) {
         try {
             const journey = JSON.parse(journeyData);
             window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', { detail: journey }));
         } catch (err) {
             console.error("Invalid journey data", err);
         }
      }
    });
  }

  // Quick Actions
  document.querySelectorAll('.quick-action-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const dest = (e.currentTarget).dataset.dest;
        const destInput = document.getElementById('destination-input');
        if (destInput) destInput.value = dest;
    });
  });

  async function updateBalance() {
    try {
        const stored = localStorage.getItem('user_balance');
        if (stored !== null) {
            balance = parseFloat(stored);
        } else {
            balance = 180.0;
            localStorage.setItem('user_balance', balance.toString());
        }
    } catch (e) {
        console.warn("Storage Error, using default balance:", e);
        balance = 180.0;
    }

    if (wasmLoaded && typeof validate_operator_funds === 'function') {
        try {
            hasBalance = validate_operator_funds(balance);
        } catch (e) {
            console.warn("WASM validation failed, fallback to strict check", e);
            hasBalance = balance >= 180.0;
        }
    } else {
        hasBalance = balance >= 180.0;
    }

    if (balanceBadge) {
        balanceBadge.textContent = `$${balance.toFixed(0)}`;
        if (hasBalance) {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-green-100 text-green-700 font-mono";
        } else {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-red-100 text-red-700 font-mono";
        }
    }

    if (balanceWarning) {
      balanceWarning.classList.toggle('hidden', hasBalance);
    }

    if (btn) (btn as HTMLButtonElement).disabled = !hasBalance;
  }

  function updateUI() {
    // Rely on updateLanguage for text
    // Just update visual states
    if (langToggle) langToggle.textContent = currentLang === 'es' ? 'ES' : 'EN';
  }

  async function start() {
    try {
      console.log("Initializing WASM...");
      const wasmPath = new URL('/wasm/route-calculator/route_calculator.js', window.location.href).href;
      const module = await import(/* @vite-ignore */ wasmPath);
      await module.default();
      find_route = module.find_route;
      validate_operator_funds = module.validate_operator_funds;
      load_stops_data = module.load_stops_data; // Capture load_stops_data

      console.log("WASM initialized.");
      wasmLoaded = true;
    } catch (e) {
      console.error("WASM Load Critical Error:", e);
      renderWasmError();
    } finally {
      await updateBalance();
      updateUI();
      // Initialize shared coordinates store and Finder
      try {
        await coordinatesStore.init();
        const db = coordinatesStore.getDB();
        
        // SYNC WITH WASM
        if (wasmLoaded && typeof load_stops_data === 'function') {
             load_stops_data(db);
             console.log("‚úÖ Coordinates synced to WASM");
        }

        finder = new CoordinateFinder(db);
        console.log("Coordinate Finder Ready");
        
        // Setup Autocomplete
        setupAutocomplete('origin-input');
        setupAutocomplete('destination-input');

      } catch (e) {
        console.warn("GPS/Finder features might be unavailable", e);
      }
      initGPSLogic();
    }
  }

  function setupAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      const container = input?.parentElement; // Input wrapper
      if (!input || !container) return;

      // Create Dropdown Element
      const list = document.createElement('ul');
      list.className = 'absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-xl shadow-xl z-50 mt-1 max-h-60 overflow-y-auto hidden divide-y divide-slate-50';
      list.id = `${inputId}-suggestions`;
      container.appendChild(list);

      // Input Handler
      input.addEventListener('input', (e) => {
          const val = (e.target as HTMLInputElement).value;
          if (!finder || val.length < 2) {
              list.classList.add('hidden');
              return;
          }

          const results = finder.search(val, 6); // Limit to 6 suggestions
          
          if (results.length > 0) {
              list.innerHTML = '';
              results.forEach(res => {
                  const li = document.createElement('li');
                  li.className = 'px-4 py-3 hover:bg-slate-50 cursor-pointer transition-colors flex items-center gap-3 group';
                  li.innerHTML = `
                      <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-primary-50 group-hover:text-primary-500 transition-colors">
                          <span class="material-icons-round text-base">location_on</span>
                      </div>
                      <div class="flex-1">
                          <p class="text-sm font-bold text-slate-700 group-hover:text-primary-700">${escapeHtml(res.name)}</p>
                          <p class="text-[10px] text-slate-500 font-mono">COORD: ${res.coords[0].toFixed(4)}, ${res.coords[1].toFixed(4)}</p>
                      </div>
                  `;
                  li.addEventListener('click', () => {
                      (input as HTMLInputElement).value = res.name;
                      list.classList.add('hidden');
                      // Trigger any blur/update logic
                      input.dispatchEvent(new Event('blur'));
                  });
                  list.appendChild(li);
              });
              list.classList.remove('hidden');
          } else {
              list.classList.add('hidden');
          }
      });

      // Hide on blur (delayed to allow click)
      input.addEventListener('blur', () => {
          setTimeout(() => list.classList.add('hidden'), 200);
      });
      
      // Show on focus if value exists
      input.addEventListener('focus', (e) => {
           if ((e.target as HTMLInputElement).value.length >= 2) {
               input.dispatchEvent(new Event('input'));
           }
      });
  }

  function initGPSLogic() {
      const gpsBtn = document.getElementById('gps-btn');
      const mapPickerBtn = document.getElementById('map-picker-btn');
      const originInput = document.getElementById('origin-input');
      const destInput = document.getElementById('destination-input');

      originInput?.addEventListener('blur', (e) => {
          if ((e.target as HTMLInputElement).value.length > 0) {
              window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 1 } }));
          }
      });

      destInput?.addEventListener('blur', (e) => {
          if ((e.target as HTMLInputElement).value.length > 0) {
              window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 2 } }));
          }
      });

      gpsBtn?.addEventListener('click', () => {
          if (!navigator.geolocation) {
              if (window.showToast) window.showToast("Geolocalizaci√≥n no soportada", "error");
              return;
          }

          const originInput = document.getElementById('origin-input') as HTMLInputElement;
          const parent = originInput.parentElement;
          parent.classList.add('opacity-50', 'pointer-events-none');

          navigator.geolocation.getCurrentPosition((pos) => {
              const { latitude, longitude } = pos.coords;
              
              const nearest = coordinatesStore.findNearest(latitude, longitude);

              if (nearest) {
                  originInput.value = nearest;
                  if (window.showToast) window.showToast(`Ubicaci√≥n: ${nearest}`, "success");
              } else {
                  if (window.showToast) window.showToast("No se encontraron paradas cercanas", "warning");
              }
              
              window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 1 } }));
              parent.classList.remove('opacity-50', 'pointer-events-none');
              
              // Emit user location to map
              window.dispatchEvent(new CustomEvent('USER_LOCATION_UPDATE', { 
                  detail: { lat: latitude, lng: longitude, focus: true } 
              }));
          }, (err) => {
              console.error(err);
              parent.classList.remove('opacity-50', 'pointer-events-none');
              if (window.showToast) window.showToast("Error al obtener ubicaci√≥n", "error");
          });
      });

      mapPickerBtn?.addEventListener('click', () => {
          const originInput = document.getElementById('origin-input');
          const destInput = document.getElementById('destination-input');

          sessionStorage.setItem('temp_origin', (originInput as HTMLInputElement).value);
          // We don't save dest as we are about to pick it

          window.location.href = '/mapa?picker=destination';
      });

      // Check return
      const urlParams = new URLSearchParams(window.location.search);
      const pickedStop = urlParams.get('selected_stop');

      if (pickedStop) {
          const originInput = document.getElementById('origin-input');
          const destInput = document.getElementById('destination-input');
          const savedOrigin = sessionStorage.getItem('temp_origin');

          if (savedOrigin) (originInput as HTMLInputElement).value = savedOrigin;
          if (destInput) (destInput as HTMLInputElement).value = pickedStop;

          window.history.replaceState({}, document.title, window.location.pathname);
          sessionStorage.removeItem('temp_origin');

          // Trigger Phase 2 immediately
          setTimeout(() => {
              window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 2 } }));
          }, 500);
      }
  }

  document.addEventListener('astro:page-load', start);

  // Init Language
  const saved = localStorage.getItem('lang') || 'en';
  updateLanguage(saved);

  langToggle?.addEventListener('click', () => {
    const newLang = currentLang === 'en' ? 'es' : 'en';
    updateLanguage(newLang);
    updateUI();
  });

  const swapBtn = document.getElementById('swap-btn');
  swapBtn?.addEventListener('click', () => {
     const origin = document.getElementById('origin-input');
     const dest = document.getElementById('destination-input');
     const temp = origin.value;
     origin.value = dest.value;
     dest.value = temp;
  });

  // COLLAPSE LOGIC
  function collapseUI(origin, dest) {
      if (searchForm) searchForm.classList.add('hidden');
      if (cardHeader) cardHeader.classList.add('hidden');
      if (summaryView) {
          summaryView.classList.remove('hidden');
          document.getElementById('summary-origin').textContent = origin || 'Origen';
          document.getElementById('summary-dest').textContent = dest || 'Destino';
      }
  }

  function expandUI() {
      if (searchForm) searchForm.classList.remove('hidden');
      if (cardHeader) cardHeader.classList.remove('hidden');
      if (summaryView) summaryView.classList.add('hidden');

      // Also notify View Manager to revert?
      // Currently the spec doesn't say we need to revert fully, but logic suggests so.
      window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'SEARCH_ACTIVE' }));
  }

  document.getElementById('reset-search-btn')?.addEventListener('click', expandUI);

  btn?.addEventListener('click', async () => {
    if (!wasmLoaded) {
         renderError("El sistema no est√° listo (WASM offline).");
         return;
    }
    if (!hasBalance) return;

    const fromVal = (document.getElementById('origin-input') as HTMLInputElement).value;
    const toVal = (document.getElementById('destination-input') as HTMLInputElement).value;

    analytics.track('search_route', { from: fromVal, to: toVal });

    if (toVal.toLowerCase().includes("aeropuerto") && fromVal.toLowerCase().includes("walmart")) {
         renderError("Ruta restringida hacia el Aeropuerto desde Walmart (Solo Taxis/ADO).");
         return;
    }

    // Change Button Text
    if (btnText) btnText.textContent = ui[currentLang]['calc.howToGet'];

    // Show spinner
    if (btnSpinner) btnSpinner.classList.remove('hidden');
    if (calculationLoader) calculationLoader.classList.remove('hidden');
    if (resultsContainer) resultsContainer.innerHTML = '';
    (btn as HTMLButtonElement).disabled = true;

    // Artificial delay for "Thinking"
    await new Promise(r => setTimeout(r, 800));

    try {
      if (!finder) throw new Error("Sistema de b√∫squeda no inicializado.");

      let fromSearch = fromVal;
      const originMatch = finder.findBestMatch(fromSearch);
      const destMatch = finder.findBestMatch(toVal);

      if (!originMatch) throw new Error(`Origen no encontrado: "${fromSearch}"`);
      if (!destMatch) throw new Error(`Destino no encontrado: "${toVal}"`);

      console.log('üìç Points found (Fuzzy):', { originMatch, destMatch });

      // 2. Call WASM
      const res = find_route(originMatch.name, destMatch.name);
      console.log('Route Result:', res);

      // Success!
      // 1. Emit State Change
      window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'MAP_ACTIVE' }));

      // 2. Collapse UI and Update Summary with Matched Names
      collapseUI(originMatch.name, destMatch.name);

      // 3. Render Results
      renderResults(res);

    } catch (error) {
      console.error(error);
      renderError("System Error: " + (error.message || error));
      // Revert button text on error
       if (btnText) btnText.textContent = ui[currentLang]['calc.btn'];
    } finally {
      if (btnSpinner) btnSpinner.classList.add('hidden');
      if (calculationLoader) calculationLoader.classList.add('hidden');
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  function getTransportLabel(type) {
    return ui[currentLang][`transport.${type}`] || type;
  }

  function renderResults(journeys) {
    if (!resultsContainer) return;
    const bestResultArea = document.getElementById('best-result-area');
    if (bestResultArea) bestResultArea.innerHTML = '';
    resultsContainer.innerHTML = '';

    if (!journeys || journeys.length === 0) {
        document.getElementById('results-info')?.classList.add('hidden');
        resultsContainer.innerHTML = `
          <div class="glass-card text-center animate-slide-up">
            <span class="material-symbols-rounded text-4xl mb-3 block" style="color: var(--text-tertiary);">search_off</span>
            <h3 class="font-display font-black text-base mb-2" style="color: var(--text-primary);">${ui[currentLang]['calc.no_route']}</h3>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">${ui[currentLang]['calc.no_route_msg']}</p>
            <a href="/rutas" class="btn-secondary btn-sm inline-flex items-center gap-2">
               <span class="material-symbols-rounded text-sm">list_alt</span> ${ui[currentLang]['calc.view_all']}
            </a>
          </div>
        `;
        expandUI();
        if (window.showToast) window.showToast(ui[currentLang]['calc.no_route'], "info");
        return;
    }

    // Update Counter
    const infoPanel = document.getElementById('results-info');
    const countLabel = document.getElementById('results-count-label');
    if (infoPanel && countLabel) {
        infoPanel.classList.remove('hidden');
        const countText = journeys.length === 1 ? ui[currentLang]['calc.num_options'] : ui[currentLang]['calc.num_options_plural'];
        countLabel.textContent = `${journeys.length} ${countText}`;
    }

    journeys.forEach((journey, index) => {
        const isBest = index === 0;
        const target = isBest && bestResultArea ? bestResultArea : resultsContainer;
        
        const html = journey.type === 'Direct' 
            ? renderDirectCardHtml(journey, isBest)
            : renderTransferCardHtml(journey, isBest);
            
        target.innerHTML += html;
    });

    // Attach map listeners
    document.querySelectorAll('.view-map-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const data = JSON.parse((btn as HTMLElement).dataset.journey || '{}');
            window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', { detail: data }));
            if (window.innerWidth < 1024) {
                 // Try to scroll to map
                 document.getElementById('map-container')?.scrollIntoView({ behavior: 'smooth' });
            }
        });
    });

    // Auto-trace the best route on map immediately
    if (journeys.length > 0) {
        window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', { detail: journeys[0] }));
    }

    if (window.showToast) window.showToast(`${journeys.length} opciones encontradas`, 'success');
  }

  function renderDirectCardHtml(journey, isBest = false) {
        const route = journey.legs[0];
        const badgesHtml = route.badges.map(b => `<span class="badge-primary" style="font-size: 0.5625rem;">${escapeHtml(b)}</span>`).join('');

        let stopsPreview = `${escapeHtml(route.origin_hub)} ‚Üí ${escapeHtml(route.dest_hub)}`;
        if (route.stops && route.stops.length > 0) {
             stopsPreview = `${escapeHtml(route.stops[0])} ‚Üí ${escapeHtml(route.stops[route.stops.length - 1])}`;
        }

        return `
          <div class="glass-card active:scale-[0.98] transition-all duration-300 mb-4 animate-slide-up relative overflow-hidden group hover:-translate-y-0.5 ${isBest ? 'ring-2 ring-primary-500/30' : ''}">
            ${isBest ? `<div class="absolute top-0 right-0 bg-primary-500 text-white text-xxs font-black px-3 py-1 rounded-bl-xl uppercase tracking-widest z-10">${ui[currentLang]['calc.best']}</div>` : ''}
            <div class="flex justify-between items-start">
              <div class="flex-1 min-w-0 pr-2">
                <span class="badge-primary mb-2">
                  ${escapeHtml(getTransportLabel(route.transport_type))}
                </span>
                <h3 class="font-display font-black text-base leading-tight tracking-tight group-hover:text-primary-500 transition-colors truncate" style="color: var(--text-primary);">${escapeHtml(route.name)}</h3>

                <div class="mt-2.5 flex flex-wrap gap-x-3 gap-y-1.5 text-xxs font-bold uppercase tracking-widest" style="color: var(--text-tertiary);">
                    ${route.operator ? `<div class="flex items-center gap-1"><span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">directions_bus</span> <span>${escapeHtml(route.operator)}</span></div>` : ''}
                    ${route.frequency ? `<div class="flex items-center gap-1"><span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">schedule</span> <span>${escapeHtml(route.frequency)}</span></div>` : ''}
                </div>

                <div class="flex gap-1.5 mt-3 flex-wrap">
                   ${badgesHtml}
                </div>
              </div>
              <div class="text-right shrink-0 flex flex-col items-end pl-3" style="border-left: 1px solid var(--border-light);">
                <span class="price-tag">
                    \$${journey.total_price.toFixed(2)}
                </span>
                <p class="text-xxs font-black mt-2 uppercase tracking-tight" style="color: var(--text-tertiary);">${escapeHtml(route.duration)}</p>

                <button class="btn-primary btn-sm mt-3 whitespace-nowrap view-map-btn" data-journey='${JSON.stringify(journey).replace(/'/g, "&#39;")}'>
                    <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">map</span> ${ui[currentLang]['calc.view_map']}
                </button>
              </div>
            </div>
            <div class="mt-3 pt-3 text-xxs font-bold flex items-center gap-2 uppercase tracking-widest" style="border-top: 1px solid var(--border-light); color: var(--text-tertiary);">
                <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">near_me</span> <span class="truncate flex-1">${stopsPreview}</span>
            </div>
          </div>
        `;
  }

  function renderTransferCardHtml(journey, isBest = false) {
      const leg1 = journey.legs[0];
      const leg2 = journey.legs[1];
      const transferPoint = journey.transfer_point;

      return `
          <div class="glass-card active:scale-[0.98] transition-all mb-3 animate-slide-up relative overflow-hidden group ${isBest ? 'ring-2 ring-primary-500/30' : ''}">
            <div class="absolute top-0 right-0 bg-accent-500 text-white px-3 py-1 rounded-bl-xl text-xxs font-black uppercase tracking-widest ${isBest ? 'mr-24' : ''}">
               ${ui[currentLang]['calc.transfer']}
            </div>
            ${isBest ? `<div class="absolute top-0 right-0 bg-primary-500 text-white text-xxs font-black px-3 py-1 rounded-bl-xl uppercase tracking-widest z-10">${ui[currentLang]['calc.best']}</div>` : ''}

            <div class="flex flex-col gap-3 mt-5">
                <!-- Leg 1 -->
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0 w-8 text-center">
                        <span class="w-3 h-3 rounded-full bg-success-500 border-2 border-white dark:border-slate-900 shadow-md mx-auto block"></span>
                        <div class="h-6 w-0.5 mx-auto my-0.5 rounded-full" style="background: var(--border-light);"></div>
                    </div>
                    <div>
                         <span class="badge-primary" style="font-size: 0.5rem;">
                            ${escapeHtml(getTransportLabel(leg1.transport_type))}
                         </span>
                         <h4 class="font-display font-black text-sm leading-tight tracking-tight" style="color: var(--text-primary);">${escapeHtml(leg1.name)}</h4>
                    </div>
                </div>

                <!-- Transfer point -->
                <div class="flex items-center gap-3 -mt-2">
                    <div class="flex-shrink-0 w-8 text-center flex justify-center">
                        <div class="w-2.5 h-2.5 rounded-full bg-accent-500 border-2 border-white dark:border-slate-900 shadow-md ring-2 ring-accent-500/20 animate-pulse"></div>
                    </div>
                    <div class="chip text-xxs">
                        <span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">sync_alt</span>
                        Cambio en <span class="text-primary-500 font-black">${escapeHtml(transferPoint)}</span>
                    </div>
                </div>

                <!-- Leg 2 -->
                <div class="flex items-center gap-3 -mt-2">
                    <div class="flex-shrink-0 w-8 text-center">
                        <div class="h-6 w-0.5 mx-auto my-0.5 rounded-full" style="background: var(--border-light);"></div>
                        <span class="w-3 h-3 rounded-full bg-danger-500 border-2 border-white dark:border-slate-900 shadow-md mx-auto block"></span>
                    </div>
                    <div>
                         <span class="badge-accent" style="font-size: 0.5rem;">
                            ${escapeHtml(getTransportLabel(leg2.transport_type))}
                         </span>
                         <h4 class="font-display font-black text-sm leading-tight tracking-tight" style="color: var(--text-primary);">${escapeHtml(leg2.name)}</h4>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-3 flex justify-between items-center" style="border-top: 1px solid var(--border-light);">
                <span class="price-tag">
                    \$${journey.total_price.toFixed(2)}
                </span>

                <button class="btn-primary btn-sm view-map-btn"
                    data-journey='${JSON.stringify(journey).replace(/'/g, "&#39;")}'>
                    <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">map</span> ${ui[currentLang]['calc.view_route']}
                </button>
            </div>
          </div>
      `;
  }

  function renderWasmError() {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card text-center animate-slide-up">
            <span class="material-symbols-rounded text-4xl mb-3 block" style="color: var(--text-tertiary); font-variation-settings: 'FILL' 1;">cloud_off</span>
            <h3 class="font-display font-black text-base mb-2" style="color: var(--text-primary);">${ui[currentLang]['calc.offline']}</h3>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">${ui[currentLang]['calc.offline_msg']}</p>
            <a href="/rutas" class="btn-secondary btn-sm inline-flex items-center gap-2">
               <span class="material-symbols-rounded text-sm">list_alt</span> ${ui[currentLang]['calc.view_all']}
            </a>
        </div>
    `;
  }

  function renderError(msg) {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card flex items-center gap-3 animate-slide-up" style="border-left: 3px solid var(--danger);">
            <span class="material-symbols-rounded text-danger-500 text-lg" style="font-variation-settings: 'FILL' 1;">error</span>
            <span class="font-bold text-sm" style="color: var(--danger);">${escapeHtml(msg)}</span>
        </div>
    `;
    if (window.showToast) window.showToast(msg, 'error');
  }

</script>

<style>
  /* GraffitiWarrior: CSS Anchor Positioning Tooltips */
  .graffiti-tooltip {
    position: absolute;
    background: #1e293b; /* slate-800 */
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s cubic-bezier(0.16, 1, 0.3, 1), translate 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 50;
    white-space: nowrap;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  /* Position Logic */
  .graffiti-tooltip.bottom {
    top: anchor(bottom);
    right: anchor(right); /* Align right edges to prevent clipping */
    translate: 0 10px;
  }

  .graffiti-tooltip.top {
    bottom: anchor(top);
    right: anchor(right); /* Align right edges to prevent clipping */
    translate: 0 -10px;
  }

  /* Reveal Logic - Sibling Selector inside Slot */
  button:hover + .graffiti-tooltip,
  button:focus-visible + .graffiti-tooltip {
    opacity: 1;
    translate: 0 6px; /* Offset for bottom */
  }

  button:hover + .graffiti-tooltip.top,
  button:focus-visible + .graffiti-tooltip.top {
    translate: 0 -6px; /* Offset for top */
  }
</style>
