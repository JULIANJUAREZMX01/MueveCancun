---
import { ui } from '../lib/i18n';
import Input from './ui/Input.astro';
import Switch from './ui/Switch.astro';
import PassengerSelector from './ui/PassengerSelector.astro';
---

<div class="calculator-wrapper" id="route-calculator-wrapper">

  <div class="glass-card search-card" id="search-card">

    <!-- Collapsible Header -->
    <div id="card-header" class="card-header">
      <div class="header-controls">
        <div id="balance-badge-container" class="balance-container">
           <span class="price-tag" id="balance-badge">Cargando...</span>
        </div>
        <button id="lang-toggle" class="lang-toggle">EN</button>
      </div>
    </div>

    <!-- Summary Bar (Initially Hidden) -->
    <div id="search-summary" class="summary-bar hidden">
        <div class="summary-info">
            <div class="summary-route">
               <div class="summary-point">
                  <span class="dot origin"></span>
                  <span id="summary-origin" class="summary-text" data-i18n="calc.origin">Origin</span>
               </div>
               <div class="connector"></div>
               <div class="summary-point">
                  <span class="dot dest"></span>
                  <span id="summary-dest" class="summary-text" data-i18n="calc.dest">Destination</span>
               </div>
            </div>
        </div>
        <button id="reset-search-btn" class="btn-edit" data-i18n="calc.reset">
            EDIT
        </button>
    </div>

    <!-- Main Search Form -->
    <div id="search-form-container" class="search-form">
      <!-- Alerts -->
      <div id="alerts-container"></div>

      <div class="inputs-group">
          <!-- Origin Input -->
          <div class="input-wrapper">
            <Input
              type="text"
              id="origin-input"
              name="origin"
              label={ui.es['calc.origin']}
              placeholder={ui.es['calc.origin_ph']}
              icon="/icons/map-pin.svg"
            >
               <button type="button" slot="action" id="gps-btn" class="action-btn gps-btn" aria-label="Use GPS">
                  <span class="material-symbols-rounded">my_location</span>
               </button>
               <div class="graffiti-tooltip bottom">Ubicaci√≥n Actual</div>
            </Input>
            <ul id="origin-suggestions" class="suggestions-list hidden"></ul>
          </div>

          <!-- Destination Input -->
          <div class="input-wrapper">
             <Input
              type="text"
              id="dest-input"
              name="dest"
              label={ui.es['calc.dest']}
              placeholder={ui.es['calc.dest_ph']}
              icon="/icons/flag.svg"
            >
               <button type="button" slot="action" id="map-picker-btn" class="action-btn map-btn" aria-label="Pick on Map">
                  <span class="material-symbols-rounded">map</span>
               </button>
               <div class="graffiti-tooltip bottom">Seleccionar en Mapa</div>
            </Input>
            <ul id="dest-suggestions" class="suggestions-list hidden"></ul>
          </div>
      </div>

      <!-- Settings & Search -->
      <div class="settings-row">
        <div class="toggles">
            <Switch id="ac-toggle" label="A/C" checked={true} />
            <Switch id="wifi-toggle" label="WiFi" />
        </div>

        <PassengerSelector />
      </div>

      <button id="search-btn" class="btn-primary btn-lg w-full search-btn">
        <span class="material-symbols-rounded icon">search</span>
        <span data-i18n="calc.btn">Buscar Rutas</span>
      </button>

      <!-- Favorites Section (Hidden by default) -->
      <div id="favorites-section" class="hidden">
        <h4 class="section-label">Tus Rutas Favoritas</h4>
        <div id="favorites-list" class="favorites-grid">
           <!-- Items injected via JS -->
        </div>
      </div>

    </div>
  </div>

  <!-- Results Container -->
  <div id="results-container" class="results-container"></div>

</div>

<script>
  import { ui } from '../lib/i18n';
  import { favoritesStore } from '../lib/FavoritesStore';
  // Use relative import for WASM functions (bundled by Vite/Rollup)
  // Ensure strict imports from public/wasm generated files
  import { find_route, load_catalog } from '../wasm/route-calculator/route_calculator.js';

  // State
  let currentLang = 'es';
  let wasmLoaded = false;
  let catalogLoaded = false;
  let userLocation = null;

  // DOM Elements
  const originInput = document.getElementById('origin-input');
  const destInput = document.getElementById('dest-input');
  const originSuggestions = document.getElementById('origin-suggestions');
  const destSuggestions = document.getElementById('dest-suggestions');
  const searchBtn = document.getElementById('search-btn');
  const resultsContainer = document.getElementById('results-container');
  const gpsBtn = document.getElementById('gps-btn');
  const mapPickerBtn = document.getElementById('map-picker-btn');
  const langToggle = document.getElementById('lang-toggle');
  const wrapper = document.getElementById('route-calculator-wrapper');

  // UI State Elements
  const searchCard = document.getElementById('search-card');
  const searchFormContainer = document.getElementById('search-form-container');
  const searchSummary = document.getElementById('search-summary');
  const cardHeader = document.getElementById('card-header');
  const resetSearchBtn = document.getElementById('reset-search-btn');
  const summaryOrigin = document.getElementById('summary-origin');
  const summaryDest = document.getElementById('summary-dest');
  const favoritesSection = document.getElementById('favorites-section');
  const favoritesList = document.getElementById('favorites-list');

  // Helper: Escape HTML
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
  }

  // --- Initialization ---

  async function initWasm() {
    try {
      // WASM is already instantiated by main.js or Layout via import
      // We just need to load data
      console.log("WASM initialized.");
      wasmLoaded = true;

      // Load master_routes.json into WASM
      if (typeof load_catalog === 'function') {
        try {
          console.log("üì¶ Loading route catalog...");
          const response = await fetch('/data/master_routes.json');
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const catalogData = await response.json();
          const catalogString = JSON.stringify(catalogData);
          
          await load_catalog(catalogString);
          catalogLoaded = true; // üî• Mark catalog as loaded
          console.log("‚úÖ Catalog loaded into WASM:", catalogData.rutas?.length || 0, "routes");
        } catch (catalogError) {
          console.error("‚ùå Failed to load catalog:", catalogError);
          catalogLoaded = false;
          renderError("Error loading route data. Please refresh.");
        }
      } else {
        console.warn("‚ö†Ô∏è WASM load_catalog() not available");
      }

    } catch (e) {
      console.error("Failed to init WASM:", e);
      renderWasmError();
    }
  }

  // Start init
  initWasm();
  renderFavorites();

  // Listen for favorites updates
  window.addEventListener('FAVORITES_UPDATED', () => renderFavorites());

  // --- UI Logic ---

  function renderFavorites() {
    if (!favoritesList || !favoritesSection) return;

    const favorites = favoritesStore.getFavorites();
    if (favorites.length === 0) {
      favoritesSection.classList.add('hidden');
      return;
    }

    favoritesSection.classList.remove('hidden');
    favoritesList.innerHTML = favorites.map(fav => `
      <a href="/ruta/${fav.id}" class="favorite-item">
        <span class="material-symbols-rounded icon-sm text-primary">directions_bus</span>
        <span class="fav-name">${escapeHtml(fav.nombre)}</span>
      </a>
    `).join('');
  }

  // Language Toggle
  if (langToggle) {
    langToggle.addEventListener('click', () => {
      currentLang = currentLang === 'es' ? 'en' : 'es';
      langToggle.textContent = currentLang.toUpperCase();
      updateUIText();
    });
  }

  function updateUIText() {
    // Basic text updates based on data-i18n attributes
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (ui[currentLang][key]) {
        el.textContent = ui[currentLang][key];
      }
    });

    // Update placeholders
    if (originInput) originInput.placeholder = ui[currentLang]['calc.origin_ph'];
    if (destInput) destInput.placeholder = ui[currentLang]['calc.dest_ph'];
  }

  // Search Logic
  if (searchBtn) {
    searchBtn.addEventListener('click', async () => {
       if (!wasmLoaded || !catalogLoaded) {
           renderError(ui[currentLang]['calc.offline_msg']);
           return;
       }

       const origin = originInput.value.trim();
       const dest = destInput.value.trim();

       if (!origin || !dest) {
           renderError("Please enter both origin and destination.");
           return;
       }

       setLoading(true);

       // Simulate network/calc delay for UX
       await new Promise(r => setTimeout(r, 600));

       try {
           const results = find_route(origin, dest);
           renderResults(results);
           transitionToSummary(origin, dest);

           // Dispatch event for Map to draw route
           // We pick the best route (first one) to show initially
           if (results && results.length > 0) {
              const bestJourney = results[0];
               window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', {
                 detail: {
                   journey: bestJourney,
                   userLocation: userLocation
                 }
               }));
           }

       } catch (e) {
           console.error("Search error:", e);
           renderError("Error calculating route. Try different stops.");
       } finally {
           setLoading(false);
       }
    });
  }

  // View State Transition (Search -> Summary)
  function transitionToSummary(origin, dest) {
      // Hide Header
      if (cardHeader) {
          cardHeader.style.height = '0';
          cardHeader.style.opacity = '0';
          cardHeader.style.overflow = 'hidden';
          cardHeader.style.padding = '0';
      }

      // Hide Form
      if (searchFormContainer) {
          searchFormContainer.style.display = 'none';
      }

      // Show Summary
      if (searchSummary) {
          searchSummary.classList.remove('hidden');
          if (summaryOrigin) summaryOrigin.textContent = origin;
          if (summaryDest) summaryDest.textContent = dest;
      }

      // Update Container State
      if (searchCard) {
          searchCard.classList.add('collapsed');
      }
  }

  // Reset Logic (Summary -> Search)
  if (resetSearchBtn) {
      resetSearchBtn.addEventListener('click', () => {
          // Show Header
          if (cardHeader) {
              cardHeader.style.height = '';
              cardHeader.style.opacity = '';
              cardHeader.style.overflow = '';
              cardHeader.style.padding = '';
          }

          // Show Form
          if (searchFormContainer) {
              searchFormContainer.style.display = 'block';
          }

          // Hide Summary
          if (searchSummary) {
              searchSummary.classList.add('hidden');
          }

          // Clear Results
          if (resultsContainer) resultsContainer.innerHTML = '';

          // Reset Container State
          if (searchCard) {
              searchCard.classList.remove('collapsed');
          }
      });
  }

  function setLoading(isLoading) {
      if (!searchBtn) return;
      if (isLoading) {
          searchBtn.innerHTML = '<span class="loader"></span> ' + ui[currentLang]['calc.calculating'];
          searchBtn.disabled = true;
      } else {
          searchBtn.innerHTML = '<span class="material-symbols-rounded icon">search</span> ' + ui[currentLang]['calc.btn'];
          searchBtn.disabled = false;
      }
  }

  // --- Rendering Results ---

  function renderResults(journeys) {
      if (!resultsContainer) return;
      resultsContainer.innerHTML = '';

      if (!journeys || journeys.length === 0) {
          renderError(ui[currentLang]['calc.no_routes']);
          return;
      }

      journeys.forEach((journey, index) => {
          const isBest = index === 0;
          let html = '';

          if (journey.type === 'Direct') {
              html = renderCardHtml(journey, isBest);
          } else {
              html = renderTransferCardHtml(journey, isBest);
          }

          // Create element from HTML string
          const template = document.createElement('div');
          template.innerHTML = html.trim();
          const card = template.firstChild;

          // Add Event Listeners to Buttons inside the card
          const mapBtn = card.querySelector('.view-map-btn');
          if (mapBtn) {
             mapBtn.addEventListener('click', (e) => {
                 e.stopPropagation();
                 window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', {
                    detail: {
                       journey: journey,
                       userLocation: userLocation
                    }
                 }));
                 // Trigger View State Change
                 window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'map' }));
             });
          }

          resultsContainer.appendChild(card);
      });
  }

  function getTransportLabel(type) {
      // Map internal types to UI labels
      // "Bus_Urban", "Combi", "ADO", etc.
      return type.replace('_', ' ');
  }

  function renderCardHtml(journey, isBest = false) {
        const route = journey.legs[0];
        const badgesHtml = (route.social_alerts || []).map(b => `<span class="badge-accent">${escapeHtml(b)}</span>`).join('');

        let stopsPreview = `${escapeHtml(route.origin_hub || '...')} ‚Üí ${escapeHtml(route.dest_hub || '...')}`;
        if (route.stops && route.stops.length > 0) {
             stopsPreview = `${escapeHtml(route.stops[0].nombre)} ‚Üí ${escapeHtml(route.stops[route.stops.length - 1].nombre)}`;
        }

        return `
          <div class="glass-card result-card ${isBest ? 'best' : ''} animate-slide-up">
            ${isBest ? `<div class="best-badge">${ui[currentLang]['calc.best']}</div>` : ''}

            <div class="result-row top">
              <div class="result-info">
                <span class="badge-primary mb-2">
                  ${escapeHtml(getTransportLabel(route.tipo || route.transport_type))}
                </span>
                <h3 class="result-title">${escapeHtml(route.nombre || route.name)}</h3>

                <div class="result-meta">
                    ${route.empresa ? `<div class="meta-item"><span class="material-symbols-rounded icon-sm">directions_bus</span> <span>${escapeHtml(route.empresa)}</span></div>` : ''}
                    ${route.frecuencia_minutos ? `<div class="meta-item"><span class="material-symbols-rounded icon-sm">schedule</span> <span>${escapeHtml(route.frecuencia_minutos)} min</span></div>` : ''}
                </div>

                <div class="result-badges">
                   ${badgesHtml}
                </div>
              </div>

              <div class="result-price-column">
                <span class="price-tag">
                    $${journey.total_price.toFixed(2)}
                </span>
                <p class="duration-text">${escapeHtml(route.duration || 'Calculando...')}</p>

                <button class="btn-primary btn-sm mt-3 view-map-btn">
                    <span class="material-symbols-rounded icon-sm">map</span> ${ui[currentLang]['calc.view_map']}
                </button>
              </div>
            </div>

            <div class="result-footer">
                <span class="material-symbols-rounded icon-sm">near_me</span>
                <span class="footer-text">${stopsPreview}</span>
            </div>
          </div>
        `;
  }

  function renderTransferCardHtml(journey, isBest = false) {
      const leg1 = journey.legs[0];
      const leg2 = journey.legs[1];
      const transferPoint = journey.transfer_point;

      return `
          <div class="glass-card result-card ${isBest ? 'best' : ''} animate-slide-up">
            <div class="transfer-badge ${isBest ? 'offset-best' : ''}">
               ${ui[currentLang]['calc.transfer']}
            </div>
            ${isBest ? `<div class="best-badge">${ui[currentLang]['calc.best']}</div>` : ''}

            <div class="transfer-legs">
                <!-- Leg 1 -->
                <div class="leg-row">
                    <div class="timeline-col">
                        <span class="dot-start"></span>
                        <div class="line"></div>
                    </div>
                    <div class="leg-info">
                         <span class="badge-primary small">
                            ${escapeHtml(getTransportLabel(leg1.tipo || leg1.transport_type))}
                         </span>
                         <h4 class="leg-title">${escapeHtml(leg1.nombre || leg1.name)}</h4>
                    </div>
                </div>

                <!-- Transfer point -->
                <div class="transfer-row">
                    <div class="timeline-col center">
                        <div class="dot-transfer"></div>
                    </div>
                    <div class="chip small">
                        <span class="material-symbols-rounded icon-xs">sync_alt</span>
                        Cambio en <span class="highlight">${escapeHtml(transferPoint)}</span>
                    </div>
                </div>

                <!-- Leg 2 -->
                <div class="leg-row">
                    <div class="timeline-col">
                        <div class="line"></div>
                        <span class="dot-end"></span>
                    </div>
                    <div class="leg-info">
                         <span class="badge-accent small">
                            ${escapeHtml(getTransportLabel(leg2.tipo || leg2.transport_type))}
                         </span>
                         <h4 class="leg-title">${escapeHtml(leg2.nombre || leg2.name)}</h4>
                    </div>
                </div>
            </div>

            <div class="result-footer-split">
                <span class="price-tag">
                    $${journey.total_price.toFixed(2)}
                </span>

                <button class="btn-primary btn-sm view-map-btn">
                    <span class="material-symbols-rounded icon-sm">map</span> ${ui[currentLang]['calc.view_route']}
                </button>
            </div>
          </div>
      `;
  }

  function renderWasmError() {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card result-card centered animate-slide-up">
            <span class="material-symbols-rounded icon-xl error-color">cloud_off</span>
            <h3 class="result-title">${ui[currentLang]['calc.offline']}</h3>
            <p class="error-text">${ui[currentLang]['calc.offline_msg']}</p>
            <a href="/rutas" class="btn-secondary btn-sm">
               <span class="material-symbols-rounded icon-sm">list_alt</span> ${ui[currentLang]['calc.view_all']}
            </a>
        </div>
    `;
  }

  function renderError(msg) {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card error-card animate-slide-up">
            <span class="material-symbols-rounded icon-lg error-color">error</span>
            <span class="error-msg">${escapeHtml(msg)}</span>
        </div>
    `;
    if (window.showToast) window.showToast(msg, 'error');
  }

</script>

<style>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     Route Calculator Styles (CSS5)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  .calculator-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  /* ‚îÄ‚îÄ Search Card ‚îÄ‚îÄ */
  .search-card {
    position: relative;
    overflow: hidden;
    padding: 0 !important; /* Override glass-card default padding */
    transition: all 0.5s ease;
  }

  .search-card.collapsed {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .card-header {
    padding: var(--space-md);
    position: relative;
    min-height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid var(--border-light);
    transition: all 0.3s ease;
  }

  .header-controls {
    position: absolute;
    right: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .balance-container {
    display: none;
  }
  @media (min-width: 640px) {
    .balance-container { display: block; }
  }

  .lang-toggle {
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    transition: background-color 0.2s;
    background: var(--surface-bg);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    cursor: pointer;
  }
  .lang-toggle:hover {
    background: var(--border-light);
  }

  /* ‚îÄ‚îÄ Summary Bar ‚îÄ‚îÄ */
  .summary-bar {
    padding: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: fadeIn 0.3s ease;
    z-index: 20;
    position: relative;
    background: var(--surface-card);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border-light);
  }

  .summary-bar.hidden {
    display: none;
  }

  .summary-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    overflow: hidden;
  }

  .summary-route {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .summary-point {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-weight: 700;
    color: var(--text-primary);
    overflow: hidden;
  }

  .summary-text {
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .connector {
    height: 0.75rem;
    border-left: 1px solid var(--border-light);
    margin-left: 0.25rem; /* center with dot */
    margin-top: 0.125rem;
    margin-bottom: 0.125rem;
  }

  .dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    flex-shrink: 0;
  }
  .dot.origin { background-color: var(--color-success); }
  .dot.dest { background-color: var(--color-danger); }

  .btn-edit {
    font-size: 0.625rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary);
    background: var(--color-primary-light);
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-lg);
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    margin-left: 0.5rem;
    flex-shrink: 0;
  }
  .btn-edit:hover { filter: brightness(0.95); }

  /* ‚îÄ‚îÄ Search Form ‚îÄ‚îÄ */
  .search-form {
    padding: var(--space-xl);
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    transition: all 0.5s ease;
  }

  .inputs-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .input-wrapper {
    position: relative;
  }

  /* Action Buttons inside Input */
  .action-btn {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    width: 2rem;
    height: 2rem;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    color: var(--text-tertiary);
  }

  .action-btn:hover {
    background: var(--surface-bg);
    color: var(--color-primary);
  }

  .gps-btn:hover { color: var(--color-accent); }
  .map-btn:hover { color: var(--color-success); }

  /* Settings Row */
  .settings-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .toggles {
    display: flex;
    gap: var(--space-md);
  }

  .search-btn {
    width: 100%;
    font-size: 1rem;
    padding: 0.875rem;
  }

  /* ‚îÄ‚îÄ Favorites ‚îÄ‚îÄ */
  .favorites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .favorite-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--surface-elevated);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    text-decoration: none;
    transition: all 0.2s;
  }
  .favorite-item:hover {
    border-color: var(--color-primary);
    transform: translateY(-2px);
  }

  .fav-name {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .text-primary { color: var(--color-primary); }

  /* ‚îÄ‚îÄ Result Cards ‚îÄ‚îÄ */
  .results-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .result-card {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .result-card:active { transform: scale(0.98); }
  .result-card:hover { transform: translateY(-2px); }

  .result-card.best {
    box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.3);
  }

  .best-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: var(--color-primary);
    color: white;
    font-size: 0.625rem;
    font-weight: 900;
    padding: 0.25rem 0.75rem;
    border-bottom-left-radius: var(--radius-xl);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    z-index: 10;
  }

  .transfer-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: var(--color-accent);
    color: white;
    font-size: 0.625rem;
    font-weight: 900;
    padding: 0.25rem 0.75rem;
    border-bottom-left-radius: var(--radius-xl);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .transfer-badge.offset-best {
    margin-right: 6rem; /* Make room for best badge */
  }

  .result-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  .result-row.top {
    margin-bottom: 0.5rem;
  }

  .result-info {
    flex: 1;
    min-width: 0;
    padding-right: var(--space-sm);
  }

  .result-title {
    font-size: 1rem;
    font-weight: 900;
    line-height: 1.2;
    color: var(--text-primary);
    margin: 0.5rem 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .group:hover .result-title { color: var(--color-primary); }

  .result-meta {
    margin-top: 0.625rem;
    display: flex;
    flex-wrap: wrap;
    column-gap: 0.75rem;
    row-gap: 0.375rem;
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-tertiary);
  }
  .meta-item { display: flex; align-items: center; gap: 0.25rem; }

  .result-badges {
    display: flex;
    gap: 0.375rem;
    margin-top: 0.75rem;
    flex-wrap: wrap;
  }

  .result-price-column {
    text-align: right;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    padding-left: 0.75rem;
    border-left: 1px solid var(--border-light);
  }

  .duration-text {
    font-size: 0.625rem;
    font-weight: 900;
    margin-top: 0.5rem;
    text-transform: uppercase;
    color: var(--text-tertiary);
  }

  .result-footer {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-tertiary);
  }

  .footer-text {
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }

  /* ‚îÄ‚îÄ Transfer Card Specifics ‚îÄ‚îÄ */
  .transfer-legs {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1.25rem;
  }

  .leg-row { display: flex; align-items: center; gap: 0.75rem; }
  .transfer-row { display: flex; align-items: center; gap: 0.75rem; margin-top: -0.5rem; }

  .timeline-col {
    flex-shrink: 0;
    width: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .timeline-col.center { justify-content: center; }

  .line {
    width: 2px;
    height: 1.5rem;
    background: var(--border-light);
    border-radius: 9999px;
    margin: 0.125rem 0;
  }

  .dot-start { width: 0.75rem; height: 0.75rem; background: var(--color-success); border-radius: 9999px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .dot-end { width: 0.75rem; height: 0.75rem; background: var(--color-danger); border-radius: 9999px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .dot-transfer { width: 0.625rem; height: 0.625rem; background: var(--color-accent); border-radius: 9999px; border: 2px solid white; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2); }

  .leg-info {
    flex: 1;
  }
  .leg-title {
    font-size: 0.875rem;
    font-weight: 900;
    color: var(--text-primary);
    margin: 0;
    line-height: 1.2;
  }

  .highlight { color: var(--color-primary); font-weight: 900; }
  .badge-primary.small { font-size: 0.5rem; padding: 0.1rem 0.3rem; margin-bottom: 0.1rem; }
  .badge-accent.small { font-size: 0.5rem; padding: 0.1rem 0.3rem; margin-bottom: 0.1rem; }
  .chip.small { padding: 0.25rem 0.5rem; font-size: 0.625rem; }

  .result-footer-split {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* ‚îÄ‚îÄ Icons ‚îÄ‚îÄ */
  .icon { font-size: 1.25rem; font-variation-settings: 'FILL' 1; }
  .icon-lg { font-size: 1.5rem; font-variation-settings: 'FILL' 1; }
  .icon-xl { font-size: 2.25rem; font-variation-settings: 'FILL' 1; }
  .icon-sm { font-size: 0.875rem; font-variation-settings: 'FILL' 1; }
  .icon-xs { font-size: 0.75rem; font-variation-settings: 'FILL' 1; }

  .error-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-left: 3px solid var(--color-coral);
    animation: slideUp 0.3s ease;
  }
  .error-color { color: var(--color-coral); }
  .error-msg { font-size: 0.875rem; font-weight: 700; color: var(--color-coral); }

  .result-card.centered { text-align: center; display: flex; flex-direction: column; align-items: center; padding: var(--space-xl); }
  .error-text { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem; }

  /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }

  /* ‚îÄ‚îÄ Tooltips (GraffitiWarrior) ‚îÄ‚îÄ */
  .graffiti-tooltip {
    position: absolute;
    background: var(--color-ocean);
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s cubic-bezier(0.16, 1, 0.3, 1), translate 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 50;
    white-space: nowrap;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  }

  .graffiti-tooltip.bottom {
    top: anchor(bottom);
    right: anchor(right);
    translate: 0 10px;
  }

  button:hover + .graffiti-tooltip,
  button:focus-visible + .graffiti-tooltip {
    opacity: 1;
    translate: 0 6px;
  }
</style>
