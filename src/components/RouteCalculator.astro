---
import Card from './ui/Card.astro';
import Button from './ui/Button.astro';
import Input from './ui/Input.astro';
import Badge from './ui/Badge.astro';
import SkeletonLoader from './ui/SkeletonLoader.astro';
---

<div class="space-y-6" id="route-calculator-wrapper">

  <Card class="relative overflow-hidden border-0 !p-0 shadow-lg ring-1 ring-black/5">
    <!-- Header / Status Bar -->
    <div class="bg-slate-50 border-b border-slate-100 p-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="text-xl">üß≠</span>
        <h2 class="text-lg font-black text-deep-navy tracking-tight" id="title-text">Br√∫jula Urbana</h2>
      </div>
      <div class="flex items-center gap-2">
        <div id="balance-badge-container">
           <Badge variant="default" class="font-mono" id="balance-badge">Loading...</Badge>
        </div>
        <button id="lang-toggle" class="text-xs font-bold bg-white border border-slate-200 px-2 py-1 rounded-lg uppercase text-slate-500">EN</button>
      </div>
    </div>

    <div class="p-5 space-y-5">
      <!-- Alerts -->
      <div id="balance-warning" class="hidden">
        <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded-r-md flex items-start gap-3">
          <span class="text-red-500 mt-0.5">‚ö†Ô∏è</span>
          <div>
            <p class="text-xs font-bold text-red-800 uppercase tracking-wide">Saldo Insuficiente</p>
            <p class="text-xs text-red-600 font-medium mt-1" id="warning-text">Requiere $180 MXN para operar.</p>
          </div>
        </div>
      </div>

      <!-- Inputs -->
      <div class="space-y-4 relative">
        <div class="relative z-10">
          <Input
            id="origin-input"
            label="Origen"
            icon="/icons/map-pin.svg"
            placeholder="¬øD√≥nde est√°s?"
            list="locations"
          />
        </div>

        <!-- Swap Button -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 mt-2">
          <button id="swap-btn" class="w-10 h-10 bg-slate-50 border-2 border-slate-200 rounded-full flex items-center justify-center shadow-sm active:scale-95 transition-transform hover:bg-white text-slate-500">
            <img src="/icons/swap.svg" class="w-5 h-5 opacity-60" alt="Swap" />
          </button>
        </div>

        <div class="relative z-0">
          <Input
            id="destination-input"
            label="Destino"
            icon="/icons/flag.svg"
            placeholder="¬øA d√≥nde vas?"
            list="locations"
          />
        </div>
      </div>

      <!-- Quick Actions (Horizontal Scroll) -->
      <div>
        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Accesos R√°pidos</label>
        <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide snap-x">
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 hover:bg-primary-50 hover:text-primary-600 border border-slate-200 rounded-xl px-4 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Walmart">
            <span>üè†</span> <span class="text-sm font-bold">Casa</span>
          </button>
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 hover:bg-primary-50 hover:text-primary-600 border border-slate-200 rounded-xl px-4 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Plaza Las Am√©ricas">
            <span>üíº</span> <span class="text-sm font-bold">Trabajo</span>
          </button>
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 hover:bg-primary-50 hover:text-primary-600 border border-slate-200 rounded-xl px-4 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Aeropuerto Terminal 2">
            <span>‚úàÔ∏è</span> <span class="text-sm font-bold">Aeropuerto</span>
          </button>
           <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 hover:bg-primary-50 hover:text-primary-600 border border-slate-200 rounded-xl px-4 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Playa Delfines (El Mirador)">
            <span>üèñÔ∏è</span> <span class="text-sm font-bold">Playa</span>
          </button>
        </div>
      </div>

      <!-- Options -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="seats-input" class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Asientos</label>
          <div class="relative">
            <select id="seats-input" class="w-full h-[44px] bg-slate-50 border border-slate-200 rounded-xl px-3 font-bold text-slate-700 appearance-none focus:ring-2 focus:ring-primary-100 focus:border-primary-500">
              <option value="1">1 Pasajero</option>
              <option value="2">2 Pasajeros</option>
              <option value="3">3 Pasajeros</option>
              <option value="4">4 Pasajeros</option>
            </select>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div>
          </div>
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Modo</label>
          <label class="flex items-center h-[44px] bg-slate-50 border border-slate-200 rounded-xl px-3 cursor-pointer hover:bg-slate-100 transition-colors">
            <input type="checkbox" id="tourist-checkbox" class="w-5 h-5 rounded text-primary-500 border-gray-300 focus:ring-primary-500 mr-3" />
            <span class="text-sm font-bold text-slate-700">Turista</span>
          </label>
        </div>
      </div>

      <Button id="calculate-btn" class="w-full text-lg shadow-xl shadow-primary-500/20">
        <span id="btn-text">TRAZAR RUTA</span>
        <img src="/icons/loader.svg" class="w-5 h-5 animate-spin hidden" id="btn-spinner" alt="Loading" />
      </Button>

    </div>

    <!-- Loading State -->
    <div id="calculation-loader" class="hidden p-5 space-y-4 border-t border-slate-100 bg-slate-50/50">
        <SkeletonLoader height="h-24" />
        <SkeletonLoader height="h-12" />
        <SkeletonLoader height="h-12" />
    </div>

  </Card>

  <!-- Results Area -->
  <div id="results-container" class="space-y-4 empty:hidden">
      <!-- Results injected here -->
  </div>

  <datalist id="locations">
    <option value="El Crucero Hub"></option>
    <option value="ADO Centro / Terminal"></option>
    <option value="Plaza Las Am√©ricas"></option>
    <option value="Aeropuerto Terminal 2"></option>
    <option value="Aeropuerto Terminal 4"></option>
    <option value="Muelle Ultramar (Puerto Ju√°rez)"></option>
    <option value="Playa Delfines (El Mirador)"></option>
    <option value="Playa del Carmen Centro"></option>
    <option value="Walmart"></option>
    <option value="Villas Otoch Para√≠so"></option>
    <option value="Hospital General (Av. Kabah)"></option>
  </datalist>

</div>

<script>
  import { openDB } from 'idb';

  // Geolocation data for demo purposes
  const MOCK_GEO = {
    'El Crucero Hub': { lat: 21.1576, lng: -86.8269 },
    'ADO Centro / Terminal': { lat: 21.1586, lng: -86.8259 },
    'Plaza Las Am√©ricas': { lat: 21.1410, lng: -86.8430 },
    'Aeropuerto Terminal 2': { lat: 21.0417, lng: -86.8761 },
    'Aeropuerto Terminal 4': { lat: 21.0400, lng: -86.8750 },
    'Muelle Ultramar (Puerto Ju√°rez)': { lat: 21.2070, lng: -86.8020 },
    'Playa Delfines (El Mirador)': { lat: 21.0850, lng: -86.7750 },
    'Playa del Carmen Centro': { lat: 20.6296, lng: -87.0739 },
    'Walmart': { lat: 21.1595, lng: -86.8365 },
    'Villas Otoch Para√≠so': { lat: 21.1380, lng: -86.8650 },
    'Hospital General (Av. Kabah)': { lat: 21.1500, lng: -86.8400 },
  };

  const TRANSLATIONS = {
    es: {
      title: 'Br√∫jula Urbana',
      warning: 'Saldo insuficiente. Recarga tu cuenta ($180 MXN).',
      calculate: 'TRAZAR RUTA',
      calculating: 'CALCULANDO...',
      suggested: 'Mejor Opci√≥n',
      cashOnly: 'Solo Efectivo',
      instructions: 'Pasos a seguir'
    },
    en: {
      title: 'Urban Compass',
      warning: 'Insufficient balance. Top up required ($180 MXN).',
      calculate: 'FIND ROUTE',
      calculating: 'ROUTING...',
      suggested: 'Best Option',
      cashOnly: 'Cash Only',
      instructions: 'Steps'
    }
  };

  let currentLang = 'es';
  let balance = 0;
  let hasBalance = false;
  let wasmLoaded = false;
  let wasmModule = null;

  const btn = document.getElementById('calculate-btn');
  const resultsContainer = document.getElementById('results-container');
  const langToggle = document.getElementById('lang-toggle');
  const balanceBadge = document.getElementById('balance-badge');
  const balanceWarning = document.getElementById('balance-warning');
  const btnSpinner = document.getElementById('btn-spinner');
  const btnText = document.getElementById('btn-text');
  const calculationLoader = document.getElementById('calculation-loader');

  // Quick Actions
  document.querySelectorAll('.quick-action-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const dest = (e.currentTarget).dataset.dest;
        const destInput = document.getElementById('destination-input');
        if (destInput) destInput.value = dest;
    });
  });

  async function updateBalance() {
    const db = await openDB('cancunmueve-db', 2, {
      upgrade(db) {
        if (!db.objectStoreNames.contains('wallet-status')) {
          db.createObjectStore('wallet-status');
        }
      },
    });
    let currentBalance = await db.get('wallet-status', 'driver_current');
    if (currentBalance === undefined) {
      currentBalance = 180.0;
      await db.put('wallet-status', currentBalance, 'driver_current');
    }
    balance = currentBalance;

    if (wasmLoaded && wasmModule) {
        try {
            hasBalance = wasmModule.validate_operator_funds(balance);
        } catch (e) {
            hasBalance = balance >= 180.0;
        }
    } else {
        hasBalance = balance >= 180.0;
    }

    if (balanceBadge) {
        balanceBadge.textContent = `$${balance.toFixed(0)}`;
        if (hasBalance) {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-green-100 text-green-700 font-mono";
        } else {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-red-100 text-red-700 font-mono";
        }
    }

    if (balanceWarning) {
      balanceWarning.classList.toggle('hidden', hasBalance);
    }

    if (btn) (btn as HTMLButtonElement).disabled = !hasBalance || !wasmLoaded;
  }

  function updateUI() {
    const t = TRANSLATIONS[currentLang];
    const titleText = document.getElementById('title-text');
    if (titleText) titleText.textContent = t.title;

    if (btnText && !(btn as HTMLButtonElement).disabled) btnText.textContent = t.calculate;

    if (langToggle) langToggle.textContent = currentLang === 'es' ? 'EN' : 'ES';
  }

  async function start() {
    try {
      wasmModule = await import('../wasm/route_calculator.js');
      await wasmModule.default();
      wasmLoaded = true;
      await updateBalance();
      updateUI();
    } catch (e) {
      console.error("WASM Load Critical Error:", e);
    }
  }

  langToggle?.addEventListener('click', () => {
    currentLang = currentLang === 'es' ? 'en' : 'es';
    updateUI();
  });

  const swapBtn = document.getElementById('swap-btn');
  swapBtn?.addEventListener('click', () => {
     const origin = document.getElementById('origin-input');
     const dest = document.getElementById('destination-input');
     const temp = origin.value;
     origin.value = dest.value;
     dest.value = temp;
  });

  btn?.addEventListener('click', async () => {
    if (!wasmLoaded || !wasmModule || !hasBalance) return;

    const fromVal = (document.getElementById('origin-input') as HTMLInputElement).value;
    const toVal = (document.getElementById('destination-input') as HTMLInputElement).value;
    const seatsVal = parseInt((document.getElementById('seats-input') as HTMLSelectElement).value);
    const isTouristVal = (document.getElementById('tourist-checkbox') as HTMLInputElement).checked;

    if (btnText) btnText.textContent = TRANSLATIONS[currentLang].calculating;
    if (btnSpinner) btnSpinner.classList.remove('hidden');
    if (calculationLoader) calculationLoader.classList.remove('hidden');
    if (resultsContainer) resultsContainer.innerHTML = ''; // Clear prev results
    (btn as HTMLButtonElement).disabled = true;

    // Simulate network delay for UX (Skeleton)
    await new Promise(r => setTimeout(r, 800));

    try {
      const response = await fetch('/data/master_routes.json');
      const routesData = await response.json();

      const fromCoords = MOCK_GEO[fromVal] || { lat: 21.1619, lng: -86.8515 };
      const toCoords = MOCK_GEO[toVal] || { lat: 21.0412, lng: -86.8725 };

      const res = wasmModule.calculate_route(
        fromCoords.lat,
        fromCoords.lng,
        toCoords.lat,
        toCoords.lng,
        routesData
      );

      console.log('Route Result:', res);

      if (res.success) {
        let costRes = wasmModule.calculate_trip_cost(res.distance_km, seatsVal, isTouristVal);

        // Handle Map return from WASM (serde_json::Value -> Map)
        if (costRes instanceof Map) {
            const infoMap = costRes.get('info');
            costRes = {
                cost_mxn: costRes.get('cost_mxn'),
                base_price: costRes.get('base_price'),
                currency: costRes.get('currency'),
                payment_method: costRes.get('payment_method'),
                info: infoMap instanceof Map ? Object.fromEntries(infoMap) : infoMap,
                seats: costRes.get('seats')
            };
        }

        renderResults(res, costRes);
      } else {
        renderError(res.error?.[currentLang] || "Error");
      }
    } catch (error) {
      console.error(error);
      renderError("System Error: " + (error.message || error));
    } finally {
      if (btnText) btnText.textContent = TRANSLATIONS[currentLang].calculate;
      if (btnSpinner) btnSpinner.classList.add('hidden');
      if (calculationLoader) calculationLoader.classList.add('hidden');
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  function renderResults(res, cost) {
    if (!resultsContainer) return;
    const t = TRANSLATIONS[currentLang];

    // Mimic RouteResultCard.astro Structure using Template Literals
    const html = `
      <div class="block group animate-slide-up">
        <div class="bg-white rounded-2xl shadow-lg border-l-4 border-l-primary-500 p-4 relative overflow-hidden transition-transform active:scale-98">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <h3 class="text-2xl font-black text-gray-900 tracking-tight">${res.routes[0]}</h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-green-100 text-green-700">Ruta Segura</span>
                    </div>
                    <p class="text-sm font-medium text-slate-500 line-clamp-1">${res.routes.join(' ‚ûî ')}</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-black text-primary-600">$${cost.cost_mxn.toFixed(0)}</div>
                    <div class="text-xs font-bold text-slate-400 flex items-center justify-end gap-1">
                        <span>‚è±Ô∏è</span> ${(res.distance_km * 3).toFixed(0)} min
                    </div>
                </div>
            </div>

            ${res.airport_warning ? `
                <div class="mt-2 p-2 bg-red-50 text-red-700 rounded-lg text-xs font-bold flex gap-2 items-center">
                    <span>üö®</span> ${res.airport_warning[currentLang]}
                </div>
            ` : ''}

            <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-100">
                <div class="flex gap-2">
                     <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                        üíµ ${t.cashOnly}
                    </span>
                </div>
                <button class="text-primary-500 text-sm font-bold flex items-center gap-1">
                    Ver Detalles ‚Üí
                </button>
            </div>

             <div class="mt-4 space-y-2 border-t border-slate-100 pt-3">
                ${res.instructions.map((inst, idx) => `
                    <div class="flex gap-3 text-sm font-medium text-slate-700 items-start">
                        <span class="flex-shrink-0 w-5 h-5 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center text-[10px] font-bold">${idx + 1}</span>
                        <span>${inst[currentLang]}</span>
                    </div>
                `).join('')}
             </div>
        </div>
      </div>
    `;

    resultsContainer.innerHTML = html;

    // Trigger generic toast
    if (window.showToast) window.showToast('Ruta calculada con √©xito', 'success');
  }

  function renderError(msg) {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="bg-red-50 p-4 rounded-xl border border-red-100 text-red-700 font-bold text-sm flex items-center gap-2 animate-slide-up">
            <span>‚ùå</span> ${msg}
        </div>
    `;
    if (window.showToast) window.showToast(msg, 'error');
  }

  start();
</script>
