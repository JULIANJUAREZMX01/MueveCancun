---
import Card from './ui/Card.astro';
import Button from './ui/Button.astro';
import Input from './ui/Input.astro';
import Badge from './ui/Badge.astro';
import SkeletonLoader from './ui/SkeletonLoader.astro';
---

<div class="space-y-6" id="route-calculator-wrapper">

  <Card class="relative overflow-hidden border-0 !p-0 shadow-lg ring-1 ring-black/5">
    <!-- Header / Status Bar -->
    <div class="bg-slate-50 border-b border-slate-100 p-4 relative flex items-center justify-center min-h-[64px]">
      <div class="absolute left-4 flex items-center gap-2 lg:hidden">
         <!-- Mobile spacer or branding if needed, currently empty to allow centering -->
      </div>

      <h2 class="font-black text-deep-navy tracking-tight text-center w-full"
          style="font-size: calc(1.125rem * 1.13);"
          id="title-text">
        Que ruta me lleva?
      </h2>

      <div class="absolute right-4 flex items-center gap-2">
        <div id="balance-badge-container" class="hidden sm:block">
           <Badge variant="default" class="font-mono" id="balance-badge">Loading...</Badge>
        </div>
        <button id="lang-toggle" class="text-xs font-bold bg-white border border-slate-200 px-2 py-1 rounded-lg uppercase text-slate-500">EN</button>
      </div>
    </div>

    <div class="p-5 space-y-5">
      <!-- Alerts -->
      <div id="balance-warning" class="hidden">
        <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded-r-md flex items-start gap-3">
          <img src="/icons/alert.svg" class="w-5 h-5 mt-0.5" alt="Alert" />
          <div>
            <p class="text-xs font-bold text-red-800 uppercase tracking-wide">Saldo Insuficiente</p>
            <p class="text-xs text-red-600 font-medium mt-1" id="warning-text">Requiere $180 MXN para operar.</p>
          </div>
        </div>
      </div>

      <!-- Inputs -->
      <div class="space-y-4 relative">
        <div class="relative z-10">
          <Input
            id="origin-input"
            label="Origen"
            icon="/icons/map-pin.svg"
            placeholder="¬øD√≥nde est√°s?"
            list="locations"
            aria-controls="locations"
            aria-expanded="false"
          >
            <button slot="action" id="gps-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-primary-500 transition-colors" title="Usar mi ubicaci√≥n">
              <img src="/icons/gps.svg" class="w-5 h-5" alt="GPS" />
            </button>
          </Input>
        </div>

        <!-- Swap Button -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 mt-2">
          <button id="swap-btn" class="w-10 h-10 bg-slate-50 border-2 border-slate-200 rounded-full flex items-center justify-center shadow-sm active:scale-95 transition-transform hover:bg-white text-slate-500">
            <img src="/icons/swap.svg" class="w-5 h-5 opacity-60" alt="Swap" />
          </button>
        </div>

        <div class="relative z-0">
          <Input
            id="destination-input"
            label="Destino"
            icon="/icons/flag.svg"
            placeholder="¬øA d√≥nde vas?"
            list="locations"
            aria-controls="locations"
            aria-expanded="false"
          />
            <button slot="action" id="map-picker-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-primary-500 transition-colors" title="Seleccionar en mapa">
              <img src="/icons/map-plus.svg" class="w-5 h-5" alt="Map Picker" />
            </button>
          </Input>
        </div>
      </div>

      <!-- Quick Actions (Horizontal Scroll) -->
      <div>
        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Accesos R√°pidos</span>
        <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide snap-x">
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 hover:bg-primary-50 hover:text-primary-600 border border-slate-200 rounded-xl px-4 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Walmart">
            <img src="/icons/home.svg" class="w-5 h-5" alt="Casa" /> <span class="text-sm font-bold">Casa</span>
          </button>
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 hover:bg-primary-50 hover:text-primary-600 border border-slate-200 rounded-xl px-4 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Plaza Las Am√©ricas">
            <img src="/icons/briefcase.svg" class="w-5 h-5" alt="Trabajo" /> <span class="text-sm font-bold">Trabajo</span>
          </button>
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 hover:bg-primary-50 hover:text-primary-600 border border-slate-200 rounded-xl px-4 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Aeropuerto Terminal 2">
            <img src="/icons/plane.svg" class="w-5 h-5" alt="Aeropuerto" /> <span class="text-sm font-bold">Aeropuerto</span>
          </button>
           <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 hover:bg-primary-50 hover:text-primary-600 border border-slate-200 rounded-xl px-4 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Playa Delfines (El Mirador)">
            <img src="/icons/palm-tree.svg" class="w-5 h-5" alt="Playa" /> <span class="text-sm font-bold">Playa</span>
          </button>
        </div>
      </div>

      <!-- Options -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="seats-input" class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Asientos</label>
          <div class="relative">
            <select id="seats-input" class="w-full h-[44px] bg-slate-50 border border-slate-200 rounded-xl px-3 font-bold text-slate-700 appearance-none focus:ring-2 focus:ring-primary-100 focus:border-primary-500">
              <option value="1">1 Pasajero</option>
              <option value="2">2 Pasajeros</option>
              <option value="3">3 Pasajeros</option>
              <option value="4">4 Pasajeros</option>
            </select>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div>
          </div>
        </div>
        <div>
          <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Modo</span>
          <label class="flex items-center h-[44px] bg-slate-50 border border-slate-200 rounded-xl px-3 cursor-pointer hover:bg-slate-100 transition-colors">
            <input type="checkbox" id="tourist-checkbox" class="w-5 h-5 rounded text-primary-500 border-gray-300 focus:ring-primary-500 mr-3" />
            <span class="text-sm font-bold text-slate-700">Turista</span>
          </label>
        </div>
      </div>

      <Button id="search-btn" class="w-full text-lg shadow-xl shadow-primary-500/20">
        <span id="btn-text">¬øComo llegar?</span>
        <img src="/icons/loader.svg" class="w-5 h-5 animate-spin hidden" id="btn-spinner" alt="Loading" />
      </Button>

    </div>

    <!-- Loading State -->
    <div id="calculation-loader" class="hidden p-5 space-y-4 border-t border-slate-100 bg-slate-50/50">
        <SkeletonLoader height="h-24" />
        <SkeletonLoader height="h-12" />
        <SkeletonLoader height="h-12" />
    </div>

  </Card>

  <!-- Results Area -->
  <div id="results-container" class="space-y-4 empty:hidden">
      <!-- Results injected here -->
  </div>

  <datalist id="locations">
    <option value="El Crucero Hub"></option>
    <option value="ADO Centro / Terminal"></option>
    <option value="Plaza Las Am√©ricas"></option>
    <option value="Aeropuerto Terminal 2"></option>
    <option value="Aeropuerto Terminal 4"></option>
    <option value="Muelle Ultramar (Puerto Ju√°rez)"></option>
    <option value="Playa Delfines (El Mirador)"></option>
    <option value="Playa del Carmen Centro"></option>
    <option value="Walmart"></option>
    <option value="Villas Otoch Para√≠so"></option>
    <option value="Hospital General (Av. Kabah)"></option>
  </datalist>

</div>

<script>
  import { openDB } from 'idb';

  const TRANSLATIONS = {
    es: {
      title: 'Que ruta me lleva?',
      warning: 'Saldo insuficiente. Recarga tu cuenta ($180 MXN).',
      calculate: '¬øComo llegar?',
      calculating: 'CALCULANDO...',
      suggested: 'Mejor Opci√≥n',
      cashOnly: 'Solo Efectivo',
      instructions: 'Pasos a seguir'
    },
    en: {
      title: 'What route do I take?',
      warning: 'Insufficient balance. Top up required ($180 MXN).',
      calculate: 'How to get there?',
      calculating: 'ROUTING...',
      suggested: 'Best Option',
      cashOnly: 'Cash Only',
      instructions: 'Steps'
    }
  };

  let currentLang = 'es';
  let balance = 0;
  let hasBalance = false;
  let wasmLoaded = false;
  let find_route, validate_operator_funds, analyze_gap_wasm;
  let realOriginCoords = null;
  let realDestCoords = null;

  const btn = document.getElementById('search-btn');
  const resultsContainer = document.getElementById('results-container');
  const langToggle = document.getElementById('lang-toggle');
  const balanceBadge = document.getElementById('balance-badge');
  const balanceWarning = document.getElementById('balance-warning');
  const btnSpinner = document.getElementById('btn-spinner');
  const btnText = document.getElementById('btn-text');
  const calculationLoader = document.getElementById('calculation-loader');

  // Quick Actions
  document.querySelectorAll('.quick-action-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const dest = (e.currentTarget).dataset.dest;
        const destInput = document.getElementById('destination-input');
        if (destInput) destInput.value = dest;
    });
  });

  async function updateBalance() {
    try {
        const stored = localStorage.getItem('user_balance');
        if (stored !== null) {
            balance = parseFloat(stored);
        } else {
            balance = 180.0;
            localStorage.setItem('user_balance', balance.toString());
        }
    } catch (e) {
        console.warn("Storage Error, using default balance:", e);
        balance = 180.0;
    }

    if (wasmLoaded && typeof validate_operator_funds === 'function') {
        try {
            hasBalance = validate_operator_funds(balance);
        } catch (e) {
            console.warn("WASM validation failed, fallback to strict check", e);
            hasBalance = balance >= 180.0;
        }
    } else {
        hasBalance = balance >= 180.0;
    }

    if (balanceBadge) {
        balanceBadge.textContent = `$${balance.toFixed(0)}`;
        if (hasBalance) {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-green-100 text-green-700 font-mono";
        } else {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-red-100 text-red-700 font-mono";
        }
    }

    if (balanceWarning) {
      balanceWarning.classList.toggle('hidden', hasBalance);
    }

    if (btn) (btn as HTMLButtonElement).disabled = !hasBalance;
  }

  function updateUI() {
    const t = TRANSLATIONS[currentLang];
    const titleText = document.getElementById('title-text');
    if (titleText) titleText.textContent = t.title;

    if (btnText && !(btn as HTMLButtonElement).disabled) btnText.textContent = t.calculate;

    if (langToggle) langToggle.textContent = currentLang === 'es' ? 'EN' : 'ES';
  }

  async function start() {
    try {
      console.log("Initializing WASM...");
      const wasmPath = new URL('/wasm/route-calculator/route_calculator.js', window.location.href).href;
      const module = await import(/* @vite-ignore */ wasmPath);
      await module.default();
      find_route = module.find_route;
      validate_operator_funds = module.validate_operator_funds;
      analyze_gap_wasm = module.analyze_gap;

      console.log("WASM initialized.");
      wasmLoaded = true;
    } catch (e) {
      console.error("WASM Load Critical Error:", e);
      renderWasmError();
    } finally {
      await updateBalance();
      updateUI();
      initGPSLogic();
    }
  }

  let coordinatesDB = {};

  async function loadCoordinates() {
      try {
          const res = await fetch('/coordinates.json');
          coordinatesDB = await res.json();
      } catch (e) {
          console.error("Failed to load coordinates for GPS features", e);
      }
  }

  function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    var R = 6371; // Radius of the earth in km
    var dLat = deg2rad(lat2-lat1);
    var dLon = deg2rad(lon2-lon1);
    var a =
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2)
      ;
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    var d = R * c; // Distance in km
    return d;
  }

  function deg2rad(deg) {
    return deg * (Math.PI/180)
  }

  function initGPSLogic() {
      loadCoordinates();

      const gpsBtn = document.getElementById('gps-btn');
      const mapPickerBtn = document.getElementById('map-picker-btn');
      const originInput = document.getElementById('origin-input');
      const destInput = document.getElementById('destination-input');

      // Reset real coords on manual input
      originInput?.addEventListener('input', () => { realOriginCoords = null; });
      destInput?.addEventListener('input', () => { realDestCoords = null; });

      // Brand Phase Triggers
      originInput?.addEventListener('blur', (e) => {
          if ((e.target as HTMLInputElement).value.length > 0) {
              window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 1 } }));
          }
      });

      destInput?.addEventListener('blur', (e) => {
          if ((e.target as HTMLInputElement).value.length > 0) {
              window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 2 } }));
          }
      });

      gpsBtn?.addEventListener('click', () => {
          if (!navigator.geolocation) {
              if (window.showToast) window.showToast("Geolocalizaci√≥n no soportada", "error");
              return;
          }

          const originInput = document.getElementById('origin-input');
          const parent = originInput.parentElement;
          parent.classList.add('opacity-50', 'pointer-events-none');

          navigator.geolocation.getCurrentPosition((pos) => {
              const { latitude, longitude } = pos.coords;
              realOriginCoords = [latitude, longitude]; // Store raw coords for Gap Analysis

              let minDist = Infinity;
              let nearest = '';

              Object.entries(coordinatesDB).forEach(([name, coords]) => {
                  const d = getDistanceFromLatLonInKm(latitude, longitude, coords[0], coords[1]);
                  if (d < minDist) {
                      minDist = d;
                      nearest = name;
                  }
              });

              if (nearest) {
                  (originInput as HTMLInputElement).value = nearest;
                  // Trigger Phase 1
                  window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 1 } }));
                  if (window.showToast) window.showToast(`Ubicaci√≥n: ${nearest}`, "success");
              } else {
                   if (window.showToast) window.showToast("No se encontraron paradas cercanas", "warning");
              }
              parent.classList.remove('opacity-50', 'pointer-events-none');
          }, (err) => {
              console.error(err);
              parent.classList.remove('opacity-50', 'pointer-events-none');
              if (window.showToast) window.showToast("Error al obtener ubicaci√≥n", "error");
          });
      });

      mapPickerBtn?.addEventListener('click', () => {
          const originInput = document.getElementById('origin-input');
          const destInput = document.getElementById('destination-input');

          sessionStorage.setItem('temp_origin', (originInput as HTMLInputElement).value);
          // We don't save dest as we are about to pick it

          window.location.href = '/mapa?picker=destination';
      });

      // Check return
      const urlParams = new URLSearchParams(window.location.search);
      const pickedStop = urlParams.get('selected_stop');

      if (pickedStop) {
          const originInput = document.getElementById('origin-input');
          const destInput = document.getElementById('destination-input');
          const savedOrigin = sessionStorage.getItem('temp_origin');

          if (savedOrigin) (originInput as HTMLInputElement).value = savedOrigin;
          if (destInput) (destInput as HTMLInputElement).value = pickedStop;

          window.history.replaceState({}, document.title, window.location.pathname);
          sessionStorage.removeItem('temp_origin');

          // Trigger Phase 2 immediately
          setTimeout(() => {
              window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 2 } }));
          }, 500);
      }
  }

  document.addEventListener('astro:page-load', start);

  langToggle?.addEventListener('click', () => {
    currentLang = currentLang === 'es' ? 'en' : 'es';
    updateUI();
  });

  const swapBtn = document.getElementById('swap-btn');
  swapBtn?.addEventListener('click', () => {
     const origin = document.getElementById('origin-input');
     const dest = document.getElementById('destination-input');
     const temp = origin.value;
     origin.value = dest.value;
     dest.value = temp;
  });

  function resolveCoords(name) {
      if (!name) return null;
      if (coordinatesDB[name]) return coordinatesDB[name];
      const key = Object.keys(coordinatesDB).find(k => name.includes(k) || k.includes(name));
      return key ? coordinatesDB[key] : null;
  }

  btn?.addEventListener('click', async () => {
    if (!wasmLoaded) {
         renderError("El sistema no est√° listo (WASM offline).");
         return;
    }
    if (!hasBalance) return;

    const fromVal = (document.getElementById('origin-input') as HTMLInputElement).value;
    const toVal = (document.getElementById('destination-input') as HTMLInputElement).value;

    if (toVal.toLowerCase().includes("aeropuerto") && fromVal.toLowerCase().includes("walmart")) {
         renderError("Ruta restringida hacia el Aeropuerto desde Walmart (Solo Taxis/ADO).");
         return;
    }

    // Trigger Phase 3 (Tetris)
    window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 3 } }));

    // Immediate View Transition
    window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: { state: 'map' } }));

    if (btnText) btnText.textContent = TRANSLATIONS[currentLang].calculating;
    if (btnSpinner) btnSpinner.classList.remove('hidden');
    if (calculationLoader) calculationLoader.classList.remove('hidden');
    if (resultsContainer) resultsContainer.innerHTML = '';
    (btn as HTMLButtonElement).disabled = true;

    try {
      // Gap Analysis
      const originCoords = realOriginCoords || resolveCoords(fromVal);
      const destCoords = realDestCoords || resolveCoords(toVal);

      let gapRes = null;
      if (originCoords && destCoords && analyze_gap_wasm) {
          try {
              gapRes = analyze_gap_wasm(originCoords[0], originCoords[1], destCoords[0], destCoords[1]);
          } catch(e) { console.warn("Gap Analysis failed", e); }
      }

      // Optimize search if Gap Analysis found a better nearby hub
      // But for now we stick to what the user sees in the input to avoid confusion
      const res = find_route(fromVal, toVal);

      console.log('Route Result:', res, 'Gap:', gapRes);

      // Pass both journeys and gap info
      renderResults({ journeys: res, gap: gapRes, query: { from: fromVal, to: toVal } });
    } catch (error) {
      console.error(error);
      renderError("System Error: " + (error.message || error));
    } finally {
      if (btnText) btnText.textContent = TRANSLATIONS[currentLang].calculate;
      if (btnSpinner) btnSpinner.classList.add('hidden');
      if (calculationLoader) calculationLoader.classList.add('hidden');
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  const TRANSPORT_LABELS = {
    "Bus": "Autob√∫s",
    "Combi": "Combi",
    "Van": "Van / Colectivo",
    "ADO": "ADO",
    "PlayaExpress": "Playa Express",
  };

  function getTransportLabel(type) {
    return TRANSPORT_LABELS[type] || type;
  }

  function renderResults(data) {
    // Data can be array (legacy) or object { journeys, gap }
    const journeys = Array.isArray(data) ? data : (data.journeys || []);

    // Clear local container as we are moving to Hub
    if (resultsContainer) resultsContainer.innerHTML = '';

    // Dispatch events for Vertical Hub and Map
    // We pass the full data object (or normalize if it was array)
    const eventDetail = Array.isArray(data) ? { journeys: data, gap: null } : data;

    window.dispatchEvent(new CustomEvent('SEARCH_COMPLETED', { detail: eventDetail }));
    // View State Change is now handled immediately on click

    if (window.showToast) {
        if (!journeys || journeys.length === 0) {
             window.showToast("No se encontraron rutas exactas", "info");
        } else {
             window.showToast(`${journeys.length} opciones encontradas`, 'success');
        }
    }
  }

  // Legacy render functions kept if needed for fallback or deleted to save space
  // For now we rely on VerticalHub.
  function renderDirectCard(journey) {
        const route = journey.legs[0];
        const badgesHtml = route.badges.map(b => `<span class="text-xs bg-slate-100 px-1 rounded">${b}</span>`).join('');

        let stopsPreview = `${route.origin_hub} ‚ûî ${route.dest_hub}`;
        if (route.stops && route.stops.length > 0) {
             stopsPreview = `${route.stops[0]} ‚ûî ${route.stops[route.stops.length - 1]}`;
        }

        const html = `
          <div class="p-4 bg-white rounded-lg shadow-sm border border-slate-100 active:scale-98 transition-transform mb-3 animate-slide-up">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mb-1">
                  ${getTransportLabel(route.transport_type)}
                </span>
                <h3 class="font-bold text-slate-800">${route.name}</h3>

                <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2 text-xs text-slate-600">
                    ${route.operator ? `
                    <div class="flex items-center gap-1">
                        <span>üöå</span> <span class="font-medium">${route.operator}</span>
                    </div>` : ''}
                    ${route.frequency ? `
                     <div class="flex items-center gap-1">
                        <span>‚è±Ô∏è</span> <span>${route.frequency}</span>
                    </div>` : ''}
                    ${route.schedule ? `
                     <div class="flex items-center gap-1">
                        <span>üïí</span> <span>${route.schedule}</span>
                    </div>` : ''}
                </div>

                <div class="flex gap-2 mt-2 flex-wrap">
                   ${badgesHtml}
                </div>
              </div>
              <div class="text-right ml-2 shrink-0">
                <span class="inline-flex items-center px-2 py-1 rounded bg-emerald-100 text-emerald-800 text-xs font-bold font-mono whitespace-nowrap">
                    üí∞ $${journey.total_price.toFixed(2)}
                </span>
                <p class="text-xs text-slate-500 mt-1">${route.duration}</p>

                <button class="mt-2 text-[10px] font-bold text-primary-600 border border-primary-200 bg-primary-50 px-2 py-1 rounded hover:bg-primary-100 transition-colors view-map-btn" data-journey='${JSON.stringify(journey)}'>
                    üó∫Ô∏è Ver en Mapa
                </button>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-slate-50 text-xs text-slate-500 flex items-center gap-1">
                <span>üìç</span> <span class="truncate">${stopsPreview}</span>
            </div>
          </div>
        `;
        resultsContainer.innerHTML += html;
  }

  function renderTransferCard(journey) {
      const leg1 = journey.legs[0];
      const leg2 = journey.legs[1];
      const transferPoint = journey.transfer_point;

      const html = `
          <div class="p-4 bg-white rounded-lg shadow-sm border border-slate-100 active:scale-98 transition-transform mb-3 animate-slide-up relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-blue-50 px-2 py-1 rounded-bl-lg text-[10px] font-bold text-blue-600 uppercase tracking-wider border-b border-l border-blue-100">
               üîÑ Transbordo Sugerido
            </div>

            <div class="flex flex-col gap-3 mt-4">
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0 w-8 text-center">
                        <span class="block text-[10px] font-bold text-slate-400 uppercase">Inicio</span>
                        <div class="h-8 w-0.5 bg-slate-200 mx-auto my-1"></div>
                    </div>
                    <div>
                         <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold bg-orange-100 text-orange-800 mb-0.5">
                            ${getTransportLabel(leg1.transport_type)}
                         </span>
                         <h4 class="font-bold text-slate-700 text-sm leading-tight">${leg1.name}</h4>
                    </div>
                </div>

                <div class="flex items-center gap-3 -mt-2">
                    <div class="flex-shrink-0 w-8 text-center flex justify-center">
                        <div class="w-2 h-2 rounded-full bg-blue-500 border-2 border-white shadow-sm ring-1 ring-blue-200"></div>
                    </div>
                    <div class="text-xs text-slate-500 font-medium bg-slate-50 px-2 py-1 rounded border border-slate-100">
                        Bajada en <span class="font-bold text-slate-700">${transferPoint}</span>
                    </div>
                </div>

                <div class="flex items-center gap-3 -mt-1">
                    <div class="flex-shrink-0 w-8 text-center">
                        <div class="h-8 w-0.5 bg-slate-200 mx-auto my-1"></div>
                        <span class="block text-[10px] font-bold text-slate-400 uppercase">Fin</span>
                    </div>
                    <div>
                         <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-800 mb-0.5">
                            ${getTransportLabel(leg2.transport_type)}
                         </span>
                         <h4 class="font-bold text-slate-700 text-sm leading-tight">${leg2.name}</h4>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-3 border-t border-slate-50 flex justify-between items-center">
                <span class="inline-flex items-center px-2 py-1 rounded bg-emerald-100 text-emerald-800 text-xs font-bold font-mono whitespace-nowrap">
                    üí∞ $${journey.total_price.toFixed(2)}
                </span>

                <button class="text-[10px] font-bold text-primary-600 border border-primary-200 bg-primary-50 px-2 py-1 rounded hover:bg-primary-100 transition-colors view-map-btn"
                    data-journey='${JSON.stringify(journey)}'>
                    üó∫Ô∏è Ver Ruta Completa
                </button>
            </div>
          </div>
      `;
      resultsContainer.innerHTML += html;
  }

  function renderWasmError() {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="p-6 bg-amber-50 rounded-xl border border-amber-200 text-center animate-slide-up">
            <div class="text-4xl mb-3">üì°</div>
            <h3 class="font-bold text-slate-800 mb-2">Modo Offline</h3>
            <p class="text-sm text-slate-600 mb-4">No se pudo cargar el motor de b√∫squeda. Verifica tu conexi√≥n para descargar rutas actualizadas.</p>
            <a href="/rutas" class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-700 hover:bg-slate-50 transition-colors shadow-sm">
               üìã Ver Rutas
            </a>
        </div>
    `;
  }

  function renderError(msg) {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="bg-red-50 p-4 rounded-xl border border-red-100 text-red-700 font-bold text-sm flex items-center gap-2 animate-slide-up">
            <img src="/icons/alert.svg" class="w-5 h-5" alt="Error" /> ${msg}
        </div>
    `;
    if (window.showToast) window.showToast(msg, 'error');
  }

</script>
