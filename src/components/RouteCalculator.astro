---
import Input from './ui/Input.astro';
import Badge from './ui/Badge.astro';
import SkeletonLoader from './ui/SkeletonLoader.astro';
---

<div class="route-calculator-panel glass-panel rounded-3xl p-5 space-y-4 w-full backdrop-blur-md bg-white/90 dark:bg-slate-800/90 border border-white/20 shadow-2xl transition-all duration-300">

    <!-- Header / Status Bar -->
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-black text-deep-navy dark:text-white tracking-tight text-lg title-text">
        ¬øA d√≥nde vamos?
      </h2>

      <div class="flex items-center gap-2">
        <div class="balance-badge-container hidden sm:block">
           <Badge variant="default" class="font-mono balance-badge">...</Badge>
        </div>
        <button class="lang-toggle text-[10px] font-bold bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-2 py-1 rounded-lg uppercase text-slate-500 dark:text-slate-300 hover:text-primary-500 transition-colors">EN</button>
      </div>
    </div>

    <div class="space-y-4">
      <!-- Alerts -->
      <div class="balance-warning hidden">
        <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-3 rounded-r-md flex items-start gap-3">
          <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
          <div>
            <p class="text-xs font-bold text-red-800 dark:text-red-300 uppercase tracking-wide">Saldo Insuficiente</p>
            <p class="text-xs text-red-600 dark:text-red-400 font-medium mt-1 warning-text">Requiere $180 MXN.</p>
          </div>
        </div>
      </div>

      <!-- Inputs -->
      <div class="space-y-3 relative">
        <div class="relative z-10">
          <div class="origin-input-wrapper">
              <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1 ml-1">Origen</label>
              <div class="relative">
                  <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                      <img src="/icons/map-pin.svg" class="w-5 h-5" alt="" />
                  </div>
                  <input type="text" class="origin-input w-full h-12 pl-10 pr-12 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-900 dark:text-white font-medium focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all" placeholder="¬øD√≥nde est√°s?" list="locations" />
                  <button class="gps-btn absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 hover:text-primary-500 transition-colors" title="Usar mi ubicaci√≥n">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                  </button>
              </div>
          </div>
        </div>

        <!-- Swap Button -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 mt-2 pointer-events-none lg:pointer-events-auto">
          <button class="swap-btn w-8 h-8 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-full flex items-center justify-center shadow-sm active:scale-95 transition-transform hover:bg-slate-50 pointer-events-auto text-slate-400 hover:text-primary-500">
             <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
          </button>
        </div>

        <div class="relative z-0">
           <div class="dest-input-wrapper">
              <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1 ml-1">Destino</label>
              <div class="relative">
                  <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                      <img src="/icons/flag.svg" class="w-5 h-5" alt="" />
                  </div>
                  <input type="text" class="dest-input w-full h-12 pl-10 pr-12 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-900 dark:text-white font-medium focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all" placeholder="¬øA d√≥nde vas?" list="locations" />
                  <button class="map-picker-btn absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 hover:text-primary-500 transition-colors" title="Seleccionar en mapa">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>
                  </button>
              </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions (Horizontal Scroll) -->
      <div>
        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x mask-fade-right">
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 dark:bg-slate-700/50 hover:bg-primary-50 hover:text-primary-600 dark:hover:text-primary-400 border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Walmart">
            <svg class="w-5 h-5 text-slate-500 dark:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
            <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Casa</span>
          </button>
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 dark:bg-slate-700/50 hover:bg-primary-50 hover:text-primary-600 dark:hover:text-primary-400 border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Plaza Las Am√©ricas">
            <svg class="w-5 h-5 text-slate-500 dark:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
            <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Trabajo</span>
          </button>
          <button class="quick-action-btn snap-start flex-shrink-0 bg-slate-50 dark:bg-slate-700/50 hover:bg-primary-50 hover:text-primary-600 dark:hover:text-primary-400 border border-slate-200 dark:border-slate-600 rounded-xl px-3 py-2 flex items-center gap-2 transition-colors active:scale-95" data-dest="Aeropuerto Terminal 2">
            <svg class="w-5 h-5 text-slate-500 dark:text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
            <span class="text-xs font-bold text-slate-600 dark:text-slate-300">Aero</span>
          </button>
        </div>
      </div>

      <!-- Options -->
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Pasajeros</label>
          <div class="relative">
            <select class="seats-input w-full h-[40px] bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-3 text-sm font-bold text-slate-700 dark:text-slate-200 appearance-none focus:ring-2 focus:ring-primary-100 focus:border-primary-500">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4+</option>
            </select>
            <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400 text-xs">‚ñº</div>
          </div>
        </div>
        <div>
          <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Modo</span>
          <label class="flex items-center h-[40px] bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl px-3 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition-colors">
            <input type="checkbox" class="tourist-checkbox w-4 h-4 rounded text-primary-500 border-gray-300 focus:ring-primary-500 mr-2" />
            <span class="text-sm font-bold text-slate-700 dark:text-slate-200">Turista</span>
          </label>
        </div>
      </div>

      <button class="search-btn w-full h-[50px] bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 text-white font-black text-lg rounded-2xl shadow-lg shadow-primary-500/30 flex items-center justify-center gap-2 active:scale-98 transition-all">
        <span class="btn-text">¬øComo llegar?</span>
        <img src="/icons/loader.svg" class="w-5 h-5 animate-spin hidden filter-white btn-spinner" alt="Loading" />
      </button>

    </div>

    <!-- Loading State -->
    <div class="calculation-loader hidden p-2 space-y-2">
        <SkeletonLoader height="h-20" />
        <SkeletonLoader height="h-10" />
    </div>

  <datalist id="locations">
    <option value="El Crucero Hub"></option>
    <option value="ADO Centro / Terminal"></option>
    <option value="Plaza Las Am√©ricas"></option>
    <option value="Aeropuerto Terminal 2"></option>
    <option value="Aeropuerto Terminal 4"></option>
    <option value="Muelle Ultramar (Puerto Ju√°rez)"></option>
    <option value="Playa Delfines (El Mirador)"></option>
    <option value="Playa del Carmen Centro"></option>
    <option value="Walmart"></option>
    <option value="Villas Otoch Para√≠so"></option>
    <option value="Hospital General (Av. Kabah)"></option>
  </datalist>

</div>

<script>
  import { openDB } from 'idb';

  const TRANSLATIONS = {
    es: {
      title: '¬øA d√≥nde vamos?',
      warning: 'Saldo insuficiente ($180 MXN).',
      calculate: '¬øComo llegar?',
      calculating: 'CALCULANDO...',
    },
    en: {
      title: 'Where to?',
      warning: 'Insufficient balance ($180 MXN).',
      calculate: 'How to get there?',
      calculating: 'ROUTING...',
    }
  };

  let currentLang = 'es';
  let balance = 0;
  let hasBalance = false;
  let wasmLoaded = false;
  let find_route, validate_operator_funds, analyze_gap_wasm, load_stops_data;
  let coordinatesDB = {};

  async function initWasm() {
    if(wasmLoaded) return;
    try {
      const wasmPath = new URL('/wasm/route-calculator/route_calculator.js', window.location.href).href;
      const module = await import(/* @vite-ignore */ wasmPath);
      await module.default();
      window.wasmModule = module;
      find_route = module.find_route;
      validate_operator_funds = module.validate_operator_funds;
      analyze_gap_wasm = module.analyze_gap;
      load_stops_data = module.load_stops_data;
      wasmLoaded = true;
      console.log("WASM initialized.");
    } catch (e) {
      console.error("WASM Error", e);
    }
  }

  async function loadCoordinates() {
      try {
          const res = await fetch('/coordinates.json');
          coordinatesDB = await res.json();
          if (wasmLoaded && load_stops_data) load_stops_data(coordinatesDB);
      } catch (e) { console.error("Coords Error", e); }
  }

  function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    var R = 6371;
    var dLat = deg2rad(lat2-lat1);
    var dLon = deg2rad(lon2-lon1);
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  function deg2rad(deg) { return deg * (Math.PI/180) }

  function resolveCoords(name) {
      if (!name) return null;
      if (coordinatesDB[name]) return coordinatesDB[name];
      const key = Object.keys(coordinatesDB).find(k => name.includes(k) || k.includes(name));
      return key ? coordinatesDB[key] : null;
  }

  async function updateBalance(panel) {
      // Balance logic is global usually, but we update specific panel elements
      // ... simplified for brevity, assume global update or per-panel
      try {
        const stored = localStorage.getItem('user_balance');
        balance = stored ? parseFloat(stored) : 180.0;
      } catch(e) { balance = 180.0; }

      hasBalance = (wasmLoaded && validate_operator_funds) ? validate_operator_funds(balance) : balance >= 180.0;

      const badge = panel.querySelector('.balance-badge');
      const warning = panel.querySelector('.balance-warning');
      const btn = panel.querySelector('.search-btn');

      if (badge) {
          badge.textContent = `$${balance.toFixed(0)}`;
          badge.className = hasBalance
            ? "balance-badge inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold font-mono bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400"
            : "balance-badge inline-flex items-center px-2 py-0.5 rounded-md text-xs font-bold font-mono bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400";
      }
      if (warning) warning.classList.toggle('hidden', hasBalance);
      if (btn) btn.disabled = !hasBalance;
  }

  function initPanel(panel) {
      const btn = panel.querySelector('.search-btn');
      const langToggle = panel.querySelector('.lang-toggle');
      const btnText = panel.querySelector('.btn-text');
      const btnSpinner = panel.querySelector('.btn-spinner');
      const loader = panel.querySelector('.calculation-loader');
      const originInput = panel.querySelector('.origin-input');
      const destInput = panel.querySelector('.dest-input');
      const swapBtn = panel.querySelector('.swap-btn');
      const gpsBtn = panel.querySelector('.gps-btn');
      const mapBtn = panel.querySelector('.map-picker-btn');
      const titleText = panel.querySelector('.title-text');

      // Sync Inputs across panels?
      // If user types in mobile, should desktop update? Yes ideally.
      // We can use CustomEvents or shared state. For now, independent is fine or simple sync.

      const updateText = () => {
          if(titleText) titleText.textContent = TRANSLATIONS[currentLang].title;
          if(btnText) btnText.textContent = TRANSLATIONS[currentLang].calculate;
          if(langToggle) langToggle.textContent = currentLang === 'es' ? 'EN' : 'ES';
      };

      langToggle?.addEventListener('click', () => {
          currentLang = currentLang === 'es' ? 'en' : 'es';
          updateText(); // Only updates this panel, need global event ideally
          // Dispatch global event
          window.dispatchEvent(new CustomEvent('LANG_CHANGE', { detail: currentLang }));
      });

      window.addEventListener('LANG_CHANGE', (e) => {
          if (e.detail !== currentLang) currentLang = e.detail;
          updateText();
      });

      swapBtn?.addEventListener('click', () => {
          const temp = originInput.value;
          originInput.value = destInput.value;
          destInput.value = temp;
      });

      // Quick Actions
      panel.querySelectorAll('.quick-action-btn').forEach(qBtn => {
          qBtn.addEventListener('click', (e) => {
              destInput.value = e.currentTarget.dataset.dest;
          });
      });

      gpsBtn?.addEventListener('click', () => {
          if (!navigator.geolocation) return;
          originInput.parentElement.classList.add('opacity-50', 'pointer-events-none');
          navigator.geolocation.getCurrentPosition((pos) => {
              const { latitude, longitude } = pos.coords;
              // Find nearest
              let nearest = '';
              let minDist = Infinity;
              Object.entries(coordinatesDB).forEach(([name, coords]) => {
                  const d = getDistanceFromLatLonInKm(latitude, longitude, coords[0], coords[1]);
                  if(d < minDist) { minDist = d; nearest = name; }
              });
              if(nearest) originInput.value = nearest;
              originInput.parentElement.classList.remove('opacity-50', 'pointer-events-none');
          }, () => {
              originInput.parentElement.classList.remove('opacity-50', 'pointer-events-none');
          });
      });

      mapBtn?.addEventListener('click', () => {
          sessionStorage.setItem('temp_origin', originInput.value);
          window.location.href = '/mapa?picker=destination';
      });

      // Check URL params (only for one panel, or both?)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('selected_stop') && sessionStorage.getItem('temp_origin')) {
           originInput.value = sessionStorage.getItem('temp_origin');
           destInput.value = urlParams.get('selected_stop');
           // Clear session storage only after loop?
           // It's okay, we can just set it.
      }

      btn?.addEventListener('click', async () => {
          if (!wasmLoaded) return;
          if (!hasBalance) return;

          const fromVal = originInput.value;
          const toVal = destInput.value;

          // Trigger Phase 3 (Tetris)
          window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 3 } }));

          // Immediate View Transition
          window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: { state: 'map' } }));

          if (btnText) btnText.textContent = TRANSLATIONS[currentLang].calculating;
          if (btnSpinner) btnSpinner.classList.remove('hidden');
          if (loader) loader.classList.remove('hidden');
          btn.disabled = true;

          try {
              gapRes = analyze_gap_wasm(originCoords[0], originCoords[1], destCoords[0], destCoords[1]);
          } catch(e) { console.warn("Gap Analysis failed", e); }
      }

      // Optimize search if Gap Analysis found a better nearby hub
      // But for now we stick to what the user sees in the input to avoid confusion
      const res = find_route(fromVal, toVal);

      console.log('Route Result:', res, 'Gap:', gapRes);

      // Pass both journeys and gap info
      renderResults({ journeys: res, gap: gapRes });
    } catch (error) {
      console.error(error);
      renderError("System Error: " + (error.message || error));
    } finally {
      if (btnText) btnText.textContent = TRANSLATIONS[currentLang].calculate;
      if (btnSpinner) btnSpinner.classList.add('hidden');
      if (calculationLoader) calculationLoader.classList.add('hidden');
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  const TRANSPORT_LABELS = {
    "Bus": "Autob√∫s",
    "Combi": "Combi",
    "Van": "Van / Colectivo",
    "ADO": "ADO",
    "PlayaExpress": "Playa Express",
  };

  function getTransportLabel(type) {
    return TRANSPORT_LABELS[type] || type;
  }

  function renderResults(data) {
    // Data can be array (legacy) or object { journeys, gap }
    const rawJourneys = Array.isArray(data) ? data : (data.journeys || []);
    const gap = Array.isArray(data) ? null : (data.gap || null);

    // Enrich journeys with GPS data if available
    const journeys = rawJourneys.map(j => {
        const leg0 = j.legs[0];
        // Try to get precise start name
        const startName = leg0.stops && leg0.stops.length > 0 ? leg0.stops[0] : leg0.origin_hub;

        let start_coords = null;
        let walking_distance_km = null;

        if (startName) {
            start_coords = resolveCoords(startName);
        }

        if (start_coords && realOriginCoords) {
             walking_distance_km = getDistanceFromLatLonInKm(
                 realOriginCoords[0], realOriginCoords[1],
                 start_coords[0], start_coords[1]
             );
        }

        return {
            ...j,
            start_coords,
            walking_distance_km
        };
    });

    // Clear local container as we are moving to Hub
    if (resultsContainer) resultsContainer.innerHTML = '';

    // Dispatch events for Vertical Hub and Map
    const eventDetail = { journeys, gap, userLocation: realOriginCoords };

    window.dispatchEvent(new CustomEvent('SEARCH_COMPLETED', { detail: eventDetail }));
    window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: { state: 'map' } }));

    if (window.showToast) {
        if (!journeys || journeys.length === 0) {
             window.showToast("No se encontraron rutas exactas", "info");
        } else {
             window.showToast(`${journeys.length} opciones encontradas`, 'success');
        }
    }
  }

  // Legacy render functions kept if needed for fallback or deleted to save space
  // For now we rely on VerticalHub.
  function renderDirectCard(journey) {
        const route = journey.legs[0];
        const badgesHtml = route.badges.map(b => `<span class="text-xs bg-slate-100 px-1 rounded">${b}</span>`).join('');

        let stopsPreview = `${route.origin_hub} ‚ûî ${route.dest_hub}`;
        if (route.stops && route.stops.length > 0) {
             stopsPreview = `${route.stops[0]} ‚ûî ${route.stops[route.stops.length - 1]}`;
        }

        const html = `
          <div class="p-4 bg-white rounded-lg shadow-sm border border-slate-100 active:scale-98 transition-transform mb-3 animate-slide-up">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mb-1">
                  ${getTransportLabel(route.transport_type)}
                </span>
                <h3 class="font-bold text-slate-800">${route.name}</h3>

                <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2 text-xs text-slate-600">
                    ${route.operator ? `
                    <div class="flex items-center gap-1">
                        <span>üöå</span> <span class="font-medium">${route.operator}</span>
                    </div>` : ''}
                    ${route.frequency ? `
                     <div class="flex items-center gap-1">
                        <span>‚è±Ô∏è</span> <span>${route.frequency}</span>
                    </div>` : ''}
                    ${route.schedule ? `
                     <div class="flex items-center gap-1">
                        <span>üïí</span> <span>${route.schedule}</span>
                    </div>` : ''}
                </div>

                <div class="flex gap-2 mt-2 flex-wrap">
                   ${badgesHtml}
                </div>
              </div>
              <div class="text-right ml-2 shrink-0">
                <span class="inline-flex items-center px-2 py-1 rounded bg-emerald-100 text-emerald-800 text-xs font-bold font-mono whitespace-nowrap">
                    üí∞ $${journey.total_price.toFixed(2)}
                </span>
                <p class="text-xs text-slate-500 mt-1">${route.duration}</p>

                <button class="mt-2 text-[10px] font-bold text-primary-600 border border-primary-200 bg-primary-50 px-2 py-1 rounded hover:bg-primary-100 transition-colors view-map-btn" data-journey='${JSON.stringify(journey)}'>
                    üó∫Ô∏è Ver en Mapa
                </button>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-slate-50 text-xs text-slate-500 flex items-center gap-1">
                <span>üìç</span> <span class="truncate">${stopsPreview}</span>
            </div>
          </div>
        `;
        resultsContainer.innerHTML += html;
  }

      // Init Balance
      updateBalance(panel);
  }

  // Master Init
  async function initAll() {
      await initWasm();
      await loadCoordinates();

      document.querySelectorAll('.route-calculator-panel').forEach(panel => {
          initPanel(panel);
      });
  }

  document.addEventListener('astro:page-load', initAll);
</script>

<style>
.filter-white { filter: brightness(0) invert(1); }
.mask-fade-right { -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%); mask-image: linear-gradient(to right, black 90%, transparent 100%); }
</style>
