---
import { getLangFromUrl, useTranslations, ui as uiTranslations } from '../utils/i18n';
import Input from './ui/Input.astro';
import Switch from './ui/Switch.astro';
import PassengerSelector from './ui/PassengerSelector.astro';

const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);
const ui = uiTranslations[currentLang];
---

<div class="calculator-wrapper">

  <!-- Search Card -->
  <div class="glass-card search-card" id="search-card">

    <!-- Header with Balance & Lang -->
    <div class="card-header">
      <div class="flex items-center gap-2">
         <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-primary-500" aria-hidden="true"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4S4 2.5 4 6v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg>
         <h2 class="text-sm font-black uppercase tracking-widest text-slate-800 dark:text-slate-200" data-i18n="calc.title">Route Finder</h2>
      </div>

      <div class="header-controls">
        <div class="balance-container">
            <span id="balance-badge" class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-slate-100 text-slate-600 font-mono" aria-live="polite">
                <span class="spinner" aria-hidden="true" style="width: 0.75rem; height: 0.75rem; border-width: 2px;"></span>
            </span>
        </div>

      </div>
    </div>

    <!-- Balance Warning -->

    <!-- Summary Bar (Hidden by default) -->
    <div id="summary-bar" class="summary-bar hidden">
       <div class="summary-info">
          <div class="summary-route">
              <div class="summary-point">
                  <div class="dot origin"></div>
                  <span id="summary-origin" class="summary-text">Origin</span>
              </div>
              <div class="connector"></div>
              <div class="summary-point">
                  <div class="dot dest"></div>
                  <span id="summary-dest" class="summary-text">Destination</span>
              </div>
          </div>
       </div>
       <button id="edit-search-btn" class="btn-edit" data-i18n="calc.edit" aria-label="Edit search">EDIT</button>
    </div>

    <!-- Form Area -->
    <div id="search-form" class="search-form">

      <!-- Inputs -->
      <div class="inputs-group">
        <div class="relative z-20">
          <Input
            id="origin-input"
            variant="floating"
            label="Origin"
            icon="/icons/map-pin.svg"
            placeholder="From where?"
            list="locations"
            aria-controls="locations"
            aria-expanded="false"
            data-i18n-label="calc.origin"
            data-i18n-placeholder="calc.placeholder.origin"
          >
            <!-- GPS Button inside Input -->
            <button slot="action" id="gps-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 hover:text-primary-500 transition-colors" style="anchor-name: --gps-btn" aria-describedby="gps-tooltip" aria-label="Use my location">
               <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V1h-2v2.06A8.994 8.994 0 003.06 11H1v2h2.06A8.994 8.994 0 0011 20.94V23h2v-2.06A8.994 8.994 0 0020.94 13H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
            </button>
            <div slot="action" id="gps-tooltip" class="graffiti-tooltip bottom" style="position-anchor: --gps-btn" data-i18n="calc.gps">Use my location</div>
          </Input>
        </div>

        <!-- Swap Button -->
        <div class="swap-btn-container">
          <button id="swap-btn" class="swap-btn" type="button" aria-label="Intercambiar origen y destino">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M16 17.01V10h-2v7.01h-3L15 21l4-3.99h-3zM9 3L5 6.99h3V14h2V6.99h3L9 3z"/></svg>
          </button>
        </div>

        <div class="relative z-0">
          <Input
            id="destination-input"
            variant="floating"
            label="Destination"
            icon="/icons/flag.svg"
            placeholder="Where to?"
            list="locations"
            aria-controls="locations"
            aria-expanded="false"
            data-i18n-label="calc.dest"
            data-i18n-placeholder="calc.placeholder.dest"
          >
            <button slot="action" id="map-picker-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-primary-500 transition-colors" style="anchor-name: --map-btn" aria-describedby="map-tooltip">
              <img src="/icons/map-plus.svg" class="w-5 h-5" alt="Map Picker" />
            </button>
            <div slot="action" id="map-tooltip" class="graffiti-tooltip top" style="position-anchor: --map-btn" data-i18n="calc.map">Select on map</div>
          </Input>
        </div>
      </div>

      <!-- Quick Actions -->
      <div>
        <div class="section-label mb-2" data-i18n="calc.quick">Quick Actions</div>
        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar snap-x">
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Walmart" data-i18n-html="calc.home" aria-label="Navigate home">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg> Home
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Plaza Las Am√©ricas" data-i18n-html="calc.work" aria-label="Navigate to work">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg> Work
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Aeropuerto Terminal 2" data-i18n-html="calc.airport" aria-label="Navigate to airport">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg> Airport
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Playa Delfines (El Mirador)" data-i18n-html="calc.beach" aria-label="Navigate to beach">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M13.127 14.56l1.43-1.43 6.44 6.443L19.57 21zm.68-6.2C14.9 9.46 16.34 10 18 10c.43 0 .84-.04 1.24-.11C18.77 8.61 17.47 7.74 16 7.24l-2.19 1.12zm-1.78 1.78l-2.12-2.12c-.56-.56-1.47-.56-2.03 0l-.71.71 2.83 2.83.71-.71c.55-.57.55-1.49.01-2.04l1.31.33zM2 20l3-3h9l-1.5-1.5-5.36-5.36-.71.71c-.56.56-1.47.56-2.03 0L2.58 9.03c-.56-.56-.56-1.47 0-2.03l.71-.71c.56-.56 1.47-.56 2.03 0l1.83 1.83 2.19-1.12C8.75 5.32 8.37 3.76 8.35 2H10c.16 1.97.79 3.71 1.82 5.12l2.12 2.12 6.36 6.36c.56.56.56 1.47 0 2.03l-.71.71c-.56.56-1.47.56-2.03 0l-1.83-1.83L13 20H2z"/></svg> Beach
          </button>
        </div>
      </div>


      <!-- Options -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <div class="section-label mb-1.5" style="font-size: 0.6rem;" data-i18n="calc.passengers">Passengers</div>
          <PassengerSelector id="seats-input" />
        </div>
        <div>
          <div class="section-label mb-1.5" style="font-size: 0.6rem;" data-i18n="calc.mode">Mode</div>
          <div class="h-[44px] flex items-center">
            <Switch id="tourist-checkbox" label="Tourist" data-i18n-label="calc.tourist" />
          </div>
        </div>
      </div>

      <button id="search-btn" class="btn-primary btn-lg w-full" disabled aria-label="Calculate route">
        <span id="btn-text" class="uppercase tracking-wider" data-i18n="calc.loading">Cargando rutas...</span>
        <span class="spinner" id="btn-spinner" aria-hidden="true"></span>
      </button>

    </div>

    <!-- Loading State (Skeleton Screens) -->
    <div id="calculation-loader" class="hidden p-5 space-y-3" style="border-top: 1px solid var(--border-light); background: var(--surface-bg);" aria-label="Loading results" role="status">
        <div class="skeleton h-6 w-2/3 rounded-lg"></div>
        <div class="skeleton h-24 rounded-xl"></div>
        <div class="skeleton h-12 rounded-xl"></div>
        <div class="skeleton h-12 rounded-xl"></div>
    </div>

  </div>

    <!-- Results Area -->
    <div id="results-info" class="mb-4 hidden animate-fade-in group" aria-live="polite">
        <div class="glass-card flex items-center justify-between px-4 py-3">
            <div class="flex flex-col">
                <span class="text-xxs font-black uppercase tracking-widest mb-0.5" style="color: var(--text-tertiary);" id="results-count-label" aria-live="polite"></span>
                <span class="badge-success font-mono" id="results-time-badge" aria-live="polite"></span>
            </div>
            
            <button id="toggle-list-btn" class="chip" aria-label="Toggle results list">
                <span class="text-xs font-bold" id="toggle-list-text" data-i18n="calc.toggle.hide">Hide</span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" id="toggle-list-icon" aria-hidden="true"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/></svg>
            </button>
        </div>
    </div>
    <div id="best-result-area" class="mb-6 space-y-4 empty:hidden">
        <!-- Best match card injected here -->
    </div>

    <div id="results-container" class="space-y-4 empty:hidden transition-all duration-500 origin-top">
        <!-- Other results injected here -->
    </div>

  <datalist id="locations">
    <option value="El Crucero Hub"></option>
    <option value="ADO Centro / Terminal"></option>
    <option value="Plaza Las Am√©ricas"></option>
    <option value="Aeropuerto Terminal 2"></option>
    <option value="Aeropuerto Terminal 4"></option>
    <option value="Muelle Ultramar (Puerto Ju√°rez)"></option>
    <option value="Playa Delfines (El Mirador)"></option>
    <option value="Playa del Carmen Centro"></option>
    <option value="Walmart"></option>
    <option value="Villas Otoch Para√≠so"></option>
    <option value="Hospital General (Av. Kabah)"></option>
  </datalist>

</div>

<div id="i18n-data" data-ui={JSON.stringify(ui)} class="hidden"></div>
<script>
  import { coordinatesStore } from '../utils/CoordinatesStore';
  import { CoordinateFinder } from '../utils/CoordinateFinder';
  import { escapeHtml } from "../utils/utils";
  import { getWalletBalance, setWalletBalance } from '../utils/db';
  import { getTransportLabel } from "../utils/transport";
  let currentLang = document.documentElement.lang || 'es';
  const i18nDataEl = document.getElementById('i18n-data');
  const ui = i18nDataEl ? JSON.parse(i18nDataEl.dataset.ui || '{}') : {};

  // DOM Elements
  const balanceBadge = document.getElementById('balance-badge');
  const searchBtn = document.getElementById('search-btn'); // Renamed from btn for clarity, but keeping logic
  const resultsContainer = document.getElementById('results-container');


  // Helpers

  // Security: Safe JSON Serialization for HTML Attributes
  // Prevents XSS via attribute injection (e.g. </button><script>)
  const safeJsonStringify = (obj) => {
      return JSON.stringify(obj)
          .replace(/</g, '\\u003c') // Escape < to prevent tag injection
          .replace(/'/g, "&#39;"); // Escape ' to prevent attribute breakout
  }

  // Sentinel Fix: Event Delegation for Map Buttons (Feature Fix + Security)
  if (typeof document !== 'undefined') {
      document.addEventListener('click', (e) => {
          const target = e.target;
          if (!target || !target.closest) return;

          const btn = target.closest('.view-map-btn');
          if (btn) {
              try {
                  const raw = btn.dataset.journey;
                  if (raw) {
                      const journey = JSON.parse(raw);
                      window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', { detail: { journey } }));
                      window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'MAP_ACTIVE' }));
                  }
              } catch (err) {
                  console.error("Invalid journey data", err);
              }
          }
      });
  }

  // State
  let balance = 0;
  let hasBalance = false;
  let wasmLoaded = false;
  let finder; // Global Coordinate Finder instance
  let find_route;
  let validate_operator_funds;
  let load_catalog;

  const btn = document.getElementById('search-btn');

  // --- Initialization ---

  async function updateBalance() {
    try {
        // Use IndexedDB (via db.ts) as the single source of truth
        const walletData = await getWalletBalance();
        if (walletData && walletData.amount !== undefined) {
            balance = walletData.amount;
            console.log("[RouteCalculator] Balance loaded from IndexedDB:", balance);
        } else {
            // Fallback: initialize to 180.0 if no balance found
            balance = 180.0;
            await setWalletBalance(balance);
            console.log("[RouteCalculator] Balance initialized to 180.0 in IndexedDB");
        }
    } catch (e) {
        console.warn("[RouteCalculator] IndexedDB Error, using default balance:", e);
        balance = 180.0;
    }

    if (wasmLoaded && typeof validate_operator_funds === 'function') {
        try {
            hasBalance = validate_operator_funds(balance);
        } catch (e) {
            console.warn("WASM validation failed, fallback to strict check", e);
            hasBalance = balance >= 180.0;
        }
    } else {
        hasBalance = balance >= 180.0;
    }

    if (balanceBadge) {
        balanceBadge.textContent = `$${balance.toFixed(0)}`;
        if (hasBalance) {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-green-100 text-green-700 font-mono";
        } else {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-red-100 text-red-700 font-mono";
        }
    }
  }

  // Listen for global balance updates
  window.addEventListener('BALANCE_UPDATED', () => {
      console.log("[RouteCalculator] Global balance update received");
      updateBalance();
  });



  async function start() {
    let jsonData = null;
    try {
      console.log("Initializing WASM...");
      const wasmPath = new URL('/wasm/route-calculator/route_calculator.js', window.location.href).href;
      const module = await import(/* @vite-ignore */ wasmPath);
      await module.default();
      find_route = module.find_route;
      validate_operator_funds = module.validate_operator_funds;
      load_catalog = module.load_catalog;

      console.log("WASM initialized.");
      wasmLoaded = true;

      // Load aggregated routes from API (Optimized)
      if (typeof load_catalog === 'function') {
        try {
          console.log("üì¶ Loading route catalog via CoordinatesStore...");
          
          // ‚úÖ SIM√ìN: Use CoordinatesStore to avoid redundant fetch
          console.time("WASM Load");
          const { text: catalogString, data: jsonData } = await coordinatesStore.init();

          // Sentinel: Enforce 10MB limit to prevent WASM DoS
          if (catalogString.length > 10 * 1024 * 1024) {
             throw new Error("Catalog too large (DoS protection)");
          }

          await load_catalog(catalogString);
          console.timeEnd("WASM Load");
          console.log("‚úÖ Catalog loaded into WASM:", jsonData.rutas?.length || 0, "routes");

          const searchBtn = document.getElementById("search-btn");
          const spinner = document.getElementById("btn-spinner");
          const txt = document.getElementById("btn-text");
          
          if (searchBtn) searchBtn.disabled = false;
          if (spinner) spinner.classList.add("hidden");
          if (txt) { txt.setAttribute("data-i18n", "calc.btn"); txt.textContent = "CALCULATE ROUTE"; }


        } catch (catalogError) {
          console.error("‚ùå Failed to load catalog:", catalogError);
          renderError("Error loading route data. Please refresh.");
        }
      }
    } catch (e) {
      console.error("WASM Load Critical Error:", e);
      renderWasmError();
    } finally {
      await updateBalance();
      // Initialize shared coordinates store and Finder
      try {
        await coordinatesStore.init(jsonData);
        const db = coordinatesStore.getDB();
        
        finder = new CoordinateFinder(db);
        console.log("Coordinate Finder Ready");
        
        // Setup Autocomplete
        setupAutocomplete('origin-input');
        setupAutocomplete('destination-input');

      } catch (e) {
        console.warn("GPS/Finder features might be unavailable", e);
      }
      initGPSLogic();
    }
  }

  function setupAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      const container = input?.parentElement; // Input wrapper
      if (!input || !container) return;

      // Create Dropdown Element (Native Popover)
      const list = document.createElement('ul');
      list.className = 'graffiti-dropdown divide-y divide-slate-50';
      list.id = `${inputId}-suggestions`;

      // GraffitiWarrior: Native Popover API
      try {
        list.popover = "auto";
      } catch (e) {
        console.warn("Popover API not fully supported, fallback behavior may be degraded.");
      }

      // GraffitiWarrior: CSS Anchor Positioning
      const anchorName = `--${inputId}`;
      input.style.setProperty('anchor-name', anchorName);
      list.style.setProperty('position-anchor', anchorName);

      container.appendChild(list);

      const updateList = () => {
          const val = input.value;
          if (!finder || val.length < 2) {
              try { list.hidePopover(); } catch(e) { list.style.display = 'none'; }
              return;
          }

          const results = finder.search(val, 6); // Limit to 6 suggestions
          
          if (results.length > 0) {
              list.innerHTML = '';
              results.forEach(res => {
                  const li = document.createElement('li');
                  li.className = 'px-4 py-3 hover:bg-slate-50 cursor-pointer transition-colors flex items-center gap-3 group';
                  li.innerHTML = `
                      <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-primary-50 group-hover:text-primary-500 transition-colors">
                          <span class="material-symbols-rounded text-base">location_on</span>
                      </div>
                      <div class="flex-1">
                          <p class="text-sm font-bold text-slate-700 group-hover:text-primary-700">${escapeHtml(res.name)}</p>
                          <p class="text-[10px] text-slate-500 font-mono">COORD: ${res.coords[0].toFixed(4)}, ${res.coords[1].toFixed(4)}</p>
                      </div>
                  `;
                  li.addEventListener('click', () => {
                      input.value = res.name;
                      try { list.hidePopover(); } catch(e) { list.style.display = 'none'; }
                      // Trigger any blur/update logic
                      input.dispatchEvent(new Event('blur'));
                  });
                  list.appendChild(li);
              });

              try {
                list.showPopover();
              } catch(e) {
                list.style.display = 'block';
              }
          } else {
              try { list.hidePopover(); } catch(e) { list.style.display = 'none'; }
          }
      };

      // Input Handler
      input.addEventListener('input', updateList);

      // Focus Handler (Re-open if valid)
      input.addEventListener('focus', updateList);
  }

  function initGPSLogic() {
      const gpsBtn = document.getElementById('gps-btn');
      if (!gpsBtn) return;

      gpsBtn.addEventListener('click', () => {
         if (!navigator.geolocation) {
             if (window.showToast) window.showToast(ui['error.no_gps'], 'error');
             return;
         }

         gpsBtn.classList.add('animate-pulse', 'text-primary-500');
         navigator.geolocation.getCurrentPosition(
             (pos) => {
                 const { latitude, longitude } = pos.coords;
                 const originInput = document.getElementById('origin-input');
                 if (originInput && finder) {
                     // Reverse Geocode or Find Nearest Stop
                     const nearest = coordinatesStore.findNearest(latitude, longitude);
                     if (nearest) {
                         originInput.value = nearest;
                         if (window.showToast) window.showToast(`GPS: ${nearest}`, 'success');
                     } else {
                         originInput.value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                     }
                 }
                 gpsBtn.classList.remove('animate-pulse');
             },
             (err) => {
                 console.error(err);
                 gpsBtn.classList.remove('animate-pulse', 'text-primary-500');
                 if (window.showToast) window.showToast("GPS Error", 'error');
             }
         );
      });
  }

  // --- Rendering Functions ---


  function renderBestResultHtml(journey, isBest = false) {
        const route = journey.legs[0];
        const badgesHtml = route.badges ? route.badges.map(b => `<span class="badge-primary" style="font-size: 0.5625rem;">${escapeHtml(b)}</span>`).join('') : '';

        let stopsPreview = `${escapeHtml(route.origin_hub)} ‚Üí ${escapeHtml(route.dest_hub)}`;
        if (route.stops && route.stops.length > 0) {
             stopsPreview = `${escapeHtml(route.stops[0])} ‚Üí ${escapeHtml(route.stops[route.stops.length - 1])}`;
        }

        // Sentinel Fix: Replace < with \u003c to prevent JSON-based HTML injection
        return `
          <div class="glass-card active:scale-[0.98] transition-all duration-300 mb-4 animate-slide-up relative overflow-hidden group hover:-translate-y-0.5 ${isBest ? 'ring-2 ring-primary-500/30' : ''}">
            ${isBest ? `<div class="absolute top-0 right-0 bg-primary-500 text-white text-xxs font-black px-3 py-1 rounded-bl-xl uppercase tracking-widest z-10">${ui['calc.best']}</div>` : ''}
            <div class="flex justify-between items-start">
              <div class="flex-1 min-w-0 pr-2">
                <span class="badge-primary mb-2">
                  ${escapeHtml(getTransportLabel(route.transport_type))}
                </span>
                <h3 class="font-display font-black text-base leading-tight tracking-tight group-hover:text-primary-500 transition-colors truncate" style="color: var(--text-primary);">${escapeHtml(route.name)}</h3>

                <div class="mt-2.5 flex flex-wrap gap-x-3 gap-y-1.5 text-xxs font-bold uppercase tracking-widest" style="color: var(--text-tertiary);">
                    ${route.operator ? `<div class="flex items-center gap-1"><span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">directions_bus</span> <span>${escapeHtml(route.operator)}</span></div>` : ''}
                    ${route.frequency ? `<div class="flex items-center gap-1"><span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">schedule</span> <span>${escapeHtml(route.frequency)}</span></div>` : ''}
                </div>

                <div class="flex gap-1.5 mt-3 flex-wrap">
                   ${badgesHtml}
                </div>
              </div>
              <div class="text-right shrink-0 flex flex-col items-end pl-3" style="border-left: 1px solid var(--border-light);">
                <span class="price-tag">
                    $${journey.total_price.toFixed(2)}
                </span>
                <p class="text-xxs font-black mt-2 uppercase tracking-tight" style="color: var(--text-tertiary);">${escapeHtml(route.duration)}</p>

                <button class="btn-primary btn-sm mt-3 whitespace-nowrap view-map-btn" data-journey='${safeJsonStringify(journey)}'>
                    <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">map</span> <span data-i18n="calc.results.map">${ui['calc.results.map'] || 'Ver Mapa'}</span>
                </button>
              </div>
            </div>
            <div class="mt-3 pt-3 text-xxs font-bold flex items-center gap-2 uppercase tracking-widest" style="border-top: 1px solid var(--border-light); color: var(--text-tertiary);">
                <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">near_me</span> <span class="truncate flex-1">${stopsPreview}</span>
            </div>
          </div>
        `;
  }

  function renderTransferCardHtml(journey, isBest = false) {
      const leg1 = journey.legs[0];
      const leg2 = journey.legs[1];
      const transferPoint = journey.transfer_point;

      // Sentinel Fix: Replace < with \u003c to prevent JSON-based HTML injection
      return `
          <div class="glass-card active:scale-[0.98] transition-all mb-3 animate-slide-up relative overflow-hidden group ${isBest ? 'ring-2 ring-primary-500/30' : ''}">
            <div class="absolute top-0 right-0 bg-accent-500 text-white px-3 py-1 rounded-bl-xl text-xxs font-black uppercase tracking-widest ${isBest ? 'mr-24' : ''}">
               ${ui['calc.transfer']}
            </div>
            ${isBest ? `<div class="absolute top-0 right-0 bg-primary-500 text-white text-xxs font-black px-3 py-1 rounded-bl-xl uppercase tracking-widest z-10">${ui['calc.best']}</div>` : ''}

            <div class="flex flex-col gap-3 mt-5">
                <!-- Leg 1 -->
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0 w-8 text-center">
                        <span class="w-3 h-3 rounded-full bg-success-500 border-2 border-white dark:border-slate-900 shadow-md mx-auto block"></span>
                        <div class="h-6 w-0.5 mx-auto my-0.5 rounded-full" style="background: var(--border-light);"></div>
                    </div>
                    <div>
                         <span class="badge-primary" style="font-size: 0.5rem;">
                            ${escapeHtml(getTransportLabel(leg1.transport_type))}
                         </span>
                         <h4 class="font-display font-black text-sm leading-tight tracking-tight" style="color: var(--text-primary);">${escapeHtml(leg1.name)}</h4>
                    </div>
                </div>

                <!-- Transfer point -->
                <div class="flex items-center gap-3 -mt-2">
                    <div class="flex-shrink-0 w-8 text-center flex justify-center">
                        <div class="w-2.5 h-2.5 rounded-full bg-accent-500 border-2 border-white dark:border-slate-900 shadow-md ring-2 ring-accent-500/20 animate-pulse"></div>
                    </div>
                    <div class="chip text-xxs">
                        <span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">sync_alt</span>
                        <span data-i18n="calc.results.transfer_at">${ui['calc.results.transfer_at'] || 'Transfer at'}</span> <span class="text-primary-500 font-black ml-1">${escapeHtml(transferPoint)}</span>
                    </div>
                </div>

                <!-- Leg 2 -->
                <div class="flex items-center gap-3 -mt-2">
                    <div class="flex-shrink-0 w-8 text-center">
                        <div class="h-6 w-0.5 mx-auto my-0.5 rounded-full" style="background: var(--border-light);"></div>
                        <span class="w-3 h-3 rounded-full bg-danger-500 border-2 border-white dark:border-slate-900 shadow-md mx-auto block"></span>
                    </div>
                    <div>
                         <span class="badge-accent" style="font-size: 0.5rem;">
                            ${escapeHtml(getTransportLabel(leg2.transport_type))}
                         </span>
                         <h4 class="font-display font-black text-sm leading-tight tracking-tight" style="color: var(--text-primary);">${escapeHtml(leg2.name)}</h4>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-3 flex justify-between items-center" style="border-top: 1px solid var(--border-light);">
                <span class="price-tag">
                    $${journey.total_price.toFixed(2)}
                </span>

                <button class="btn-primary btn-sm view-map-btn"
                    data-journey='${safeJsonStringify(journey)}'>
                    <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">map</span> <span data-i18n="calc.view_route">${ui['calc.view_route']}</span>
                </button>
            </div>
          </div>
      `;
  }

  function renderWasmError() {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card text-center animate-slide-up">
            <span class="material-symbols-rounded text-4xl mb-3 block" style="color: var(--text-tertiary); font-variation-settings: 'FILL' 1;">cloud_off</span>
            <h3 class="font-display font-black text-base mb-2" style="color: var(--text-primary);">${ui['calc.offline']}</h3>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">${ui['calc.offline_msg']}</p>
            <a href="/rutas" class="btn-secondary btn-sm inline-flex items-center gap-2">
               <span class="material-symbols-rounded text-sm">list_alt</span> ${ui['calc.view_all']}
            </a>
        </div>
    `;
  }

  function renderError(msg) {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card flex items-center gap-3 animate-slide-up" style="border-left: 3px solid var(--danger);">
            <span class="material-symbols-rounded text-danger-500 text-lg" style="font-variation-settings: 'FILL' 1;">error</span>
            <span class="font-bold text-sm" style="color: var(--danger);">${escapeHtml(msg)}</span>
        </div>
    `;
    if (window.showToast) window.showToast(msg, 'error');
  }

  function renderEmptyState() {
      if (!resultsContainer) return;
      resultsContainer.innerHTML = `
          <div class="glass-card text-center animate-slide-up py-8">
              <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <span class="material-symbols-rounded text-3xl text-slate-400" style="font-variation-settings: 'FILL' 1;">directions_off</span>
              </div>
              <h3 class="font-display font-black text-lg mb-2" style="color: var(--text-primary);" data-i18n="calc.no_route">${ui['calc.no_route'] || 'No routes found'}</h3>
              <p class="text-sm mb-6 max-w-[200px] mx-auto" style="color: var(--text-secondary);" data-i18n="calc.no_route_msg">
                  ${ui['calc.no_route_msg'] || 'Try changing your origin or destination, or walking to a main avenue.'}
              </p>
               <button class="btn-secondary btn-sm" onclick="document.getElementById('origin-input').focus()" data-i18n="calc.retry">
                  ${ui['calc.retry'] || 'Try Again'}
              </button>
          </div>
      `;
  }

  // --- Search Logic ---

  // --- Event Listeners ---

  function setupEventListeners() {
      // Swap Button Logic
      const swapBtn = document.getElementById('swap-btn');
      if (swapBtn) {
          const newSwapBtn = swapBtn.cloneNode(true);
          swapBtn.parentNode.replaceChild(newSwapBtn, swapBtn);

          newSwapBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log("Swap clicked!");
              const originInput = document.getElementById('origin-input');
              const destInput = document.getElementById('destination-input');
              if (originInput && destInput) {
                  console.log("Before swap:", originInput.value, destInput.value);
                  const temp = originInput.value;
                  originInput.value = destInput.value;
                  destInput.value = temp;
                  console.log("After swap:", originInput.value, destInput.value);

                  // Rotate animation
                  newSwapBtn.classList.toggle('rotated');

                  // Trigger input events
                  originInput.dispatchEvent(new Event('input'));
                  destInput.dispatchEvent(new Event('input'));
              }
          });
      }

      const btn = document.getElementById('search-btn');
      
      // Remove existing listener to prevent duplicates if any
      const newBtn = btn?.cloneNode(true);
      if (btn && newBtn) {
          btn.parentNode.replaceChild(newBtn, btn);
      }
      
      const searchButton = document.getElementById('search-btn');

      searchButton?.addEventListener('click', async () => {
          const originInput = document.getElementById('origin-input');
          const destInput = document.getElementById('destination-input');
          const origin = originInput?.value;
          const dest = destInput?.value;
          
          if (!origin || !dest) {
              renderError(ui?.['calc.error.empty'] || "Please fill in both fields");
              return;
          }

          const spinner = document.getElementById('btn-spinner');
          const btnText = document.getElementById('btn-text');
          const resultsContainer = document.getElementById('results-container');

          if (searchButton) searchButton.disabled = true;
          spinner?.classList.remove('hidden');

          btnText?.classList.add('hidden');
          
          // Clear previous results badges
          const countLabel = document.getElementById('results-count-label');
          if (countLabel) countLabel.textContent = '';
          const timeBadge = document.getElementById('results-time-badge');
          if (timeBadge) timeBadge.textContent = '';


          if (resultsContainer) resultsContainer.innerHTML = '';
          const bestResultArea = document.getElementById('best-result-area');
          if (bestResultArea) bestResultArea.innerHTML = '';
          document.getElementById('results-info')?.classList.add('hidden');

          try {
              if (!wasmLoaded || typeof find_route !== 'function') {
                  throw new Error("WASM not ready or find_route not defined");
              }

              console.log(`üîç Searching: ${origin} -> ${dest}`);
              const results = find_route(origin, dest); // Pass strings directly

              console.log("üîç Raw Results:", results);

              if (!results || results.length === 0) {
                  renderEmptyState();
              } else {
                 results.sort((a, b) => {
                     // Prioritize Direct routes
                     if (a.type === 'Direct' && b.type !== 'Direct') return -1;
                     if (b.type === 'Direct' && a.type !== 'Direct') return 1;
                     return a.total_price - b.total_price;
                 });

                 const best = results[0];
                 const others = results.slice(1);

                  // Prepare UI Data
                 const optionsLabel = ui['calc.results.options'] || 'OPCIONES';
                 const fastestLabel = ui['calc.results.fastest'] || 'M√ÅS R√ÅPIDA';
                 const countText = `${results.length} ${optionsLabel}`;
                 let timeText = '';
                 let showTimeBadge = false;

                 if (best) {
                     let duration = best.duration_minutes || 0;
                     timeText = `${fastestLabel}: ${duration}min`;
                     showTimeBadge = true;
                 }

                 // ATOMIC DOM UPDATE
                 const countLabel = document.getElementById('results-count-label');
                 const timeBadge = document.getElementById('results-time-badge');
                 
                 if (countLabel) countLabel.textContent = countText;
                 
                 if (timeBadge) {
                     timeBadge.textContent = timeText;
                     if (showTimeBadge) {
                         timeBadge.classList.remove('hidden');
                     } else {
                         timeBadge.classList.add('hidden');
                     }
                 }

                 // Show Info Bar NOW
                 document.getElementById('results-info')?.classList.remove('hidden');

                 // Render Cards
                 if (bestResultArea) {
                     if (best.type === 'Transfer') {
                         bestResultArea.innerHTML = renderTransferCardHtml(best, true);
                     } else {
                         bestResultArea.innerHTML = renderBestResultHtml(best, true);
                     }
                 }

                 if (others.length > 0 && resultsContainer) {
                     others.forEach(r => {
                         const div = document.createElement('div');
                         div.innerHTML = r.type === 'Transfer' ? renderTransferCardHtml(r) : renderBestResultHtml(r);
                         resultsContainer.appendChild(div.firstElementChild);
                     });
                 }
                 
                 // Re-attach map buttons
                 document.querySelectorAll('.view-map-btn').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                         try {
                             const journeyData = JSON.parse(btn.dataset.journey);
                             window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', {
                                detail: { journey: journeyData }
                             }));
                             // Also trigger view state change to map
                             window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'MAP_MAXIMIZED' }));
                         } catch (err) {
                             console.error("Error parsing journey data for map:", err);
                         }
                     });
                 });
              }

          } catch (e) {
              console.error("‚ùå Search Error:", e);
              renderError(`Error: ${e.message || "Calculation failed"}`);
          } finally {
              if (searchButton) searchButton.disabled = false;
              spinner?.classList.add('hidden');
              btnText?.classList.remove('hidden');
          }
      });
  }

  // Hook into start
  const originalStart = start;
  start = async function() {
      await originalStart(); // Run initialization
      setupEventListeners(); // Then setup listeners

      // Handle Query Params (e.g., from "Trazar Ruta Aqu√≠")
      const urlParams = new URLSearchParams(window.location.search);
      const selectedStop = urlParams.get('selected_stop');
      if (selectedStop) {
          const destInput = document.getElementById('destination-input');
          if (destInput) {
              destInput.value = selectedStop; // Already decoded by URLSearchParams
              destInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger floating label
              
              const originInput = document.getElementById('origin-input');
              if (originInput) originInput.focus(); // Focus origin to prompt user
          }
      }
  };

  document.addEventListener('astro:page-load', start);

</script>

<style>
  /* GraffitiWarrior: CSS Anchor Positioning Tooltips */
  .graffiti-tooltip {
    position: absolute;
    background: #1e293b; /* slate-800 */
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s cubic-bezier(0.16, 1, 0.3, 1), translate 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 50;
    white-space: nowrap;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  /* Position Logic */
  .graffiti-tooltip.bottom {
    top: anchor(bottom);
    right: anchor(right); /* Align right edges to prevent clipping */
    translate: 0 10px;
  }

  .graffiti-tooltip.top {
    bottom: anchor(top);
    right: anchor(right); /* Align right edges to prevent clipping */
    translate: 0 -10px;
  }

  /* Reveal Logic - Sibling Selector inside Slot */
  button:hover + .graffiti-tooltip,
  button:focus-visible + .graffiti-tooltip {
    opacity: 1;
    translate: 0 6px; /* Offset for bottom */
  }

  button:hover + .graffiti-tooltip.top,
  button:focus-visible + .graffiti-tooltip.top {
    translate: 0 -6px; /* Offset for top */
  }

  /* Swap Button Logic */
  .inputs-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    position: relative;
    isolation: isolate;
  }

  .swap-btn-container {
    position: absolute;
    inset-inline-end: 1rem;
    top: 50%;
    translate: 0 -50%;
    z-index: 30;
    pointer-events: none;
  }

  .swap-btn {
    pointer-events: auto;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 50%;
    background: var(--surface-elevated);
    border: 1px solid var(--border-light);
    box-shadow: var(--glass-shadow);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s, color 0.2s;
  }

  .swap-btn:hover {
    background-color: var(--surface-card);
    color: var(--color-primary);
    transform: scale(1.1);
  }

  .swap-btn:active {
    transform: scale(0.9);
  }

  .swap-btn.rotated {
    transform: rotate(180deg);
  }

  .swap-btn .material-symbols-rounded {
    font-size: 1.25rem;
  }
</style>

<style is:global>
  /*
   * GRAFFITI WARRIOR: Native Popover Dropdown
   * No Z-Index. No JS Positioning. Pure CSS5 Magic.
   */
  .graffiti-dropdown {
    /* Popover Reset */
    position: fixed; /* Explicit for anchor positioning */
    margin: 0;
    padding: 0;
    border: none;
    inset: auto; /* Reset default inset */

    /* Box Model */
    background: white;
    border: 1px solid #cbd5e1; /* slate-200 */
    border-radius: 0.75rem; /* rounded-xl */
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    max-height: 15rem;
    overflow-y: auto;
    z-index: 50; /* Fallback */

    /* Anchor Positioning Logic */
    top: anchor(bottom);
    left: anchor(left);
    width: anchor-size(width);
    translate: 0 0.5rem; /* mt-2 equivalent */

    /* Animation: Entry */
    opacity: 0;
    transform: translateY(-0.5rem);
    transition:
      opacity 0.2s ease-out,
      transform 0.2s cubic-bezier(0.16, 1, 0.3, 1),
      display 0.2s allow-discrete,
      overlay 0.2s allow-discrete;

    &:popover-open {
      opacity: 1;
      transform: translateY(0);
    }

    @starting-style {
      &:popover-open {
        opacity: 0;
        transform: translateY(-0.5rem);
      }
    }
  }

  /* Dark mode support if needed, but we stick to light for now as per design */
</style>
