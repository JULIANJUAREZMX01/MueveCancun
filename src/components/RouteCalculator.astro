---
const { class: className } = Astro.props;
---

<div class={`sunny-card p-6 animate-fade-in shadow-xl border-2 border-primary-100 ${className}`} id="route-calculator-container">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-display font-black text-deep-navy uppercase tracking-tighter" id="rc-title">
      üß≠ Br√∫jula Urbana
    </h2>
    <div class="flex items-center gap-3">
      <div id="pilot-balance-display" class="text-[10px] font-black px-2 py-1 rounded shadow-inner bg-gray-100 text-gray-500">
        Cargando...
      </div>
      <button id="lang-toggle" class="text-xs bg-gray-200 px-2 py-1 rounded font-black hover:bg-gray-300 transition-colors">
        EN
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div id="balance-error" class="hidden mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-xl text-red-800 text-xs font-black uppercase tracking-tight">
    ‚ö†Ô∏è Saldo insuficiente para activar Br√∫jula Urbana ($180 MXN req).
  </div>

  <!-- Controls -->
  <div class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 relative">
      <!-- Swap Button -->
      <button id="swap-btn" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 bg-white border border-gray-300 rounded-full p-2 shadow-sm hover:bg-gray-50 hover:scale-110 transition-all group hidden md:block" title="Intercambiar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 group-hover:text-primary-600 transition-colors">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
        </svg>
      </button>

      <div>
        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1" id="lbl-origin">üìç Origen</label>
        <input type="text" id="input-from" value="Walmart" class="w-full px-3 py-2 border-2 rounded-xl focus:ring-2 focus:ring-primary-500 border-gray-100 font-bold" list="locations" />
      </div>
      <div>
        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1" id="lbl-dest">üèÅ Destino</label>
        <input type="text" id="input-to" value="Aeropuerto T2" class="w-full px-3 py-2 border-2 rounded-xl focus:ring-2 focus:ring-primary-500 border-gray-100 font-bold" list="locations" />
      </div>
      
      <datalist id="locations">
        <option value="Crucero" />
        <option value="El Crucero" />
        <option value="ADO Centro" />
        <option value="ADO Canc√∫n Hub" />
        <option value="Coco Bongo" />
        <option value="Walmart" />
        <option value="Aeropuerto T2" />
        <option value="Plaza Las Am√©ricas" />
        <option value="Puerto Ju√°rez" />
        <option value="Playa del Carmen" />
        <option value="OXXO Villas Otoch Para√≠so" />
      </datalist>
    </div>

    <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-xl border border-gray-100">
      <div class="flex items-center space-x-2">
        <label for="seats-input" class="text-[10px] font-black uppercase text-gray-500 flex items-center gap-1">
          <img src="/icons/users.svg" class="w-3 h-3" alt="Seats" /> <span id="label-seats">Asientos</span>
        </label>
        <select id="seats-input" class="border rounded-md px-1 font-black bg-white">
          <option value="1" selected>1</option>
        <label class="text-[10px] font-black uppercase text-gray-500" id="lbl-seats">üí∫ Asientos</label>
        <select id="select-seats" class="border rounded-md px-1 font-black bg-white">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
      </div>
      <div class="flex items-center space-x-2">
        <input
          type="checkbox"
          id="tourist-checkbox"
          class="w-4 h-4 rounded text-primary-600 border-gray-300 focus:ring-primary-500"
        />
        <label for="tourist-checkbox" class="text-[10px] font-black uppercase text-gray-500 cursor-pointer flex items-center gap-1">
           <img src="/icons/palm-tree.svg" class="w-3 h-3" alt="Tourist" /> <span id="label-tourist">Turista</span>
        </label>
      </div>
    </div>

    <button
      id="calculate-btn"
      class="w-full premium-button py-4 text-xl disabled:opacity-50 disabled:cursor-not-allowed font-black uppercase tracking-tighter shadow-lg flex justify-center items-center gap-2"
    >
      <img src="/icons/loader.svg" class="w-5 h-5 animate-spin hidden" id="btn-spinner" alt="Loading" />
      <span id="btn-text">Trazar Ruta</span>
    </button>
  </div>

  <div id="results-container" class="hidden"></div>
</div>

<script>
  import init, { calculate_route, calculate_trip_cost } from '../wasm/route-calculator/route_calculator.js';
  import { openDB } from 'idb';

  const MOCK_GEO = {
    'El Crucero Hub': { lat: 21.1576, lng: -86.8269 },
    'ADO Centro / Terminal': { lat: 21.1586, lng: -86.8259 },
    'Plaza Las Am√©ricas': { lat: 21.1410, lng: -86.8430 },
    'Aeropuerto Terminal 2': { lat: 21.0417, lng: -86.8761 },
    'Aeropuerto Terminal 4': { lat: 21.0400, lng: -86.8750 },
    'Muelle Ultramar (Puerto Ju√°rez)': { lat: 21.2070, lng: -86.8020 },
    'Playa Delfines (El Mirador)': { lat: 21.0850, lng: -86.7750 },
    'Playa del Carmen Centro': { lat: 20.6296, lng: -87.0739 },
    'Walmart': { lat: 21.1595, lng: -86.8365 },
    'Villas Otoch Para√≠so': { lat: 21.1380, lng: -86.8650 },
    'Hospital General (Av. Kabah)': { lat: 21.1500, lng: -86.8400 },
  };

  const TRANSLATIONS = {
    es: {
      title: 'Br√∫jula Urbana',
      pilot: 'PILOTO:',
      warning: 'Saldo insuficiente para activar Br√∫jula Urbana ($180 MXN req).',
      origin: 'Origen',
      destination: 'Destino',
      seats: 'Asientos',
      tourist: 'Turista',
      calculate: 'Trazar Ruta',
      calculating: 'Calculando...',
      suggested: 'Conexi√≥n Sugerida',
      cashOnly: 'Pago en Efectivo',
      instructions: 'Instrucciones'
    },
    en: {
      title: 'Urban Compass',
      pilot: 'PILOT:',
      warning: 'Insufficient balance to activate Urban Compass ($180 MXN req).',
      origin: 'Origin',
      destination: 'Destination',
      seats: 'Seats',
      tourist: 'Tourist',
      calculate: 'Find Route',
      calculating: 'Calculating...',
      suggested: 'Suggested Connection',
      cashOnly: 'Cash Only',
      instructions: 'Instructions'
    }
  };

  let currentLang = 'es';
  let balance = 0;
  let hasBalance = false;
  let wasmLoaded = false;

  const btn = document.getElementById('calculate-btn');
  const resultsContainer = document.getElementById('results-container');
  const langToggle = document.getElementById('lang-toggle');
  const balanceAmount = document.getElementById('balance-amount');
  const balanceBadge = document.getElementById('balance-badge');
  const balanceWarning = document.getElementById('balance-warning');

  async function updateBalance() {
    const db = await openDB('cancunmueve-db', 2);
    let currentBalance = await db.get('wallet-status', 'driver_current');
    if (currentBalance === undefined) {
      currentBalance = 180.0;
      await db.put('wallet-status', currentBalance, 'driver_current');
    }
    balance = currentBalance;
    hasBalance = balance >= 180.0;

    if (balanceAmount) balanceAmount.textContent = balance.toFixed(0);

    if (balanceBadge) {
      balanceBadge.className = `text-[10px] font-black px-2 py-1 rounded shadow-inner ${hasBalance ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
    }

    if (balanceWarning) {
      balanceWarning.classList.toggle('hidden', hasBalance);
    }

    if (btn) (btn as HTMLButtonElement).disabled = !hasBalance || !wasmLoaded;
  }

  function updateUI() {
    const t = TRANSLATIONS[currentLang];
    const titleText = document.getElementById('title-text');
    if (titleText) titleText.textContent = t.title;

    const labelOrigin = document.getElementById('label-origin');
    if (labelOrigin) labelOrigin.textContent = t.origin;

    const labelDestination = document.getElementById('label-destination');
    if (labelDestination) labelDestination.textContent = t.destination;

    const labelSeats = document.getElementById('label-seats');
    if (labelSeats) labelSeats.textContent = t.seats;

    const labelTourist = document.getElementById('label-tourist');
    if (labelTourist) labelTourist.textContent = t.tourist;

    const btnText = document.getElementById('btn-text');
    if (btnText) btnText.textContent = t.calculate;

    const warningText = document.getElementById('warning-text');
    if (warningText) warningText.textContent = t.warning;

    if (langToggle) langToggle.textContent = currentLang === 'es' ? 'EN' : 'ES';
  }

  async function start() {
    try {
      console.log('üöÄ Initializing Route Calculator WASM...');
      // Pass the explicit public path to the WASM binary
      await init('/wasm/route-calculator/route_calculator_bg.wasm');
      wasmLoaded = true;
      console.log('‚úÖ WASM Module Loaded Successfully');

      await updateBalance();
      updateUI();
    } catch (e) {
      console.error("‚ùå WASM Load Critical Error:", e);
      if (document.getElementById('balance-warning')) {
        document.getElementById('balance-warning').classList.remove('hidden');
        document.getElementById('warning-text').textContent = "Error loading routing engine. Please refresh.";
      }
    }
  }

  langToggle?.addEventListener('click', () => {
    currentLang = currentLang === 'es' ? 'en' : 'es';
    updateUI();
  });

  // Swap functionality
  const swapBtn = document.getElementById('swap-btn');
  swapBtn?.addEventListener('click', () => {
     const origin = document.getElementById('origin-input');
     const dest = document.getElementById('destination-input');
     const temp = origin.value;
     origin.value = dest.value;
     dest.value = temp;
  });

  btn?.addEventListener('click', async () => {
    console.log('üñ±Ô∏è Calculate button clicked');

    if (!wasmLoaded) {
       console.warn('‚ö†Ô∏è WASM not loaded yet');
       return;
    }
    if (!hasBalance) {
       console.warn('‚ö†Ô∏è Insufficient balance');
       return;
    }

    const fromVal = (document.getElementById('origin-input') as HTMLInputElement).value;
    const toVal = (document.getElementById('destination-input') as HTMLInputElement).value;
    const seatsVal = parseInt((document.getElementById('seats-input') as HTMLSelectElement).value);
    const isTouristVal = (document.getElementById('tourist-checkbox') as HTMLInputElement).checked;

    console.log(`üìç Routing: ${fromVal} -> ${toVal}`);
        <input type="checkbox" id="check-tourist" class="w-4 h-4 rounded text-primary-600 border-gray-300" />
        <label for="check-tourist" class="text-[10px] font-black uppercase text-gray-500 cursor-pointer" id="lbl-tourist">üå¥ Turista</label>
      </div>
    </div>

    <button id="btn-calculate" class="w-full premium-button py-4 text-xl disabled:opacity-50 disabled:cursor-not-allowed font-black uppercase tracking-tighter shadow-lg">
      Trazar Ruta
    </button>
  </div>

  <!-- Results Container -->
  <div id="results-container" class="hidden mt-6 space-y-4 animate-slide-up bg-white p-5 rounded-2xl border-4 border-primary-500 shadow-2xl">
    <div class="flex justify-between items-start border-b pb-4">
      <div>
        <span class="text-[10px] uppercase font-black text-primary-600 tracking-widest" id="lbl-connection">Conexi√≥n Sugerida</span>
        <div id="result-routes" class="text-xl font-black text-deep-navy"></div>
      </div>
      <div class="text-right">
        <div id="result-cost" class="text-3xl font-black text-primary-600">$0</div>
        <div class="text-[10px] font-black text-gray-400 uppercase tracking-tighter leading-none" id="lbl-payment">Pago en Efectivo</div>
      </div>
    </div>

    <div id="airport-warning" class="hidden p-4 bg-red-50 border-2 border-red-200 rounded-xl text-red-700 text-[11px] font-black flex items-start gap-3 leading-tight shadow-sm">
      <span class="text-2xl">üö®</span>
      <p id="airport-warning-text"></p>
    </div>
    
    <div class="space-y-4">
      <h4 class="text-[10px] uppercase font-black text-gray-300 tracking-widest" id="lbl-instructions">Instrucciones</h4>
      <div id="result-instructions"></div>
    </div>

    <div id="result-info" class="pt-4 mt-2 border-t text-[10px] text-gray-400 font-black italic text-center uppercase tracking-widest">
    </div>
  </div>

  <!-- Error Container -->
  <div id="error-container" class="hidden mt-6 p-4 bg-red-50 text-red-700 rounded-xl border-2 border-red-100 font-black text-xs flex items-center gap-2 uppercase">
    <span>‚ùå</span>
    <span id="error-text"></span>
  </div>
</div>

<script>
  import { openDB } from 'idb';

  // Constants
  const MOCK_GEO = {
    'Crucero': { lat: 21.1619, lng: -86.8515 },
    'El Crucero': { lat: 21.1619, lng: -86.8515 },
    'ADO Centro': { lat: 21.1605, lng: -86.8260 },
    'ADO Canc√∫n Hub': { lat: 21.1605, lng: -86.8260 },
    'Coco Bongo': { lat: 21.1385, lng: -86.7474 },
    'Walmart': { lat: 21.1595, lng: -86.8365 },
    'Aeropuerto T2': { lat: 21.0412, lng: -86.8725 },
    'Plaza Las Am√©ricas': { lat: 21.1472, lng: -86.8234 },
    'Puerto Ju√°rez': { lat: 21.1850, lng: -86.8030 },
    'Playa del Carmen': { lat: 20.6296, lng: -87.0739 },
    'OXXO Villas Otoch Para√≠so': { lat: 21.1685, lng: -86.8850 }
  };

  // State
  let wasmModule = null;
  let hasSufficientBalance = false;
  let currentLang = 'es';

  // DOM Elements
  const el = (id) => document.getElementById(id);
  const els = {
    balanceDisplay: el('pilot-balance-display'),
    balanceError: el('balance-error'),
    inputFrom: el('input-from'),
    inputTo: el('input-to'),
    btnSwap: el('swap-btn'),
    btnCalculate: el('btn-calculate'),
    selectSeats: el('select-seats'),
    checkTourist: el('check-tourist'),
    resultsContainer: el('results-container'),
    errorContainer: el('error-container'),
    resultRoutes: el('result-routes'),
    resultCost: el('result-cost'),
    resultInstructions: el('result-instructions'),
    resultInfo: el('result-info'),
    airportWarning: el('airport-warning'),
    airportWarningText: el('airport-warning-text'),
    errorText: el('error-text'),
    langToggle: el('lang-toggle'),
  };

  // Initialize
  async function init() {
    try {
      // Load WASM
      // Note: We use the public URL for WASM in Astro islands/scripts
      // In vanilla script tag, we can dynamic import the JS file
      const wasm = await import(/* @vite-ignore */ '/wasm/route-calculator/route_calculator.js');
      await wasm.default();
      wasmModule = wasm;

      // Check Balance
      const db = await openDB('cancunmueve-db', 2, {
        upgrade(db) {
          if (!db.objectStoreNames.contains('wallet-status')) {
            db.createObjectStore('wallet-status');
          }
        },
      });

      let currentBalance = await db.get('wallet-status', 'driver_current');
      if (currentBalance === undefined || currentBalance === 0) {
        currentBalance = 180.0;
        await db.put('wallet-status', currentBalance, 'driver_current');
      }

      const balance = Number(currentBalance);
      hasSufficientBalance = balance >= 180.0;

      // Update UI
      if (hasSufficientBalance) {
        els.balanceDisplay.textContent = `PILOTO: ${balance.toFixed(0)} MXN`;
        els.balanceDisplay.classList.remove('bg-gray-100', 'text-gray-500');
        els.balanceDisplay.classList.add('bg-green-100', 'text-green-700');
        els.btnCalculate.disabled = false;
        els.balanceError.classList.add('hidden');
      } else {
        els.balanceDisplay.textContent = `PILOTO: ${balance.toFixed(0)} MXN`;
        els.balanceDisplay.classList.remove('bg-gray-100', 'text-gray-500');
        els.balanceDisplay.classList.add('bg-red-100', 'text-red-700');
        els.btnCalculate.disabled = true;
        els.balanceError.classList.remove('hidden');
      }

    } catch (error) {
      console.error('Initialization error:', error);
      els.balanceDisplay.textContent = 'Error';
    }
  }

  // Event Listeners
  els.btnSwap?.addEventListener('click', () => {
    const temp = els.inputFrom.value;
    els.inputFrom.value = els.inputTo.value;
    els.inputTo.value = temp;
  });

  els.langToggle?.addEventListener('click', () => {
    currentLang = currentLang === 'es' ? 'en' : 'es';
    els.langToggle.textContent = currentLang === 'es' ? 'EN' : 'ES';
    updateLabels();
  });

  els.btnCalculate?.addEventListener('click', async () => {
    if (!wasmModule || !hasSufficientBalance) return;

    els.btnCalculate.textContent = currentLang === 'es' ? 'Calculando...' : 'Calculating...';
    els.btnCalculate.disabled = true;
    els.resultsContainer.classList.add('hidden');
    els.errorContainer.classList.add('hidden');

    const fromVal = els.inputFrom.value;
    const toVal = els.inputTo.value;
    const seats = Number(els.selectSeats.value);
    const isTourist = els.checkTourist.checked;

    const fromCoords = MOCK_GEO[fromVal] || { lat: 21.1619, lng: -86.8515 };
    const toCoords = MOCK_GEO[toVal] || { lat: 21.0412, lng: -86.8725 };

    const btnText = document.getElementById('btn-text');
    const spinner = document.getElementById('btn-spinner');

    if (btnText) btnText.textContent = TRANSLATIONS[currentLang].calculating;
    if (spinner) spinner.classList.remove('hidden');
    (btn as HTMLButtonElement).disabled = true;

    try {
      console.log('üì° Fetching master_routes.json...');
      const response = await fetch('/data/master_routes.json');
      if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
      
      const routesData = await response.json();
      console.log('üì¶ Routes data loaded:', routesData.rutas?.length || 0, 'routes');

      const res = calculate_route(
    try {
      const response = await fetch('/data/master_routes.json');
      const routesData = await response.json();

      const res = wasmModule.calculate_route(
        fromCoords.lat,
        fromCoords.lng,
        toCoords.lat,
        toCoords.lng,
        routesData
      );

      console.log('‚úÖ Route calculation result:', res);

      if (res.success) {
        const costRes = calculate_trip_cost(res.distance_km, seatsVal, isTouristVal);
        renderResults(res, costRes);
      } else {
        renderError(res.error?.[currentLang] || "Unknown Error");
      }
    } catch (error) {
      console.error('‚ùå Calculation error:', error);
      renderError("Calculation error: " + error.message);
    } finally {
      if (btnText) btnText.textContent = TRANSLATIONS[currentLang].calculate;
      if (spinner) spinner.classList.add('hidden');
      (btn as HTMLButtonElement).disabled = false;
    }
  });

  function renderResults(res, cost) {
    if (!resultsContainer) return;
    const t = TRANSLATIONS[currentLang];

    resultsContainer.className = "mt-6 space-y-4 animate-slide-up bg-white p-5 rounded-2xl border-4 border-primary-500 shadow-2xl block";
    resultsContainer.innerHTML = `
      <div class="flex justify-between items-start border-b pb-4">
        <div>
          <span class="text-[10px] uppercase font-black text-primary-600 tracking-widest">${t.suggested}</span>
          <div class="text-xl font-black text-deep-navy">${res.routes.join(' ‚ûî ')}</div>
        </div>
        <div class="text-right">
          <div class="text-3xl font-black text-primary-600">$${cost.cost_mxn.toFixed(0)}</div>
          <div class="text-[10px] font-black text-gray-400 uppercase tracking-tighter leading-none">${t.cashOnly}</div>
        </div>
      </div>

      ${res.airport_warning ? `
        <div class="p-4 bg-red-50 border-2 border-red-200 rounded-xl text-red-700 text-[11px] font-black flex items-start gap-3 leading-tight shadow-sm">
          <span class="text-2xl">üö®</span>
          <p>${res.airport_warning[currentLang]}</p>
        </div>
      ` : ''}

      <div class="space-y-4">
        <h4 class="text-[10px] uppercase font-black text-gray-300 tracking-widest">${t.instructions}</h4>
        ${res.instructions.map((inst, idx) => `
          <div class="flex gap-4 text-sm font-black text-gray-800 items-start">
            <span class="flex-shrink-0 w-6 h-6 bg-deep-navy text-white rounded-full flex items-center justify-center text-[10px] font-black shadow-md border-2 border-primary-400">${idx + 1}</span>
            <span class="pt-0.5">${inst[currentLang]}</span>
          </div>
        `).join('')}
      </div>

      <div class="pt-4 mt-2 border-t text-[10px] text-gray-400 font-black italic text-center uppercase tracking-widest">
        ${cost.info[currentLang]}
      </div>
    `;
  }

  function renderError(msg) {
    if (!resultsContainer) return;
    resultsContainer.className = "mt-6 p-4 bg-red-50 text-red-700 rounded-xl border-2 border-red-100 font-black text-xs flex items-center gap-2 uppercase block";
    resultsContainer.innerHTML = `
      <span>‚ùå</span>
      <span>${msg}</span>
    `;
  }

  start();
      if (res.success) {
        const costRes = wasmModule.calculate_trip_cost(res.distance_km, seats, isTourist);
        renderResults(res, costRes);
      } else {
        renderError(res.error);
      }
    } catch (error) {
      console.error('Calculation error:', error);
      renderError({ es: 'Error de c√°lculo', en: 'Calculation error' });
    } finally {
      els.btnCalculate.textContent = currentLang === 'es' ? 'Trazar Ruta' : 'Find Route';
      els.btnCalculate.disabled = false;
    }
  });

  function renderResults(result, cost) {
    els.resultsContainer.classList.remove('hidden');
    els.resultRoutes.textContent = result.routes.join(' ‚ûî ');
    els.resultCost.textContent = `$${cost.cost_mxn.toFixed(0)}`;
    
    // Instructions
    els.resultInstructions.innerHTML = result.instructions.map((inst, idx) => `
      <div class="flex gap-4 text-sm font-black text-gray-800 items-start">
        <span class="flex-shrink-0 w-6 h-6 bg-deep-navy text-white rounded-full flex items-center justify-center text-[10px] font-black shadow-md border-2 border-primary-400">${idx + 1}</span>
        <span class="pt-0.5">${inst[currentLang]}</span>
      </div>
    `).join('');

    // Info
    els.resultInfo.textContent = cost.info[currentLang];

    // Airport Warning
    if (result.airport_warning) {
      els.airportWarning.classList.remove('hidden');
      els.airportWarningText.textContent = result.airport_warning[currentLang];
    } else {
      els.airportWarning.classList.add('hidden');
    }
  }

  function renderError(errorObj) {
    els.errorContainer.classList.remove('hidden');
    els.errorText.textContent = errorObj ? errorObj[currentLang] : 'Error desconocido';
  }

  function updateLabels() {
    el('rc-title').textContent = currentLang === 'es' ? 'üß≠ Br√∫jula Urbana' : 'üß≠ Urban Compass';
    el('lbl-origin').textContent = currentLang === 'es' ? 'üìç Origen' : 'üìç Origin';
    el('lbl-dest').textContent = currentLang === 'es' ? 'üèÅ Destino' : 'üèÅ Destination';
    el('lbl-seats').textContent = currentLang === 'es' ? 'üí∫ Asientos' : 'üí∫ Seats';
    el('lbl-tourist').textContent = currentLang === 'es' ? 'üå¥ Turista' : 'üå¥ Tourist';
    el('btn-calculate').textContent = currentLang === 'es' ? 'Trazar Ruta' : 'Find Route';
    // ... update other labels if needed
  }

  // Start
  init();

</script>
