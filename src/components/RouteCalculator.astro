---
import { ui } from '../lib/i18n';
import Input from './ui/Input.astro';
// Switch removed
import PassengerSelector from './ui/PassengerSelector.astro';

// Quick Access Items
const QUICK_ZONES = [
  { label: 'Canc√∫n', icon: 'beach_access' },
  { label: 'Pto. Morelos', icon: 'anchor' },
  { label: 'Riviera Maya', icon: 'nature_people' },
  { label: 'Aeropuerto', icon: 'flight' }
];
---

<div class="calculator-wrapper" id="route-calculator-wrapper">

  <div class="glass-card search-card" id="search-card">

    <!-- Collapsible Header -->
    <div id="card-header" class="card-header">
      <div class="header-controls">
        <div id="balance-badge-container" class="balance-container">
           <span class="price-tag" id="balance-badge">MOBI Card</span>
        </div>
        <button id="lang-toggle" class="lang-toggle">ES</button>
      </div>
    </div>

    <!-- Summary Bar (Initially Hidden) -->
    <div id="search-summary" class="summary-bar hidden">
        <div class="summary-info">
            <div class="summary-route">
               <div class="summary-point">
                  <span class="dot origin"></span>
                  <span id="summary-origin" class="summary-text" data-i18n="calc.origin">Origin</span>
               </div>
               <div class="connector"></div>
               <div class="summary-point">
                  <span class="dot dest"></span>
                  <span id="summary-dest" class="summary-text" data-i18n="calc.dest">Destination</span>
               </div>
            </div>
        </div>
        <button id="reset-search-btn" class="btn-edit" data-i18n="calc.reset">
            EDITAR
        </button>
    </div>

    <!-- Main Search Form -->
    <div id="search-form-container" class="search-form">
      <!-- Alerts -->
      <div id="alerts-container"></div>

      <div class="inputs-group">
          <!-- Origin Input -->
          <div class="input-wrapper group">
            <Input
              type="text"
              id="origin-input"
              name="origin"
              label="¬øD√≥nde est√°s?"
              placeholder="Ej. Villas Otoch, El Crucero..."
              icon="/icons/map-pin.svg"
            >
               <button type="button" slot="action" id="gps-btn" class="action-btn gps-btn" aria-label="Use GPS">
                  <span class="material-symbols-rounded">my_location</span>
               </button>
            </Input>
            <!-- Suggestions List -->
            <ul id="origin-suggestions" class="suggestions-list hidden"></ul>
          </div>

          <!-- Destination Input -->
          <div class="input-wrapper group">
             <Input
              type="text"
              id="dest-input"
              name="dest"
              label="¬øA d√≥nde vas?"
              placeholder="Ej. Zona Hotelera, Aeropuerto..."
              icon="/icons/flag.svg"
            >
               <button type="button" slot="action" id="map-picker-btn" class="action-btn map-btn" aria-label="Pick on Map">
                  <span class="material-symbols-rounded">map</span>
               </button>
            </Input>
            <!-- Suggestions List -->
            <ul id="dest-suggestions" class="suggestions-list hidden"></ul>
          </div>
      </div>

      <!-- Quick Access Zones -->
      <div class="quick-zones">
        {QUICK_ZONES.map(zone => (
            <button class="zone-chip" type="button" data-zone={zone.label}>
                <span class="material-symbols-rounded text-base">{zone.icon}</span>
                {zone.label}
            </button>
        ))}
      </div>

      <!-- Settings & Search -->
      <div class="settings-row">
        <!-- AC/WiFi Toggles Removed -->
        <div class="flex-1"></div> <!-- Spacer -->
        <PassengerSelector />
      </div>

      <button id="search-btn" class="btn-primary btn-lg w-full search-btn shadow-lg shadow-primary-500/30">
        <span class="material-symbols-rounded icon">search</span>
        <span data-i18n="calc.btn">Buscar Rutas</span>
      </button>

      <!-- Favorites Section (Hidden by default) -->
      <div id="favorites-section" class="hidden">
        <h4 class="section-label">Tus Rutas Favoritas</h4>
        <div id="favorites-list" class="favorites-grid">
           <!-- Items injected via JS -->
        </div>
      </div>

    </div>
  </div>

  <!-- Results Container -->
  <div id="results-container" class="results-container pb-24"></div>

</div>

<script>
  import { ui } from '../lib/i18n';
  import { favoritesStore } from '../lib/FavoritesStore';
  // Use relative import for WASM functions
  import init, { find_route, load_catalog } from '../wasm/route-calculator/route_calculator.js';

  // State
  let currentLang = 'es';
  let wasmLoaded = false;
  let catalogLoaded = false;
  let userLocation = null;
  let routeDataCache = []; // Store raw routes for autocomplete

  // DOM Elements
  const originInput = document.getElementById('origin-input');
  const destInput = document.getElementById('dest-input');
  const originSuggestions = document.getElementById('origin-suggestions');
  const destSuggestions = document.getElementById('dest-suggestions');
  const searchBtn = document.getElementById('search-btn');
  const resultsContainer = document.getElementById('results-container');
  const gpsBtn = document.getElementById('gps-btn');
  const mapPickerBtn = document.getElementById('map-picker-btn');
  const langToggle = document.getElementById('lang-toggle');
  const wrapper = document.getElementById('route-calculator-wrapper');

  // UI State Elements
  const searchCard = document.getElementById('search-card');
  const searchFormContainer = document.getElementById('search-form-container');
  const searchSummary = document.getElementById('search-summary');
  const cardHeader = document.getElementById('card-header');
  const resetSearchBtn = document.getElementById('reset-search-btn');
  const summaryOrigin = document.getElementById('summary-origin');
  const summaryDest = document.getElementById('summary-dest');
  const favoritesSection = document.getElementById('favorites-section');
  const favoritesList = document.getElementById('favorites-list');

  // Helper: Escape HTML
  function escapeHtml(unsafe) {
    if (unsafe === null || unsafe === undefined) return '';
    return String(unsafe)
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
  }

  // --- Initialization ---

  async function initWasm() {
    try {
      await init();
      console.log("WASM initialized.");
      wasmLoaded = true;

      // Load aggregated routes from API
      if (typeof load_catalog === 'function') {
        try {
          console.log("üì¶ Loading route catalog...");
          // Use the aggregated endpoint we created
          const response = await fetch('/api/master_routes.json');
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const catalogData = await response.json();
          // Store for autocomplete
          if (catalogData.rutas) {
             routeDataCache = catalogData.rutas;
          }

          const catalogString = JSON.stringify(catalogData);
          
          await load_catalog(catalogString);
          catalogLoaded = true;
          console.log("‚úÖ Catalog loaded into WASM:", catalogData.rutas?.length || 0, "routes");

          // Enable Search
          if (searchBtn) searchBtn.disabled = false;

        } catch (catalogError) {
          console.error("‚ùå Failed to load catalog:", catalogError);
          catalogLoaded = false;
          renderError("Error loading route data. Please refresh.");
        }
      }

    } catch (e) {
      console.error("Failed to init WASM:", e);
      renderWasmError();
    }
  }

  // Start init
  initWasm();
  renderFavorites();

  // Listen for favorites updates
  window.addEventListener('FAVORITES_UPDATED', () => renderFavorites());

  // --- Autocomplete Logic ---
  function setupAutocomplete(input, suggestionList) {
      if (!input || !suggestionList) return;

      input.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          if (query.length < 2) {
              suggestionList.classList.add('hidden');
              return;
          }

          // Search in route names and stops
          const suggestions = new Set();
          routeDataCache.forEach(route => {
              // Match route name
              if (route.nombre && route.nombre.toLowerCase().includes(query)) {
                  suggestions.add({ type: 'route', text: route.nombre });
              }
              // Match stops
              if (route.paradas) {
                  route.paradas.forEach(stop => {
                      const stopName = stop.nombre || stop.parada;
                      if (stopName && stopName.toLowerCase().includes(query)) {
                           suggestions.add({ type: 'stop', text: stopName });
                      }
                  });
              }
          });

          // Limit results
          const results = Array.from(suggestions).slice(0, 5);

          if (results.length > 0) {
              suggestionList.innerHTML = results.map(s => `
                  <li class="suggestion-item" data-val="${escapeHtml(s.text)}">
                    <span class="material-symbols-rounded icon-sm text-slate-400">
                        ${s.type === 'route' ? 'directions_bus' : 'location_on'}
                    </span>
                    ${escapeHtml(s.text)}
                  </li>
              `).join('');
              suggestionList.classList.remove('hidden');
          } else {
              suggestionList.classList.add('hidden');
          }
      });

      // Selection
      suggestionList.addEventListener('click', (e) => {
          const item = e.target.closest('.suggestion-item');
          if (item) {
              input.value = item.dataset.val;
              suggestionList.classList.add('hidden');
          }
      });

      // Hide on blur
      document.addEventListener('click', (e) => {
          if (!input.contains(e.target) && !suggestionList.contains(e.target)) {
              suggestionList.classList.add('hidden');
          }
      });
  }

  setupAutocomplete(originInput, originSuggestions);
  setupAutocomplete(destInput, destSuggestions);

  // Quick Zone Buttons
  document.querySelectorAll('.zone-chip').forEach(btn => {
      btn.addEventListener('click', () => {
          const zone = btn.dataset.zone;
          if (destInput) {
              destInput.value = zone;
              // Trigger search animation or focus
              destInput.focus();
          }
      });
  });

  // --- UI Logic ---

  function renderFavorites() {
    if (!favoritesList || !favoritesSection) return;

    const favorites = favoritesStore.getFavorites();
    if (favorites.length === 0) {
      favoritesSection.classList.add('hidden');
      return;
    }

    favoritesSection.classList.remove('hidden');
    favoritesList.innerHTML = favorites.map(fav => `
      <a href="/ruta/${fav.id}" class="favorite-item">
        <span class="material-symbols-rounded icon-sm text-primary">directions_bus</span>
        <span class="fav-name">${escapeHtml(fav.nombre)}</span>
      </a>
    `).join('');
  }

  // Language Toggle
  if (langToggle) {
    langToggle.addEventListener('click', () => {
      currentLang = currentLang === 'es' ? 'en' : 'es';
      langToggle.textContent = currentLang.toUpperCase();
      updateUIText();
    });
  }

  function updateUIText() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (ui[currentLang][key]) {
        el.textContent = ui[currentLang][key];
      }
    });
  }

  // Search Logic
  if (searchBtn) {
    searchBtn.addEventListener('click', async () => {
       if (!wasmLoaded || !catalogLoaded) {
           renderError(ui[currentLang]['calc.offline_msg']);
           return;
       }

       const origin = originInput.value.trim();
       const dest = destInput.value.trim();

       if (!origin || !dest) {
           renderError("Please enter both origin and destination.");
           return;
       }

       setLoading(true);

       // Simulate network/calc delay for UX
       await new Promise(r => setTimeout(r, 600));

       try {
           const results = find_route(origin, dest);
           renderResults(results);
           transitionToSummary(origin, dest);

           if (results && results.length > 0) {
              const bestJourney = results[0];
               window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', {
                 detail: {
                   journey: bestJourney,
                   userLocation: userLocation
                 }
               }));
           }

       } catch (e) {
           console.error("Search error:", e);
           renderError("Error calculating route. Try different stops.");
       } finally {
           setLoading(false);
       }
    });
  }

  // View State Transition (Search -> Summary)
  function transitionToSummary(origin, dest) {
      if (cardHeader) {
          cardHeader.style.height = '0';
          cardHeader.style.opacity = '0';
          cardHeader.style.overflow = 'hidden';
          cardHeader.style.padding = '0';
      }
      if (searchFormContainer) searchFormContainer.style.display = 'none';
      if (searchSummary) {
          searchSummary.classList.remove('hidden');
          if (summaryOrigin) summaryOrigin.textContent = origin;
          if (summaryDest) summaryDest.textContent = dest;
      }
      if (searchCard) searchCard.classList.add('collapsed');

      // Notify Home to hide Hero
      window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'MAP_ACTIVE' }));
  }

  // Reset Logic (Summary -> Search)
  if (resetSearchBtn) {
      resetSearchBtn.addEventListener('click', () => {
          if (cardHeader) {
              cardHeader.style.height = '';
              cardHeader.style.opacity = '';
              cardHeader.style.overflow = '';
              cardHeader.style.padding = '';
          }
          if (searchFormContainer) searchFormContainer.style.display = 'block';
          if (searchSummary) searchSummary.classList.add('hidden');
          if (resultsContainer) resultsContainer.innerHTML = '';
          if (searchCard) searchCard.classList.remove('collapsed');

          // Notify Home to show Hero
          window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'HOME' }));
      });
  }

  function setLoading(isLoading) {
      if (!searchBtn) return;
      if (isLoading) {
          searchBtn.innerHTML = '<span class="loader"></span> ' + ui[currentLang]['calc.calculating'];
          searchBtn.disabled = true;
      } else {
          searchBtn.innerHTML = '<span class="material-symbols-rounded icon">search</span> ' + ui[currentLang]['calc.btn'];
          searchBtn.disabled = false;
      }
  }

  // --- Rendering Results ---

  function renderResults(journeys) {
      if (!resultsContainer) return;
      resultsContainer.innerHTML = '';

      if (!journeys || journeys.length === 0) {
          renderError(ui[currentLang]['calc.no_routes']);
          return;
      }

      journeys.forEach((journey, index) => {
          const isBest = index === 0;
          let html = '';

          if (journey.type === 'Direct') {
              html = renderCardHtml(journey, isBest);
          } else {
              html = renderTransferCardHtml(journey, isBest);
          }

          const template = document.createElement('div');
          template.innerHTML = html.trim();
          const card = template.firstChild;

          const mapBtn = card.querySelector('.view-map-btn');
          if (mapBtn) {
             mapBtn.addEventListener('click', (e) => {
                 e.stopPropagation();
                 window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', {
                    detail: {
                       journey: journey,
                       userLocation: userLocation
                    }
                 }));
                 // Trigger View State Change
                 window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'MAP_MAXIMIZED' }));
             });
          }

          resultsContainer.appendChild(card);
      });
  }

  function getTransportLabel(type) {
      return type.replace('_', ' ');
  }

  function renderCardHtml(journey, isBest = false) {
        const route = journey.legs[0];
        const badgesHtml = (route.social_alerts || []).map(b => `<span class="badge-accent">${escapeHtml(b)}</span>`).join('');

        let stopsPreview = `${escapeHtml(route.origin_hub || '...')} ‚Üí ${escapeHtml(route.dest_hub || '...')}`;
        if (route.stops && route.stops.length > 0) {
             stopsPreview = `${escapeHtml(route.stops[0].nombre)} ‚Üí ${escapeHtml(route.stops[route.stops.length - 1].nombre)}`;
        }

        return `
          <div class="glass-card result-card ${isBest ? 'best' : ''} animate-slide-up">
            ${isBest ? `<div class="best-badge">${ui[currentLang]['calc.best']}</div>` : ''}

            <div class="result-row top">
              <div class="result-info">
                <span class="badge-primary mb-2">
                  ${escapeHtml(getTransportLabel(route.tipo || route.transport_type))}
                </span>
                <h3 class="result-title">${escapeHtml(route.nombre || route.name)}</h3>

                <div class="result-meta">
                    ${route.empresa ? `<div class="meta-item"><span class="material-symbols-rounded icon-sm">directions_bus</span> <span>${escapeHtml(route.empresa)}</span></div>` : ''}
                    ${route.frecuencia_minutos ? `<div class="meta-item"><span class="material-symbols-rounded icon-sm">schedule</span> <span>${escapeHtml(route.frecuencia_minutos)} min</span></div>` : ''}
                </div>

                <div class="result-badges">
                   ${badgesHtml}
                </div>
              </div>

              <div class="result-price-column">
                <span class="price-tag">
                    $${journey.total_price.toFixed(2)}
                </span>
                <p class="duration-text">${escapeHtml(route.duration || 'Calculando...')}</p>

                <button class="btn-primary btn-sm mt-3 view-map-btn">
                    <span class="material-symbols-rounded icon-sm">map</span> ${ui[currentLang]['calc.view_map']}
                </button>
              </div>
            </div>

            <div class="result-footer">
                <span class="material-symbols-rounded icon-sm">near_me</span>
                <span class="footer-text">${stopsPreview}</span>
            </div>
          </div>
        `;
  }

  function renderTransferCardHtml(journey, isBest = false) {
      const leg1 = journey.legs[0];
      const leg2 = journey.legs[1];
      const transferPoint = journey.transfer_point;

      return `
          <div class="glass-card result-card ${isBest ? 'best' : ''} animate-slide-up">
            <div class="transfer-badge ${isBest ? 'offset-best' : ''}">
               ${ui[currentLang]['calc.transfer']}
            </div>
            ${isBest ? `<div class="best-badge">${ui[currentLang]['calc.best']}</div>` : ''}

            <div class="transfer-legs">
                <!-- Leg 1 -->
                <div class="leg-row">
                    <div class="timeline-col">
                        <span class="dot-start"></span>
                        <div class="line"></div>
                    </div>
                    <div class="leg-info">
                         <span class="badge-primary small">
                            ${escapeHtml(getTransportLabel(leg1.tipo || leg1.transport_type))}
                         </span>
                         <h4 class="leg-title">${escapeHtml(leg1.nombre || leg1.name)}</h4>
                    </div>
                </div>

                <!-- Transfer point -->
                <div class="transfer-row">
                    <div class="timeline-col center">
                        <div class="dot-transfer"></div>
                    </div>
                    <div class="chip small">
                        <span class="material-symbols-rounded icon-xs">sync_alt</span>
                        Cambio en <span class="highlight">${escapeHtml(transferPoint)}</span>
                    </div>
                </div>

                <!-- Leg 2 -->
                <div class="leg-row">
                    <div class="timeline-col">
                        <div class="line"></div>
                        <span class="dot-end"></span>
                    </div>
                    <div class="leg-info">
                         <span class="badge-accent small">
                            ${escapeHtml(getTransportLabel(leg2.tipo || leg2.transport_type))}
                         </span>
                         <h4 class="leg-title">${escapeHtml(leg2.nombre || leg2.name)}</h4>
                    </div>
                </div>
            </div>

            <div class="result-footer-split">
                <span class="price-tag">
                    $${journey.total_price.toFixed(2)}
                </span>

                <button class="btn-primary btn-sm view-map-btn">
                    <span class="material-symbols-rounded icon-sm">map</span> ${ui[currentLang]['calc.view_route']}
                </button>
            </div>
          </div>
      `;
  }

  function renderWasmError() {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card result-card centered animate-slide-up">
            <span class="material-symbols-rounded icon-xl error-color">cloud_off</span>
            <h3 class="result-title">${ui[currentLang]['calc.offline']}</h3>
            <p class="error-text">${ui[currentLang]['calc.offline_msg']}</p>
        </div>
    `;
  }

  function renderError(msg) {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card error-card animate-slide-up">
            <span class="material-symbols-rounded icon-lg error-color">error</span>
            <span class="error-msg">${escapeHtml(msg)}</span>
        </div>
    `;
    if (window.showToast) window.showToast(msg, 'error');
  }

</script>

<style>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     Route Calculator Styles (CSS5)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  .calculator-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  /* ‚îÄ‚îÄ Search Card ‚îÄ‚îÄ */
  .search-card {
    position: relative;
    overflow: visible; /* For Suggestions */
    padding: 0 !important;
    transition: all 0.5s ease;
    background: var(--surface-card);
    backdrop-filter: blur(20px);
  }

  .search-card.collapsed {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .card-header {
    padding: var(--space-md);
    position: relative;
    min-height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-bottom: 1px solid var(--border-light);
    transition: all 0.3s ease;
  }

  .header-controls {
    position: absolute;
    right: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .balance-container {
    display: none;
  }
  @media (min-width: 640px) {
    .balance-container { display: block; }
  }

  .lang-toggle {
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    transition: background-color 0.2s;
    background: var(--surface-bg);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    cursor: pointer;
  }
  .lang-toggle:hover {
    background: var(--border-light);
  }

  /* ‚îÄ‚îÄ Summary Bar ‚îÄ‚îÄ */
  .summary-bar {
    padding: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: fadeIn 0.3s ease;
    z-index: 20;
    position: relative;
    background: var(--surface-card);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border-light);
  }

  .summary-bar.hidden {
    display: none;
  }

  .summary-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    overflow: hidden;
  }

  .summary-route {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .summary-point {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-weight: 700;
    color: var(--text-primary);
    overflow: hidden;
  }

  .summary-text {
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .connector {
    height: 0.75rem;
    border-left: 1px solid var(--border-light);
    margin-left: 0.25rem;
    margin-top: 0.125rem;
    margin-bottom: 0.125rem;
  }

  .dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 9999px;
    flex-shrink: 0;
  }
  .dot.origin { background-color: var(--color-success); }
  .dot.dest { background-color: var(--color-danger); }

  .btn-edit {
    font-size: 0.625rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary);
    background: var(--color-primary-light);
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-lg);
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    margin-left: 0.5rem;
    flex-shrink: 0;
  }
  .btn-edit:hover { filter: brightness(0.95); }

  /* ‚îÄ‚îÄ Search Form ‚îÄ‚îÄ */
  .search-form {
    padding: var(--space-xl);
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    transition: all 0.5s ease;
  }

  .inputs-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .input-wrapper {
    position: relative;
    z-index: 10;
  }

  /* Autocomplete Suggestions */
  .suggestions-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--surface-elevated);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    margin-top: 4px;
    padding: 4px;
    list-style: none;
    z-index: 100;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    max-height: 200px;
    overflow-y: auto;
  }
  .suggestions-list.hidden { display: none; }

  .suggestion-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    font-size: 0.875rem;
    color: var(--text-primary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.2s;
  }
  .suggestion-item:hover {
    background: var(--surface-bg);
  }

  /* Quick Zones */
  .quick-zones {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: -0.5rem;
  }
  .zone-chip {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background: var(--surface-bg);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .zone-chip:hover {
    background: var(--primary-light);
    color: var(--color-primary);
    border-color: var(--color-primary-light);
  }

  /* Action Buttons inside Input */
  .action-btn {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    width: 2rem;
    height: 2rem;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    background: transparent;
    color: var(--text-tertiary);
  }

  .action-btn:hover {
    background: var(--surface-bg);
    color: var(--color-primary);
  }

  .gps-btn:hover { color: var(--color-accent); }
  .map-btn:hover { color: var(--color-success); }

  /* Settings Row */
  .settings-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-md);
  }

  .search-btn {
    width: 100%;
    font-size: 1rem;
    padding: 0.875rem;
  }

  /* ‚îÄ‚îÄ Results Container ‚îÄ‚îÄ */
  .results-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  /* ‚îÄ‚îÄ Shared Animations ‚îÄ‚îÄ */
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
</style>
