---
import { getLangFromUrl, useTranslations } from '../lib/i18n';
import Input from './ui/Input.astro';
import Switch from './ui/Switch.astro';
import PassengerSelector from './ui/PassengerSelector.astro';

const currentLang = getLangFromUrl(Astro.url);
const ui = useTranslations(currentLang);
---

<div class="calculator-wrapper">

  <!-- Search Card -->
  <div class="glass-card search-card" id="search-card">

    <!-- Header with Balance & Lang -->
    <div class="card-header">
      <div class="flex items-center gap-2">
         <span class="material-symbols-rounded text-primary-500 text-xl">directions_bus</span>
         <h2 class="text-sm font-black uppercase tracking-widest text-slate-800" data-i18n="calc.title">Route Finder</h2>
      </div>

      <div class="header-controls">
        <div class="balance-container">
            <span id="balance-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-slate-100 text-slate-500 font-mono">
                LOADING...
            </span>
        </div>
        <button id="lang-toggle" class="lang-toggle">
            {currentLang === 'es' ? 'ES' : 'EN'}
        </button>
      </div>
    </div>

    <!-- Balance Warning -->
    <div id="balance-warning" class="hidden bg-red-50 p-3 text-center border-b border-red-100">
        <p class="text-xs font-bold text-red-600 flex items-center justify-center gap-2">
            <span class="material-symbols-rounded text-sm">warning</span>
            <span data-i18n="calc.insufficient">Insufficient Balance</span>
        </p>
    </div>

    <!-- Summary Bar (Hidden by default) -->
    <div id="summary-bar" class="summary-bar hidden">
       <div class="summary-info">
          <div class="summary-route">
              <div class="summary-point">
                  <div class="dot origin"></div>
                  <span id="summary-origin" class="summary-text">Origin</span>
              </div>
              <div class="connector"></div>
              <div class="summary-point">
                  <div class="dot dest"></div>
                  <span id="summary-dest" class="summary-text">Destination</span>
              </div>
          </div>
       </div>
       <button id="edit-search-btn" class="btn-edit" data-i18n="calc.edit">EDIT</button>
    </div>

    <!-- Form Area -->
    <div id="search-form" class="search-form">

      <!-- Inputs -->
      <div class="inputs-group">
        <div class="relative z-20">
          <Input
            id="origin-input"
            label="Origin"
            icon="/icons/map-pin.svg"
            placeholder="From where?"
            list="locations"
            aria-controls="locations"
            aria-expanded="false"
            data-i18n-label="calc.origin"
            data-i18n-placeholder="calc.placeholder.origin"
          />
          <!-- GPS Button inside Input -->
          <button slot="action" id="gps-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-primary-500 transition-colors" style="anchor-name: --gps-btn" aria-describedby="gps-tooltip">
             <span class="material-symbols-rounded text-lg">my_location</span>
          </button>
          <div slot="action" id="gps-tooltip" class="graffiti-tooltip bottom" style="position-anchor: --gps-btn" data-i18n="calc.gps">Use my location</div>
        </div>

        <!-- Swap Icon (Visual only for now) -->
        <div class="absolute left-8 top-1/2 -translate-y-1/2 z-10 hidden md:block">
          <button id="swap-btn" class="w-8 h-8 bg-slate-50 border border-slate-200 rounded-full flex items-center justify-center shadow-sm active:scale-95 transition-transform hover:bg-white text-slate-500">
            <img src="/icons/swap.svg" class="w-5 h-5 opacity-60" alt="Swap" />
          </button>
        </div>

        <div class="relative z-0">
          <Input
            id="destination-input"
            label="Destination"
            icon="/icons/flag.svg"
            placeholder="Where to?"
            list="locations"
            aria-controls="locations"
            aria-expanded="false"
            data-i18n-label="calc.dest"
            data-i18n-placeholder="calc.placeholder.dest"
          />
            <button slot="action" id="map-picker-btn" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full hover:bg-slate-100 text-slate-400 hover:text-primary-500 transition-colors" style="anchor-name: --map-btn" aria-describedby="map-tooltip">
              <img src="/icons/map-plus.svg" class="w-5 h-5" alt="Map Picker" />
            </button>
            <div slot="action" id="map-tooltip" class="graffiti-tooltip top" style="position-anchor: --map-btn" data-i18n="calc.map">Select on map</div>
          </Input>
        </div>
      </div>

      <!-- Quick Actions -->
      <div>
        <div class="section-label mb-2" data-i18n="calc.quick">Quick Actions</div>
        <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar snap-x">
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Walmart" data-i18n-html="calc.home">
            <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">home</span> Home
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Plaza Las Am√©ricas" data-i18n-html="calc.work">
            <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">work</span> Work
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Aeropuerto Terminal 2" data-i18n-html="calc.airport">
            <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">flight</span> Airport
          </button>
          <button class="quick-action-btn chip snap-start flex-shrink-0" data-dest="Playa Delfines (El Mirador)" data-i18n-html="calc.beach">
            <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">beach_access</span> Beach
          </button>
        </div>
      </div>


      <!-- Options -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <div class="section-label mb-1.5" style="font-size: 0.6rem;" data-i18n="calc.passengers">Passengers</div>
          <PassengerSelector id="seats-input" />
        </div>
        <div>
          <div class="section-label mb-1.5" style="font-size: 0.6rem;" data-i18n="calc.mode">Mode</div>
          <div class="h-[44px] flex items-center">
            <Switch id="tourist-checkbox" label="Tourist" data-i18n-label="calc.tourist" />
          </div>
        </div>
      </div>

      <button id="search-btn" class="btn-primary btn-lg w-full" disabled>
        <span id="btn-text" class="uppercase tracking-wider" data-i18n="calc.loading">Cargando rutas...</span>
        <span class="material-symbols-rounded text-lg animate-spin" id="btn-spinner">progress_activity</span>
      </button>

    </div>

    <!-- Loading State -->
    <div id="calculation-loader" class="hidden p-5 space-y-3" style="border-top: 1px solid var(--border-light); background: var(--surface-bg);">
        <div class="skeleton h-24 rounded-xl"></div>
        <div class="skeleton h-12 rounded-xl"></div>
        <div class="skeleton h-12 rounded-xl"></div>
    </div>

  </div>

    <!-- Results Area -->
    <div id="results-info" class="mb-4 hidden animate-fade-in group">
        <div class="glass-card flex items-center justify-between px-4 py-3">
            <div class="flex flex-col">
                <span class="text-xxs font-black uppercase tracking-widest mb-0.5" style="color: var(--text-tertiary);" id="results-count-label">0 OPCIONES</span>
                <span class="badge-success font-mono" id="results-time-badge">M√ÅS R√ÅPIDA: 12min</span>
            </div>
            
            <button id="toggle-list-btn" class="chip">
                <span class="text-xs font-bold" id="toggle-list-text" data-i18n="calc.toggle.hide">Hide</span>
                <span class="material-symbols-rounded text-sm" id="toggle-list-icon">expand_more</span>
            </button>
        </div>
    </div>
    <div id="best-result-area" class="mb-6 space-y-4 empty:hidden">
        <!-- Best match card injected here -->
    </div>

    <div id="results-container" class="space-y-4 empty:hidden transition-all duration-500 origin-top">
        <!-- Other results injected here -->
    </div>

  <datalist id="locations">
    <option value="El Crucero Hub"></option>
    <option value="ADO Centro / Terminal"></option>
    <option value="Plaza Las Am√©ricas"></option>
    <option value="Aeropuerto Terminal 2"></option>
    <option value="Aeropuerto Terminal 4"></option>
    <option value="Muelle Ultramar (Puerto Ju√°rez)"></option>
    <option value="Playa Delfines (El Mirador)"></option>
    <option value="Playa del Carmen Centro"></option>
    <option value="Walmart"></option>
    <option value="Villas Otoch Para√≠so"></option>
    <option value="Hospital General (Av. Kabah)"></option>
  </datalist>

</div>

<div id="i18n-data" data-ui={JSON.stringify(ui)} class="hidden"></div>
<script>
  import { openDB } from 'idb';
  import { coordinatesStore } from '../lib/CoordinatesStore';
  import { CoordinateFinder } from '../lib/CoordinateFinder';

  let currentLang = document.documentElement.lang || 'es';
  const i18nDataEl = document.getElementById('i18n-data');
  const ui = i18nDataEl ? JSON.parse(i18nDataEl.dataset.ui || '{}') : {};

  // DOM Elements
  const balanceBadge = document.getElementById('balance-badge');
  const balanceWarning = document.getElementById('balance-warning');
  const searchBtn = document.getElementById('search-btn'); // Renamed from btn for clarity, but keeping logic
  const resultsContainer = document.getElementById('results-container');
  const langToggle = document.getElementById('lang-toggle');

  // Helpers
  const escapeHtml = (unsafe) => {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
  }

  // Security: Safe JSON Serialization for HTML Attributes
  // Prevents XSS via attribute injection (e.g. </button><script>)
  const safeJsonStringify = (obj) => {
      return JSON.stringify(obj)
          .replace(/</g, '\\u003c') // Escape < to prevent tag injection
          .replace(/'/g, "&#39;"); // Escape ' to prevent attribute breakout
  }

  // State
  let balance = 0;
  let hasBalance = false;
  let wasmLoaded = false;
  let find_route, validate_operator_funds, load_stops_data, load_catalog;
  let finder; // Global Coordinate Finder instance

  const btn = document.getElementById('search-btn');

  // --- Initialization ---

  async function updateBalance() {
    try {
        const stored = localStorage.getItem('user_balance');
        if (stored !== null) {
            balance = parseFloat(stored);
        } else {
            balance = 180.0;
            localStorage.setItem('user_balance', balance.toString());
            console.log("Balance initialized to 180.0");
        }
    } catch (e) {
        console.warn("Storage Error, using default balance:", e);
        balance = 180.0;
    }

    if (wasmLoaded && typeof validate_operator_funds === 'function') {
        try {
            hasBalance = validate_operator_funds(balance);
        } catch (e) {
            console.warn("WASM validation failed, fallback to strict check", e);
            hasBalance = balance >= 180.0;
        }
    } else {
        hasBalance = balance >= 180.0;
    }

    if (balanceBadge) {
        balanceBadge.textContent = `$${balance.toFixed(0)}`;
        if (hasBalance) {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-green-100 text-green-700 font-mono";
        } else {
            balanceBadge.className = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold uppercase tracking-wide bg-red-100 text-red-700 font-mono";
        }
    }

    if (balanceWarning) {
      balanceWarning.classList.toggle('hidden', hasBalance);
    }

    if (btn) btn.disabled = !hasBalance;
  }

  function updateUI() {
    if (langToggle) langToggle.textContent = currentLang === 'es' ? 'ES' : 'EN';
  }

  async function start() {
    try {
      console.log("Initializing WASM...");
      const wasmPath = new URL('/wasm/route-calculator/route_calculator.js', window.location.href).href;
      const module = await import(/* @vite-ignore */ wasmPath);
      await module.default();
      find_route = module.find_route;
      validate_operator_funds = module.validate_operator_funds;
      load_stops_data = module.load_stops_data;
      load_catalog = module.load_catalog;

      console.log("WASM initialized.");
      wasmLoaded = true;

      // Load aggregated routes from API (Optimized)
      if (typeof load_catalog === 'function') {
        try {
          console.log("üì¶ Loading route catalog...");
          // Use static file
          const response = await fetch('/data/master_routes.json');
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          // ‚úÖ SIM√ìN: Bypass redundant parse-stringify cycle by fetching text
          console.time("WASM Load");
          const catalogString = await response.text();

          await load_catalog(catalogString);
          console.timeEnd("WASM Load");

          const jsonData = JSON.parse(catalogString); // Parse once for cache if needed
          console.log("‚úÖ Catalog loaded into WASM:", jsonData.rutas?.length || 0, "routes");
          
          const searchBtn = document.getElementById("search-btn");
          const spinner = document.getElementById("btn-spinner");
          const txt = document.getElementById("btn-text");
          
          if (searchBtn) searchBtn.disabled = false;
          if (spinner) spinner.classList.add("hidden");
          if (txt) { txt.setAttribute("data-i18n", "calc.btn"); txt.textContent = "CALCULATE ROUTE"; }
          updateUI(); // Ensure i18n text updates if needed

        } catch (catalogError) {
          console.error("‚ùå Failed to load catalog:", catalogError);
          renderError("Error loading route data. Please refresh.");
        }
      }
    } catch (e) {
      console.error("WASM Load Critical Error:", e);
      renderWasmError();
    } finally {
      await updateBalance();
      updateUI();

      // Initialize shared coordinates store and Finder
      try {
        await coordinatesStore.init();
        const db = coordinatesStore.getDB();
        
        // SYNC WITH WASM
        if (wasmLoaded && typeof load_stops_data === 'function') {
             console.log(`Sending ${Object.keys(db).length} stops to WASM`);
             load_stops_data(db);
             console.log("‚úÖ Coordinates synced to WASM");
        }


        finder = new CoordinateFinder(db);
        console.log("Coordinate Finder Ready");
        
        // Setup Autocomplete
        setupAutocomplete('origin-input');
        setupAutocomplete('destination-input');

      } catch (e) {
        console.warn("GPS/Finder features might be unavailable", e);
      }
      initGPSLogic();
    }
  }

  function setupAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      const container = input?.parentElement; // Input wrapper
      if (!input || !container) return;

      // Create Dropdown Element
      const list = document.createElement('ul');
      list.className = 'absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-xl shadow-xl z-50 mt-1 max-h-60 overflow-y-auto hidden divide-y divide-slate-50';
      list.id = `${inputId}-suggestions`;
      container.appendChild(list);

      // Input Handler
      input.addEventListener('input', (e) => {
          const val = e.target.value;
          if (!finder || val.length < 2) {
              list.classList.add('hidden');
              return;
          }

          const results = finder.search(val, 6); // Limit to 6 suggestions
          
          if (results.length > 0) {
              list.innerHTML = '';
              results.forEach(res => {
                  const li = document.createElement('li');
                  li.className = 'px-4 py-3 hover:bg-slate-50 cursor-pointer transition-colors flex items-center gap-3 group';
                  li.innerHTML = `
                      <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-primary-50 group-hover:text-primary-500 transition-colors">
                          <span class="material-symbols-rounded text-base">location_on</span>
                      </div>
                      <div class="flex-1">
                          <p class="text-sm font-bold text-slate-700 group-hover:text-primary-700">${escapeHtml(res.name)}</p>
                          <p class="text-[10px] text-slate-500 font-mono">COORD: ${res.coords[0].toFixed(4)}, ${res.coords[1].toFixed(4)}</p>
                      </div>
                  `;
                  li.addEventListener('click', () => {
                      input.value = res.name;
                      list.classList.add('hidden');
                      // Trigger any blur/update logic
                      input.dispatchEvent(new Event('blur'));
                  });
                  list.appendChild(li);
              });
              list.classList.remove('hidden');
          } else {
              list.classList.add('hidden');
          }
      });

      // Hide on blur (delayed to allow click)
      input.addEventListener('blur', () => {
          setTimeout(() => list.classList.add('hidden'), 200);
      });
  }

  function initGPSLogic() {
      const gpsBtn = document.getElementById('gps-btn');
      if (!gpsBtn) return;

      gpsBtn.addEventListener('click', () => {
         if (!navigator.geolocation) {
             if (window.showToast) window.showToast(ui[currentLang]['error.no_gps'], 'error');
             return;
         }

         gpsBtn.classList.add('animate-pulse', 'text-primary-500');
         navigator.geolocation.getCurrentPosition(
             (pos) => {
                 const { latitude, longitude } = pos.coords;
                 const originInput = document.getElementById('origin-input');
                 if (originInput && finder) {
                     // Reverse Geocode or Find Nearest Stop
                     const nearest = coordinatesStore.findNearest(latitude, longitude);
                     if (nearest) {
                         originInput.value = nearest;
                         if (window.showToast) window.showToast(`GPS: ${nearest}`, 'success');
                     } else {
                         originInput.value = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
                     }
                 }
                 gpsBtn.classList.remove('animate-pulse');
             },
             (err) => {
                 console.error(err);
                 gpsBtn.classList.remove('animate-pulse', 'text-primary-500');
                 if (window.showToast) window.showToast("GPS Error", 'error');
             }
         );
      });
  }

  // --- Rendering Functions ---

  function getTransportLabel(type) {
      if (!type) return 'Bus';
      if (type.includes('ADO')) return 'ADO';
      if (type.includes('Combi') || type.includes('Van')) return 'Combi';
      return 'Bus';
  }

  function renderBestResultHtml(journey, isBest = false) {
        const route = journey.legs[0];
        const badgesHtml = route.badges ? route.badges.map(b => `<span class="badge-primary" style="font-size: 0.5625rem;">${escapeHtml(b)}</span>`).join('') : '';

        let stopsPreview = `${escapeHtml(route.origin_hub)} ‚Üí ${escapeHtml(route.dest_hub)}`;
        if (route.stops && route.stops.length > 0) {
             stopsPreview = `${escapeHtml(route.stops[0])} ‚Üí ${escapeHtml(route.stops[route.stops.length - 1])}`;
        }

        return `
          <div class="glass-card active:scale-[0.98] transition-all duration-300 mb-4 animate-slide-up relative overflow-hidden group hover:-translate-y-0.5 ${isBest ? 'ring-2 ring-primary-500/30' : ''}">
            ${isBest ? `<div class="absolute top-0 right-0 bg-primary-500 text-white text-xxs font-black px-3 py-1 rounded-bl-xl uppercase tracking-widest z-10">${ui[currentLang]['calc.best']}</div>` : ''}
            <div class="flex justify-between items-start">
              <div class="flex-1 min-w-0 pr-2">
                <span class="badge-primary mb-2">
                  ${escapeHtml(getTransportLabel(route.transport_type))}
                </span>
                <h3 class="font-display font-black text-base leading-tight tracking-tight group-hover:text-primary-500 transition-colors truncate" style="color: var(--text-primary);">${escapeHtml(route.name)}</h3>

                <div class="mt-2.5 flex flex-wrap gap-x-3 gap-y-1.5 text-xxs font-bold uppercase tracking-widest" style="color: var(--text-tertiary);">
                    ${route.operator ? `<div class="flex items-center gap-1"><span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">directions_bus</span> <span>${escapeHtml(route.operator)}</span></div>` : ''}
                    ${route.frequency ? `<div class="flex items-center gap-1"><span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">schedule</span> <span>${escapeHtml(route.frequency)}</span></div>` : ''}
                </div>

                <div class="flex gap-1.5 mt-3 flex-wrap">
                   ${badgesHtml}
                </div>
              </div>
              <div class="text-right shrink-0 flex flex-col items-end pl-3" style="border-left: 1px solid var(--border-light);">
                <span class="price-tag">
                    $${journey.total_price.toFixed(2)}
                </span>
                <p class="text-xxs font-black mt-2 uppercase tracking-tight" style="color: var(--text-tertiary);">${escapeHtml(route.duration)}</p>

                <button class="btn-primary btn-sm mt-3 whitespace-nowrap view-map-btn" data-journey='${safeJsonStringify(journey)}'>
                    <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">map</span> ${ui[currentLang]['calc.view_map']}
                </button>
              </div>
            </div>
            <div class="mt-3 pt-3 text-xxs font-bold flex items-center gap-2 uppercase tracking-widest" style="border-top: 1px solid var(--border-light); color: var(--text-tertiary);">
                <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">near_me</span> <span class="truncate flex-1">${stopsPreview}</span>
            </div>
          </div>
        `;
  }

  function renderTransferCardHtml(journey, isBest = false) {
      const leg1 = journey.legs[0];
      const leg2 = journey.legs[1];
      const transferPoint = journey.transfer_point;

      return `
          <div class="glass-card active:scale-[0.98] transition-all mb-3 animate-slide-up relative overflow-hidden group ${isBest ? 'ring-2 ring-primary-500/30' : ''}">
            <div class="absolute top-0 right-0 bg-accent-500 text-white px-3 py-1 rounded-bl-xl text-xxs font-black uppercase tracking-widest ${isBest ? 'mr-24' : ''}">
               ${ui[currentLang]['calc.transfer']}
            </div>
            ${isBest ? `<div class="absolute top-0 right-0 bg-primary-500 text-white text-xxs font-black px-3 py-1 rounded-bl-xl uppercase tracking-widest z-10">${ui[currentLang]['calc.best']}</div>` : ''}

            <div class="flex flex-col gap-3 mt-5">
                <!-- Leg 1 -->
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0 w-8 text-center">
                        <span class="w-3 h-3 rounded-full bg-success-500 border-2 border-white dark:border-slate-900 shadow-md mx-auto block"></span>
                        <div class="h-6 w-0.5 mx-auto my-0.5 rounded-full" style="background: var(--border-light);"></div>
                    </div>
                    <div>
                         <span class="badge-primary" style="font-size: 0.5rem;">
                            ${escapeHtml(getTransportLabel(leg1.transport_type))}
                         </span>
                         <h4 class="font-display font-black text-sm leading-tight tracking-tight" style="color: var(--text-primary);">${escapeHtml(leg1.name)}</h4>
                    </div>
                </div>

                <!-- Transfer point -->
                <div class="flex items-center gap-3 -mt-2">
                    <div class="flex-shrink-0 w-8 text-center flex justify-center">
                        <div class="w-2.5 h-2.5 rounded-full bg-accent-500 border-2 border-white dark:border-slate-900 shadow-md ring-2 ring-accent-500/20 animate-pulse"></div>
                    </div>
                    <div class="chip text-xxs">
                        <span class="material-symbols-rounded text-xs" style="font-variation-settings: 'FILL' 1;">sync_alt</span>
                        Cambio en <span class="text-primary-500 font-black">${escapeHtml(transferPoint)}</span>
                    </div>
                </div>

                <!-- Leg 2 -->
                <div class="flex items-center gap-3 -mt-2">
                    <div class="flex-shrink-0 w-8 text-center">
                        <div class="h-6 w-0.5 mx-auto my-0.5 rounded-full" style="background: var(--border-light);"></div>
                        <span class="w-3 h-3 rounded-full bg-danger-500 border-2 border-white dark:border-slate-900 shadow-md mx-auto block"></span>
                    </div>
                    <div>
                         <span class="badge-accent" style="font-size: 0.5rem;">
                            ${escapeHtml(getTransportLabel(leg2.transport_type))}
                         </span>
                         <h4 class="font-display font-black text-sm leading-tight tracking-tight" style="color: var(--text-primary);">${escapeHtml(leg2.name)}</h4>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-3 flex justify-between items-center" style="border-top: 1px solid var(--border-light);">
                <span class="price-tag">
                    $${journey.total_price.toFixed(2)}
                </span>

                <button class="btn-primary btn-sm view-map-btn"
                    data-journey='${safeJsonStringify(journey)}'>
                    <span class="material-symbols-rounded text-sm" style="font-variation-settings: 'FILL' 1;">map</span> ${ui[currentLang]['calc.view_route']}
                </button>
            </div>
          </div>
      `;
  }

  function renderWasmError() {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card text-center animate-slide-up">
            <span class="material-symbols-rounded text-4xl mb-3 block" style="color: var(--text-tertiary); font-variation-settings: 'FILL' 1;">cloud_off</span>
            <h3 class="font-display font-black text-base mb-2" style="color: var(--text-primary);">${ui[currentLang]['calc.offline']}</h3>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">${ui[currentLang]['calc.offline_msg']}</p>
            <a href="/rutas" class="btn-secondary btn-sm inline-flex items-center gap-2">
               <span class="material-symbols-rounded text-sm">list_alt</span> ${ui[currentLang]['calc.view_all']}
            </a>
        </div>
    `;
  }

  function renderError(msg) {
    if (!resultsContainer) return;
    resultsContainer.innerHTML = `
        <div class="glass-card flex items-center gap-3 animate-slide-up" style="border-left: 3px solid var(--danger);">
            <span class="material-symbols-rounded text-danger-500 text-lg" style="font-variation-settings: 'FILL' 1;">error</span>
            <span class="font-bold text-sm" style="color: var(--danger);">${escapeHtml(msg)}</span>
        </div>
    `;
    if (window.showToast) window.showToast(msg, 'error');
  }

  // --- Search Logic ---

  // --- Event Listeners ---

  function setupEventListeners() {
      const btn = document.getElementById('search-btn');
      
      // Remove existing listener to prevent duplicates if any
      const newBtn = btn?.cloneNode(true);
      if (btn && newBtn) {
          btn.parentNode.replaceChild(newBtn, btn);
      }
      
      const searchButton = document.getElementById('search-btn');

      searchButton?.addEventListener('click', async () => {
          const originInput = document.getElementById('origin-input');
          const destInput = document.getElementById('destination-input');
          const origin = originInput?.value;
          const dest = destInput?.value;
          
          if (!origin || !dest) {
              renderError(ui[currentLang]?.['calc.error.empty'] || "Please fill in both fields");
              return;
          }

          const spinner = document.getElementById('btn-spinner');
          const btnText = document.getElementById('btn-text');
          const resultsContainer = document.getElementById('results-container');

          if (searchButton) searchButton.disabled = true;
          spinner?.classList.remove('hidden');
          btnText?.classList.add('hidden');
          
          if (resultsContainer) resultsContainer.innerHTML = '';
          const bestResultArea = document.getElementById('best-result-area');
          if (bestResultArea) bestResultArea.innerHTML = '';
          document.getElementById('results-info')?.classList.add('hidden');

          try {
              if (!wasmLoaded || typeof find_route !== 'function') {
                  throw new Error("WASM not ready or find_route not defined");
              }

              console.log(`üîç Searching: ${origin} -> ${dest}`);
              const results = find_route(origin, dest); // Pass strings directly

              console.log("üîç Raw Results:", results);

              if (!results || results.length === 0) {
                  renderError(ui[currentLang]?.['calc.error.no_route'] || "No route found");
              } else {
                 results.sort((a, b) => {
                     // Prioritize Direct routes
                     if (a.type === 'Direct' && b.type !== 'Direct') return -1;
                     if (b.type === 'Direct' && a.type !== 'Direct') return 1;
                     return a.total_price - b.total_price;
                 });

                 const best = results[0];
                 const others = results.slice(1);

                 const countLabel = document.getElementById('results-count-label');
                 if (countLabel) countLabel.textContent = `${results.length} ${currentLang === 'es' ? 'OPCIONES' : 'OPTIONS'}`;
                 
                 document.getElementById('results-info')?.classList.remove('hidden');

                 if (bestResultArea) {
                     if (best.type === 'Transfer') {
                         bestArea.innerHTML = renderTransferCardHtml(best, true);
                     } else {
                         bestArea.innerHTML = renderBestResultHtml(best, true);
                     }
                 }

                 if (others.length > 0 && resultsContainer) {
                     others.forEach(r => {
                         const div = document.createElement('div');
                         div.innerHTML = r.type === 'Transfer' ? renderTransferCardHtml(r) : renderBestResultHtml(r);
                         resultsContainer.appendChild(div.firstElementChild);
                     });
                 }
                 
                 // Re-attach map buttons
                 document.querySelectorAll('.view-map-btn').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                         try {
                             const journeyData = JSON.parse(btn.dataset.journey);
                             window.dispatchEvent(new CustomEvent('SHOW_ROUTE_ON_MAP', {
                                detail: { journey: journeyData }
                             }));
                             // Also trigger view state change to map
                             window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'MAP_MAXIMIZED' }));
                         } catch (err) {
                             console.error("Error parsing journey data for map:", err);
                         }
                     });
                 });
              }

          } catch (e) {
              console.error("‚ùå Search Error:", e);
              renderError(`Error: ${e.message || "Calculation failed"}`);
          } finally {
              if (searchButton) searchButton.disabled = false;
              spinner?.classList.add('hidden');
              btnText?.classList.remove('hidden');
          }
      });
  }

  // Hook into start
  const originalStart = start;
  start = async function() {
      await originalStart(); // Run initialization
      setupEventListeners(); // Then setup listeners
  };

  document.addEventListener('astro:page-load', start);

</script>

<style>
  /* GraffitiWarrior: CSS Anchor Positioning Tooltips */
  .graffiti-tooltip {
    position: absolute;
    background: #1e293b; /* slate-800 */
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s cubic-bezier(0.16, 1, 0.3, 1), translate 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 50;
    white-space: nowrap;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  /* Position Logic */
  .graffiti-tooltip.bottom {
    top: anchor(bottom);
    right: anchor(right); /* Align right edges to prevent clipping */
    translate: 0 10px;
  }

  .graffiti-tooltip.top {
    bottom: anchor(top);
    right: anchor(right); /* Align right edges to prevent clipping */
    translate: 0 -10px;
  }

  /* Reveal Logic - Sibling Selector inside Slot */
  button:hover + .graffiti-tooltip,
  button:focus-visible + .graffiti-tooltip {
    opacity: 1;
    translate: 0 6px; /* Offset for bottom */
  }

  button:hover + .graffiti-tooltip.top,
  button:focus-visible + .graffiti-tooltip.top {
    translate: 0 -6px; /* Offset for top */
  }
</style>
