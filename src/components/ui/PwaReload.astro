---
// GraffitiWarrior: PWA Reload Component
// Uses Popover API for native visibility management and @starting-style for entry animation.
---

<div id="pwa-toast" popover="manual" class="pwa-toast">
  <div class="toast-content">
    <div class="toast-info">
      <h4 class="toast-title" data-i18n="pwa.update">Actualización disponible</h4>
      <p class="toast-desc" data-i18n="pwa.new_version">Nueva versión lista.</p>
    </div>
    <button id="pwa-refresh-btn" class="toast-action" data-i18n="pwa.refresh">
      ACTUALIZAR
    </button>
  </div>
</div>

<style>
  /*
   * GRAFFITI WARRIOR: CSS5
   * Native Popover + @starting-style
   */
  .pwa-toast {
    /* Position fixed at bottom (Toast behavior) */
    position: fixed;
    bottom: 1.5rem; /* 6 (1.5rem) on desktop, adjusted via media query */
    left: 1rem;
    right: 1rem;
    margin: 0 auto;
    max-width: 28rem; /* max-w-md */
    z-index: 50; /* Fallback for older browsers, but Popover is Top Layer */

    background: transparent;
    border: none;
    padding: 0;
    overflow: visible;

    /* Animation State: Open (Final) */
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.4s ease-out, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), display 0.4s allow-discrete, overlay 0.4s allow-discrete;

    /* Animation State: Closed (Starting Style for Entry) */
    @starting-style {
      opacity: 0;
      transform: translateY(100%);
    }

    /* Animation State: Closed (Exit) */
    &:not(:popover-open) {
      opacity: 0;
      transform: translateY(100%);
      display: none;
    }
  }

  /* Mobile Adjustments */
  @media (max-width: 768px) {
    .pwa-toast {
      bottom: 6rem; /* Above bottom nav */
    }
  }

  .toast-content {
    /* Glassmorphism */
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);

    border-radius: 1rem; /* rounded-2xl */
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  :global(.dark) .toast-content {
    background: rgba(15, 23, 42, 0.95); /* slate-900 */
    border-color: rgba(255, 255, 255, 0.1);
    color: white;
  }

  .toast-info {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .toast-title {
    font-size: 0.875rem; /* text-sm */
    font-weight: 700;
    margin: 0;
    color: var(--text-primary, #0f172a);
  }

  :global(.dark) .toast-title {
    color: #f1f5f9;
  }

  .toast-desc {
    font-size: 0.75rem; /* text-xs */
    margin: 0;
    color: var(--text-secondary, #64748b);
  }

  :global(.dark) .toast-desc {
    color: #94a3b8;
  }

  .toast-action {
    background: var(--color-primary, #F97316);
    color: white;
    font-size: 0.75rem; /* text-xs */
    font-weight: 800;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem; /* rounded-lg */
    border: none;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
    white-space: nowrap;
  }

  .toast-action:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
  }

  .toast-action:active {
    transform: translateY(0) scale(0.95);
  }
</style>

<script>
  // GraffitiWarrior: PWA Logic
  // Listens for SW updates and triggers the native popover

  function initPWA() {
    if ('serviceWorker' in navigator) {
      const toast = document.getElementById('pwa-toast');
      const btn = document.getElementById('pwa-refresh-btn');

      if (!toast || !btn) return;

      // Register SW
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(reg => {

          // Check if waiting
          if (reg.waiting) {
             showUpdateToast(toast);
          }

          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    showUpdateToast(toast);
                }
                });
            }
          });
        });
      });

      // Reload Logic
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        window.location.reload();
        refreshing = true;
      });

      btn.addEventListener('click', () => {
        navigator.serviceWorker.ready.then(reg => {
            if (reg.waiting) {
                reg.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
        });
      });
    }
  }

  function showUpdateToast(toast) {
      // Use Native Popover API
      try {
          // If already open, do nothing or re-show
          if (!toast.matches(':popover-open')) {
              toast.showPopover();
          }
      } catch (e) {
          // Fallback
          toast.style.display = 'block';
      }
  }

  // Run initialization
  initPWA();

  // Re-run on Astro navigation if needed (though PWA state is global window)
  document.addEventListener('astro:page-load', () => {
      // Re-attach listeners if DOM was replaced
      // But serviceWorker registration is persistent.
      // We might need to re-check 'reg.waiting' if we navigated away and back?
      // For now, initPWA handles the initial load.
      // Since this component is in MainLayout, it persists across navigations if transition:persist is used,
      // but it's not. It's re-rendered. So we need to re-check.

      if (navigator.serviceWorker) {
          navigator.serviceWorker.getRegistration().then(reg => {
              if (reg && reg.waiting) {
                  const toast = document.getElementById('pwa-toast');
                  if (toast) showUpdateToast(toast);
              }
          });
      }
  });
</script>
