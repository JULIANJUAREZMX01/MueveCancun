---
import InteractiveMap from '../components/InteractiveMap.astro';
import { ClientRouter } from 'astro:transitions';
import '../index.css';
import Toast from '../components/ui/Toast.astro';

interface Props {
  title: string;
  description?: string;
  image?: string;
}

const {
  title,
  description = "La app oficial de transporte público para Cancún y Riviera Maya.",
  image = "/og-image.png"
} = Astro.props;

const pathname = Astro.url.pathname;
---

<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | CancúnMueve</title>
    <meta name="description" content={description} />
    <meta property="og:image" content={image} />

    <!-- PWA -->
    <meta name="theme-color" content="#F97316" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/pwa-192x192.png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <ClientRouter />
  </head>
  <body class="bg-slate-50 dark:bg-slate-900 min-h-screen text-slate-900 dark:text-slate-100 font-sans antialiased pb-0 selection:bg-primary-200 selection:text-primary-900">

    <!-- Map Layer (Z-0) -->
    <InteractiveMap class="fixed inset-0 z-0 h-screen w-screen" transition:persist />

    <!-- Mobile Header: Floating Glass Pill (Z-40) -->
    <header class="fixed top-4 left-4 z-40 lg:hidden pointer-events-auto">
        <div class="glass-pill">
             <div class="w-6 h-6 bg-gradient-to-tr from-primary-500 to-primary-400 rounded-md flex items-center justify-center text-white font-black text-[10px] shadow-sm">
              CM
            </div>
             <span class="brand-container font-display font-black text-sm tracking-tight text-deep-navy dark:text-white" data-original="true">Cancún<span class="text-primary-500">Mueve</span></span>
             <div class="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1"></div>
             <button id="theme-toggle-mobile" class="text-slate-500 dark:text-slate-300 hover:text-primary-500 transition-colors">
                <!-- Sun Icon -->
                <svg class="w-5 h-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <!-- Moon Icon -->
                <svg class="w-5 h-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
             </button>
        </div>
    </header>

    <!-- Content Slot (Z-10) -->
    <!-- The layout responsibility for positioning (Dock/Sheet) moves to index.astro -->
    <!-- But we provide a container that sits above the map -->
    <div class="relative z-10 w-full h-full pointer-events-none">
        <slot />
    </div>

    <!-- Toast Notification -->
    <Toast />

    <!-- PWA Update Notification -->
    <div id="pwa-update-toast" class="hidden fixed bottom-20 left-4 right-4 z-50 glass-panel p-4 rounded-xl backdrop-blur-md animate-slide-up pointer-events-auto">
        <div class="flex items-center justify-between gap-4">
            <div>
                <h4 class="font-bold text-sm text-slate-800 dark:text-white">Nueva versión disponible</h4>
                <p class="text-xs text-slate-500 dark:text-slate-300 mt-1">Recarga para ver los cambios.</p>
            </div>
            <button id="pwa-refresh-btn" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors shadow-lg shadow-primary-500/30">
                ACTUALIZAR
            </button>
        </div>
    </div>

    <!-- Theme Logic -->
    <script is:inline>
        const html = document.documentElement;

        function initTheme() {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                html.classList.toggle('dark', storedTheme === 'dark');
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                html.classList.add('dark');
            }
        }
        initTheme();

        function toggleTheme() {
             html.classList.toggle('dark');
             const isDark = html.classList.contains('dark');
             localStorage.setItem('theme', isDark ? 'dark' : 'light');
             window.dispatchEvent(new CustomEvent('THEME_CHANGE', { detail: { theme: isDark ? 'dark' : 'light' } }));
        }

        document.addEventListener('astro:page-load', () => {
             const btnMobile = document.getElementById('theme-toggle-mobile');
             const btnDesktop = document.getElementById('theme-toggle-desktop'); // To be added in Dock

             btnMobile?.addEventListener('click', toggleTheme);
             btnDesktop?.addEventListener('click', toggleTheme);
        });
    </script>

    <script is:inline>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            if (registration.waiting) {
                const toast = document.getElementById('pwa-update-toast');
                if (toast) toast.classList.remove('hidden');
            }
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    const toast = document.getElementById('pwa-update-toast');
                    if (toast) toast.classList.remove('hidden');
                }
              });
            });
          }).catch(console.error);
        });

        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return;
            window.location.reload();
            refreshing = true;
        });

        document.getElementById('pwa-refresh-btn')?.addEventListener('click', () => {
            navigator.serviceWorker.ready.then(registration => {
                if (registration.waiting) {
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        });
      }
    </script>

    <script is:inline>
      document.addEventListener('astro:page-load', () => {
          const handleBrandUpdate = (e) => {
              const phase = e.detail.phase;
              const containers = document.querySelectorAll('.brand-container');
              containers.forEach(container => {
                  // Simplified Phase Logic for Space
                  if (phase === 1 && container.dataset.phase !== '1') {
                      container.innerHTML = `Cancún<span class="text-[#006847] inline-block mx-[1px]">EN</span><span class="text-primary-500">Mueve</span>`;
                      container.dataset.phase = '1';
                  }
                  // Keep it simple for the pill
              });
          };
          window.addEventListener('BRAND_UPDATE', handleBrandUpdate);
      });
    </script>

    <style>
      .filter-primary { filter: invert(49%) sepia(83%) saturate(1900%) hue-rotate(349deg) brightness(98%) contrast(98%); }
    </style>
  </body>
</html>
