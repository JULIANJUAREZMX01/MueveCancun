---
import { ClientRouter } from 'astro:transitions';
import '../index.css';
import Toast from '../components/ui/Toast.astro';
import PwaReload from '../components/ui/PwaReload.astro';
import BottomNav from '../components/BottomNav.astro';
import ScrollToTop from '../components/ui/ScrollToTop.astro';
import BrandAnimation from '../components/ui/BrandAnimation.astro';
import { ui as uiTranslations } from '../utils/i18n';

interface Props {
  title: string;
  description?: string;
  image?: string;
  hideNav?: boolean;
}

const {
  title,
  description = "La app oficial de transporte p√∫blico para Canc√∫n y Riviera Maya.",
  image = "/og-image.png",
  hideNav = false
} = Astro.props;

const pathname = Astro.url.pathname;

const navItems = [
  { href: '/home', label: 'Inicio', icon: 'explore', activePattern: /^\/home/ },
  { href: '/rutas', label: 'Rutas', icon: 'route', activePattern: /^\/rutas/ },
  { href: '/mapa', label: 'Mapa', icon: 'map', activePattern: /^\/mapa/ },
  { href: '/community', label: 'Foro', icon: 'forum', activePattern: /^\/community/ },
  { href: '/wallet', label: 'Wallet', icon: 'account_balance_wallet', activePattern: /^\/wallet/ },
  { href: '/about', label: 'Nosotros', icon: 'info', activePattern: /^\/about/ },
];
---

<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <!-- Security: Content Security Policy (CSP) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https://*.cartocdn.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; worker-src 'self' blob:; object-src 'none'; base-uri 'self';" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />

    <!-- üõ°Ô∏è Sentinel: Strict CSP -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' https://*.cartocdn.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        img-src 'self' data: https://*.cartocdn.com https://*.openstreetmap.org;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://*.cartocdn.com;
        worker-src 'self' blob:;
        object-src 'none';
        base-uri 'self';
        upgrade-insecure-requests;
    ">

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title} | Canc√∫nMueve</title>
    <meta name="description" content={description} />
    <meta property="og:image" content={image} />

    <!-- PWA -->
    <meta name="theme-color" content="#0d9488" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/pwa-192x192.png" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet" />

    <!-- Preload Critical Data -->
    <link rel="preload" href="/data/master_routes.optimized.json" as="fetch" crossorigin />

    <script>
      import { getWalletBalance } from '../utils/db';
      
      // 1. Theme Initialization
      function applyTheme() {
          const theme = localStorage.getItem("theme");
          if (theme === "dark" || (!theme && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
      }
      
      // 2. I18n Initialization
      function applyLanguage() {
          const stored = localStorage.getItem('lang');
          if (stored) {
              updateTranslations(stored);
              return;
          }

          // Auto-detect browser language
          const navLang = navigator.language.split('-')[0];
          const supported = ['es', 'en'];
          const lang = supported.includes(navLang) ? navLang : 'es';
          
          localStorage.setItem('lang', lang);
          updateTranslations(lang);
      }

      function updateTranslations(lang) {
          const dataEl = document.getElementById('i18n-translations');
          const allTranslations = dataEl ? JSON.parse(dataEl.dataset.translations || '{}') : {};
          const translations = allTranslations[lang] || allTranslations['es'] || {};

          // Update simple text elements
          document.querySelectorAll('[data-i18n]').forEach(el => {
              const key = el.getAttribute('data-i18n');
              const text = translations[key];
              if (text) {
                  // Update lang toggle visual state
                  const langToggles = document.querySelectorAll('.lang-toggle-btn');
                  langToggles.forEach(btn => {
                      btn.textContent = lang.toUpperCase();
                  });

                  if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                       // handled by data-i18n-placeholder
                  } else {
                      el.textContent = text;
                  }
              }
          });

          // Custom Input Labels
          document.querySelectorAll('[data-i18n-label]').forEach(el => {
              const key = el.getAttribute('data-i18n-label');
              const text = translations[key];
              if (text) {
                 if (el.tagName === 'INPUT') {
                     const id = el.id;
                     if (id) {
                         const label = document.querySelector(`label[for="${id}"]`);
                         if (label) label.textContent = text;
                     }
                 } else {
                     const labelSpan = el.querySelector('.label-text');
                     if (labelSpan) labelSpan.textContent = text;
                 }
              }
          });
          
          // Placeholders
          document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
               const key = el.getAttribute('data-i18n-placeholder');
               const text = translations[key];
               if (text && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA')) {
                   el.placeholder = text;
               }
          });

          // Quick Action Buttons (HTML content)
          document.querySelectorAll('[data-i18n-html]').forEach(el => {
             const key = el.getAttribute('data-i18n-html');
             const text = translations[key];
             // Preserves icon if we replace innerText carefully or just update text node
             // For quick actions: <span icon></span> Text
             if (text) {
                 const icon = el.querySelector('span');
                 el.innerHTML = '';
                 if (icon) el.appendChild(icon);
                 el.appendChild(document.createTextNode(' ' + text));
             }
          });
      }

      applyTheme();
      applyLanguage();
      
      // 3. Global Balance Sync
      async function syncGlobalBalance() {
          try {
            const walletData = await getWalletBalance();
            const balance = walletData?.amount ?? 180.00;
            const balanceEl = document.getElementById('header-balance-amount');
            if (balanceEl) balanceEl.textContent = `$${balance.toFixed(2)}`;
          } catch (e) {
            console.warn("[MainLayout] Balance sync failed", e);
          }
      }

      syncGlobalBalance();
      
      document.addEventListener('astro:after-swap', () => {
        applyTheme();
        applyLanguage();
        syncGlobalBalance();
      });

      window.addEventListener('BALANCE_UPDATED', () => {
          console.log("[MainLayout] Balance update event received");
          syncGlobalBalance();
      });

      window.addEventListener('LANGUAGE_CHANGE', (e) => {
          updateTranslations(e.detail);
      });
    </script>
    <ClientRouter />
  </head>
  <body id="top" class="bg-slate-50 dark:bg-slate-950 min-h-screen text-slate-900 dark:text-slate-100 font-sans antialiased transition-colors duration-300">

    <!-- ‚ïê‚ïê‚ïê Unified Header (Responsive) ‚ïê‚ïê‚ïê -->
    { !hideNav && (
    <header class="fixed top-0 left-0 right-0 z-40 h-14 md:h-16 px-4 md:px-6 flex items-center justify-between transition-colors duration-300 app-header">

      <a href="/home" class="flex items-center gap-2.5 no-underline group outline-none" aria-label="Canc√∫nMueve - Inicio">
        <div class="w-8 h-8 bg-primary-500 rounded-xl flex items-center justify-center shadow-md shadow-primary-500/20 group-hover:scale-105 transition-transform">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="white" aria-hidden="true"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4S4 2.5 4 6v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg>
        </div>
        <!-- Animated Brand -->
        <BrandAnimation />
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center gap-1" aria-label="Desktop navigation">
        {navItems.map(item => {
          let i18nKey = '';
          if (item.href === '/home') i18nKey = 'nav.home';
          else if (item.href === '/rutas') i18nKey = 'nav.routes';
          else if (item.href === '/mapa') i18nKey = 'nav.map';
          else if (item.href === '/community') i18nKey = 'nav.community';
          else if (item.href === '/wallet') i18nKey = 'nav.wallet';
          else if (item.href === '/about') i18nKey = 'nav.about';

          return (
            <a href={item.href}
               aria-label={item.label}
               aria-current={item.activePattern.test(pathname) ? 'page' : undefined}
               class:list={[
                 'flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-sm font-bold transition-all no-underline',
                 item.activePattern.test(pathname)
                   ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400'
                   : 'text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-white hover:bg-slate-100 dark:hover:bg-slate-800'
               ]}>
              <span data-i18n={i18nKey}>{item.label}</span>
            </a>
          );
        })}
      </nav>

      <!-- Controls -->
      <div class="flex items-center gap-2">
         <!-- Unified Balance Badge -->
         <a href="/wallet" id="header-balance-badge" class="hidden md:flex items-center gap-1.5 px-3 py-1.5 rounded-xl bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 no-underline transition-all hover:scale-105 active:scale-95 group" aria-label="Wallet balance">
            <span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]" aria-hidden="true"></span>
            <span id="header-balance-amount" class="text-xs font-black text-slate-700 dark:text-slate-300">$180.00</span>
         </a>

         <button class="theme-toggle w-9 h-9 rounded-xl flex items-center justify-center transition-all hover:bg-slate-100 dark:hover:bg-slate-800"
                 style="color: var(--text-secondary);" aria-label="Toggle dark mode">
            <svg class="hidden dark:block" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37a.996.996 0 00-1.41 0 .996.996 0 000 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36a.996.996 0 000-1.41.996.996 0 00-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/></svg>
            <svg class="block dark:hidden" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
         </button>
      </div>
    </header>
    )}

    <!-- ‚ïê‚ïê‚ïê Main Content ‚ïê‚ïê‚ïê -->
    <main class:list={[
      'w-full max-w-lg mx-auto lg:max-w-7xl min-h-screen',
      !hideNav && 'pt-16 pb-24 md:pb-0' // Adjust padding for navs
    ]}>
      <slot />
    </main>

    <!-- ‚ïê‚ïê‚ïê Bottom Nav (Mobile Only) ‚ïê‚ïê‚ïê -->
    { !hideNav && (
      <div class="md:hidden">
        <BottomNav />
      </div>
    )}

    <Toast />
    <PwaReload />

    <div id="i18n-translations" data-translations={JSON.stringify(uiTranslations)} class="hidden"></div>

    <script is:inline>
      function setupThemeToggle() {
        // Find existing buttons (desktop + mobile)
        const toggles = document.querySelectorAll('.theme-toggle');

        toggles.forEach(btn => {
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);

          newBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle("dark");
            const isDark = document.documentElement.classList.contains("dark");
            localStorage.setItem("theme", isDark ? "dark" : "light");
          });
        });
      }

      // Run on every navigation because MainLayout persists but content updates
      document.addEventListener('astro:page-load', () => {
        setupThemeToggle();
      });

      if (document.readyState === 'complete') {
          setupThemeToggle();
      } else {
          window.addEventListener('load', () => {
              setupThemeToggle();
          });
      }
    </script>

    <style>
      /*
       * GRAFFITI WARRIOR: CSS5 Scroll-Driven Animations
       * Header becomes opaque when scrolling down.
       * No JS required.
       */
      .app-header {
        background: transparent;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        border-bottom: 1px solid transparent;

        /* Animation Logic */
        animation: header-scroll linear forwards;
        animation-timeline: scroll();
        animation-range: 0px 50px;
      }

      @keyframes header-scroll {
        to {
          background: var(--surface-card);
          backdrop-filter: blur(16px);
          -webkit-backdrop-filter: blur(16px);
          border-bottom: 1px solid var(--border-light);
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
      }
    </style>
  </body>
</html>
