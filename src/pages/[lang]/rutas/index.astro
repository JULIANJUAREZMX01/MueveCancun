---
export function getStaticPaths() {
  return [
    { params: { lang: "es" } },
    { params: { lang: "en" } },
  ];
}

import MainLayout from '../../../layouts/MainLayout.astro';
import { getAllRoutes } from '../../../lib/routes';

const rawRoutes = await getAllRoutes();

// Types for UI transformation
interface UIRoute {
  id: string;
  name: string;
  price: number;
  transport_type: string;
  operator?: string;
  frequency?: string;
  schedule?: string;
  duration?: string;
  badges: string[];
  stops: string[];
  origin_hub?: string;
  dest_hub?: string;
}

const TRANSPORT_LABELS: Record<string, string> = {
  "Bus": "Autobús",
  "Combi": "Combi",
  "Van": "Van / Colectivo",
  "ADO": "ADO",
  "PlayaExpress": "Playa Express",
  "Bus_Urban": "Autobús Urbano",
  "Bus_HotelZone": "Autobús Zona Hotelera",
  "ADO_Airport": "ADO Aeropuerto",
  "Van_Foranea": "Van Foránea",
  "Combi_Municipal": "Combi Municipal"
};

const getTransportLabel = (type: string) => TRANSPORT_LABELS[type] || type;

const transformRoute = (raw: any): UIRoute => {
  let transport_type = raw.tipo_transporte || raw.tipo || "Bus";
  
  // Format Schedule
  let schedule = "06:00 - 23:00"; // Default
  if (raw.horario) {
     if (typeof raw.horario === 'string') {
        schedule = raw.horario;
     } else {
        const start = raw.horario.inicio || raw.horario.inicio_oficial || "06:00";
        const end = raw.horario.fin || raw.horario.fin_oficial || "23:00";
        schedule = `${start} - ${end}`;
     }
  }

  const stops = raw.paradas ? raw.paradas.map((p: any) => p.nombre || p.parada) : [];

  return {
    id: raw.id,
    name: raw.nombre,
    price: raw.tarifa || 15,
    transport_type,
    operator: raw.operador || raw.empresa || "Consorcio Urbano",
    frequency: raw.frecuencia_minutos ? `${raw.frecuencia_minutos} min` : "10 min",
    schedule,
    duration: raw.duracion_minutos ? `${raw.duracion_minutos} min` : "45 min est.",
    badges: raw.tags || raw.social_alerts || [],
    stops,
    origin_hub: stops[0] || "Origen",
    dest_hub: stops[stops.length - 1] || "Destino"
  };
};

const routes: UIRoute[] = rawRoutes.map(transformRoute);
---

<MainLayout title="Catálogo de Rutas">
  <div class="space-y-6 animate-fade-in pb-20">
    <!-- Header -->
    <div class="pt-6">
      <h1 class="text-3xl font-display font-black text-slate-900 tracking-tight mb-1">
        Red de Transporte
      </h1>
      <p class="text-slate-500 font-medium text-sm">
        Explora las {routes.length} rutas oficiales de Cancún y Riviera Maya.
      </p>
    </div>

    <!-- List Container -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       {routes.map(route => {
          let stopsPreview = `${route.origin_hub} ➔ ${route.dest_hub}`;

          return (
          <a href={`/ruta/${route.id}`} class="glass-card p-5 group hover:border-primary-300 transition-all active:scale-[0.98] no-underline block overflow-hidden relative">
            
            <!-- Background Badge -->
            <div class="absolute -right-4 -top-4 opacity-[0.03] group-hover:opacity-[0.08] transition-opacity">
                <span class="material-symbols-rounded text-8xl" style="font-variation-settings: 'FILL' 1;">directions_bus</span>
            </div>

            <div class="flex justify-between items-start relative z-10">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 rounded-md bg-primary-100 text-primary-700 text-[10px] font-black uppercase tracking-widest">
                      {route.id}
                    </span>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                      {getTransportLabel(route.transport_type)}
                    </span>
                </div>
                
                <h3 class="font-bold text-slate-900 group-hover:text-primary-600 transition-colors truncate pr-4">{route.name}</h3>

                <!-- Meta Info Row -->
                <div class="mt-3 flex flex-wrap gap-x-4 gap-y-2 text-[10px] font-bold text-slate-500 uppercase tracking-tighter">
                    <div class="flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm text-slate-300">avg_pace</span> 
                        <span>{route.frequency}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="material-symbols-rounded text-sm text-slate-300">schedule</span> 
                        <span>{route.schedule}</span>
                    </div>
                </div>
              </div>

              <div class="text-right shrink-0">
                <div class="text-xl font-black text-emerald-600 font-mono">
                    ${route.price}<span class="text-xs">.00</span>
                </div>
                <div class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">EFECTIVO</div>
              </div>
            </div>

            <!-- Stops Preview -->
            <div class="mt-4 pt-4 border-t border-slate-50/50 flex items-center justify-between">
                <div class="flex items-center gap-1.5 min-w-0">
                    <span class="material-symbols-rounded text-xs text-primary-500" style="font-variation-settings: 'FILL' 1;">location_on</span>
                    <span class="text-[11px] font-medium text-slate-500 truncate italic">{stopsPreview}</span>
                </div>
                <span class="material-symbols-rounded text-slate-300 group-hover:text-primary-500 group-hover:translate-x-1 transition-all">chevron_right</span>
            </div>
          </a>
          );
       })}
    </div>

  </div>
</MainLayout>

<style>
  .animate-fade-in {
    animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
