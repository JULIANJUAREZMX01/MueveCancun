---
import MainLayout from '../layouts/MainLayout.astro';
import ReportTypeSelector from '../components/ui/ReportTypeSelector.astro';

const reportOptions = [
  { value: 'new_route', label: 'Ruta Nueva', icon: 'üó∫Ô∏è' },
  { value: 'price_change', label: 'Cambio de Tarifa', icon: 'üí∞' },
  { value: 'safety_issue', label: 'Problema de Seguridad', icon: '‚ö†Ô∏è' },
  { value: 'other', label: 'Otro', icon: 'üìù' },
];
---

<MainLayout title="Ay√∫danos a Mejorar">
  <div class="max-w-2xl mx-auto space-y-8">
    <header class="text-center">
      <h1 class="text-4xl font-display font-bold text-gray-900 mb-4">
        Ay√∫danos a Mejorar
      </h1>
      <p class="text-gray-600">
        Si conoces una ruta nueva o un cambio en las tarifas, rep√≥rtalo aqu√≠.
      </p>
    </header>

    <div class="sunny-card p-8">
      <form id="contribution-form" class="space-y-6">
        <div class="graffiti-input-group">
          <input type="text" id="name" name="name" class="graffiti-input" placeholder=" " required />
          <label for="name" class="graffiti-label">Nombre Completo</label>
        </div>

        <ReportTypeSelector
          name="reportType"
          label="Tipo de Reporte"
          options={reportOptions}
        />

        <div class="graffiti-input-group">
          <textarea id="details" name="details" class="graffiti-input textarea" placeholder=" " required></textarea>
          <label for="details" class="graffiti-label">Detalles del Reporte</label>
        </div>

        <button type="submit" id="submit-btn" class="w-full premium-button group flex items-center justify-center gap-2">
          <span id="submit-text">Enviar Reporte</span>
          <svg id="submit-spinner" class="w-5 h-5 animate-spin hidden" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>
    </div>
  </div>

  <script>
    function setupForm() {
      const form = document.getElementById('contribution-form');
      const btn = document.getElementById('submit-btn');
      const text = document.getElementById('submit-text');
      const spinner = document.getElementById('submit-spinner');

      if (!form || !btn) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // 1. Loading State
        btn.disabled = true;
        text.textContent = 'Enviando...';
        spinner.classList.remove('hidden');

        // 2. Data Gathering
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        console.log('Sending report:', data);

        // 3. Simulate Backend Request
        try {
          // Simulation: Wait 1.5s
          await new Promise(resolve => setTimeout(resolve, 1500));

          // Success Logic
          if (window.showToast) {
            window.showToast("¬°Gracias! Tu reporte ha sido enviado con √©xito.", "success");
          }
          
          form.reset();
          // Reset custom selector too (clean the text)
          const selectorText = form.querySelector('.selected-text');
          if (selectorText) selectorText.textContent = 'Selecciona una opci√≥n...';

        } catch (error) {
          console.error('Submission failed:', error);
          if (window.showToast) {
            window.showToast("Hubo un error al enviar el reporte. Revisa tu conexi√≥n.", "error");
          }
        } finally {
          // 4. Reset State
          btn.disabled = false;
          text.textContent = 'Enviar Reporte';
          spinner.classList.add('hidden');
        }
      });
    }

    document.addEventListener('astro:page-load', setupForm);
    if (document.readyState === 'complete') setupForm();
    else window.addEventListener('load', setupForm);
  </script>
</MainLayout>


<style>
  /* GRAFFITI WARRIOR: CSS5 Floating Labels & Validation */
  .graffiti-input-group {
    position: relative;
    /* Space for the floating label when it moves up */
    margin-top: 0.5rem;

    .graffiti-label {
      position: absolute;
      left: 1rem;
      top: 0.8rem;
      color: #64748b;
      font-size: 1rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      transform-origin: left top;
      background: transparent;
      padding: 0 0.25rem;
    }

    .graffiti-input {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 1px solid #cbd5e1;
      border-radius: 0.5rem;
      font-size: 1rem;
      background: white;
      transition: all 0.2s ease;

      &:focus {
        border-color: #f97316;
        outline: 2px solid transparent;
        box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2);
      }

      /* Float the label when focused or has value (placeholder-shown is false) */
      &:focus + .graffiti-label,
      &:not(:placeholder-shown) + .graffiti-label {
        transform: translateY(-1.5rem) scale(0.85);
        color: #f97316;
        background: white;
        font-weight: 600;
      }

      /* Invalid State (User Interaction) */
      &:user-invalid {
        border-color: #ef4444;

        & + .graffiti-label {
          color: #ef4444;
        }
      }

      &.textarea {
        min-height: 8rem;
        resize: vertical;
      }
    }
  }
</style>
