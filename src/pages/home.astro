---
import Layout from '../layouts/Layout.astro';
import Switch from '../components/ui/Switch.astro';
import InteractiveMap from '../components/InteractiveMap.astro';
---

<Layout title="Dashboard - Canc칰nMueve">
    <!-- Real Interactive Map (Background Layer) -->
    <div class="fixed inset-0 z-0">
        <InteractiveMap />
    </div>

	<!-- Status Bar Placeholder (Simulated) -->
	<div class="status-bar">
		<span class="time">9:30</span>
		<div class="status-icons">
			<span class="material-icons-round text-sm">signal_cellular_alt</span>
			<span class="material-icons-round text-sm">wifi</span>
			<span class="material-icons-round text-sm">battery_full</span>
		</div>
	</div>

	<div class="dashboard-container pointer-events-none">
		<!-- Search Card -->
		<div class="glass-panel search-card animate-fade-in-up pointer-events-auto">
			<div class="card-header">
				<div class="brand-row">
					<h1 class="brand-name">Canc칰nMueve</h1>
					<div class="live-badge">
						<div class="live-dot animate-pulse"></div>
						<span class="live-text">REAL-TIME</span>
					</div>
				</div>
			</div>

			<div class="input-group">
				<div class="input-row">
					<div class="input-icon-circle">
						<span class="material-icons-round">location_on</span>
					</div>
					<div class="input-field">
						<label>Origen</label>
						<input type="text" id="input-origin" value="La Rehoyada" placeholder="쮻칩nde est치s?" />
					</div>
				</div>

				<button class="swap-btn" id="btn-swap">
					<span class="material-icons-round">swap_vert</span>
				</button>

				<div class="input-row">
					<div class="input-icon-circle">
						<span class="material-icons-outlined">flag</span>
					</div>
					<div class="input-field">
						<label>Destino</label>
						<input type="text" id="input-dest" value="Playa Delfines" placeholder="쮸 d칩nde vas?" />
					</div>
				</div>
			</div>

			<div class="quick-actions">
				<button class="action-chip" onclick="setInput('input-dest', 'Villas Otoch')">
					<span class="material-icons-round icon">home</span>
					<span class="label">Casa</span>
				</button>
				<button class="action-chip" onclick="setInput('input-dest', 'Zona Hotelera')">
					<span class="material-icons-round icon">work</span>
					<span class="label">Trabajo</span>
				</button>
				<button class="action-chip" onclick="setInput('input-dest', 'Aeropuerto T2')">
					<span class="material-icons-round icon rotate-45">flight</span>
					<span class="label">Aeropuerto</span>
				</button>
			</div>

			<div class="options-row">
				<div class="passengers-selector">
					<label>PASAJEROS</label>
					<div class="selector-value">
						<span>1 Pasajero</span>
						<span class="material-icons-round arrow">expand_more</span>
					</div>
				</div>
				<div class="tourist-toggle-wrapper h-full flex items-center">
					<Switch id="tourist-mode-home" label="Turista" checked={true} />
				</div>
			</div>

			<button id="btn-search" class="cta-btn group">
				<span id="btn-text">TRAZAR RUTA</span>
				<div id="btn-loader" class="hidden animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
				<span class="material-icons-round arrow group-hover-translate">arrow_forward</span>
			</button>
            <p id="error-msg" class="text-red-500 text-xs font-bold text-center mt-2 hidden"></p>
		</div>

		<!-- Bottom Navigation -->
		<div class="bottom-nav pointer-events-auto">
			<a href="/home" class="nav-item active">
				<div class="nav-icon-circle">
					<span class="material-icons-round text-2xl">explore</span>
				</div>
				<span class="nav-label">Inicio</span>
			</a>
			<a href="/tracking" class="nav-item">
				<span class="material-icons-round text-2xl">directions_bus</span>
				<span class="nav-label">Rutas</span>
			</a>
			<a href="/mapa" class="nav-item">
				<span class="material-icons-round text-2xl">map</span>
				<span class="nav-label">Mapa</span>
			</a>
			<a href="/wallet" class="nav-item">
				<span class="material-icons-round text-2xl">credit_card</span>
				<span class="nav-label">Mi Tarjeta</span>
			</a>
            <a href="/community" class="nav-item">
				<span class="material-icons-round text-2xl">groups</span>
				<span class="nav-label">Comunidad</span>
			</a>
		</div>
	</div>
</Layout>

<script>
    import { RouteCalculatorBridge } from '../lib/wasm_bridge';
    import { coordinatesStore } from '../lib/CoordinatesStore';

    // Helper for quick actions
    window.setInput = (id, val) => {
        document.getElementById(id).value = val;
    }

    const bridge = RouteCalculatorBridge.getInstance();
    
    document.getElementById('btn-search')?.addEventListener('click', async () => {
        const originName = document.getElementById('input-origin').value;
        const destName = document.getElementById('input-dest').value;
        const btnText = document.getElementById('btn-text');
        const loader = document.getElementById('btn-loader');
        const errorMsg = document.getElementById('error-msg');

        if(!originName || !destName) return;

        // UI Loading State
        btnText.classList.add('hidden');
        loader.classList.remove('hidden');
        errorMsg.classList.add('hidden');

        try {
            await coordinatesStore.init();
            
            // 1. Resolve Coordinates (using Store's fuzzy logic or exact match)
            // Implementation note: The Store `findNearest` is for lat/lng -> name.
            // We need Name -> Lat/Lng. 
            // We can access the raw DB from store.
            const db = coordinatesStore.getDB();
            
            const findCoord = (name) => {
                // Exact
                if(db[name]) return db[name];
                // Simple fuzzy
                const key = Object.keys(db).find(k => k.toLowerCase().includes(name.toLowerCase()));
                return key ? db[key] : null;
            };

            const originCoords = findCoord(originName);
            const destCoords = findCoord(destName);

            if (!originCoords) throw new Error(`Origen no encontrado: ${originName}`);
            if (!destCoords) throw new Error(`Destino no encontrado: ${destName}`);

            console.log("游늸 Calculating Route:", { originCoords, destCoords });

            // 2. Call WASM
            const result = await bridge.calculateRoute(
                originCoords[0], originCoords[1],
                destCoords[0], destCoords[1]
            );

            console.log("游 Route Result:", result);

            if (result && result.success) {
                // 3. Dispatch to Map
                const event = new CustomEvent('SHOW_ROUTE_ON_MAP', { detail: result });
                window.dispatchEvent(event);
                
                // Optional: Minimize card or show feedback
                // For now, let's just toast
                 if(window.showToast) window.showToast("춰Ruta encontrada!", "success");

            } else {
                 if(window.showToast) window.showToast("No se encontr칩 una ruta v치lida.", "error");
                 errorMsg.innerText = "No se encontr칩 ruta. Intenta otros puntos.";
                 errorMsg.classList.remove('hidden');
            }

        } catch (e) {
            console.error(e);
            errorMsg.innerText = e.message || "Error al calcular ruta";
            errorMsg.classList.remove('hidden');
        } finally {
            btnText.classList.remove('hidden');
            loader.classList.add('hidden');
        }
    });

    // Swap Button
    document.getElementById('btn-swap')?.addEventListener('click', () => {
        const originInput = document.getElementById('input-origin');
        const destInput = document.getElementById('input-dest');
        const temp = originInput.value;
        originInput.value = destInput.value;
        destInput.value = temp;
    });

</script>

<style>
	/* Status Bar */
	.status-bar {
		position: absolute;
		top: 0;
		width: 100%;
		height: 3rem;
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 0 1.5rem;
		font-size: 0.75rem;
		font-weight: 600;
		color: var(--color-text-main);
		z-index: 20;
        pointer-events: none; /* Let clicks pass through */
	}

	.status-icons {
		display: flex;
		gap: 0.25rem;
	}

	.dashboard-container {
		position: relative;
		height: 100vh;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
		padding-top: 4rem;
        /* pointer-events-none added via class, ensures map interaction */
	}
    
    /* Re-enable pointer events for interactive children */
    .pointer-events-auto {
        pointer-events: auto;
    }
    .pointer-events-none {
        pointer-events: none;
    }

	/* Glass Panel Utility */
	.glass-panel {
		background: rgba(255, 255, 255, 0.85);
		backdrop-filter: blur(12px);
		border: 1px solid rgba(255, 255, 255, 0.6);
		box-shadow: var(--shadow-glass);
	}

	/* Search Card */
	.search-card {
		margin: 0 1rem;
		border-radius: 1.5rem;
		padding: 1.25rem;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.card-header {
		display: flex;
		justify-content: center;
		margin-bottom: 0.5rem;
	}

	.brand-row {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.brand-name {
		font-size: 1.875rem; /* 3xl */
		font-weight: 700;
		color: var(--color-secondary); /* Primary in prompt was orange */
		letter-spacing: -0.025em;
		margin: 0;
	}

	.live-badge {
		display: flex;
		align-items: center;
		background-color: #DCFCE7; /* green-100 */
		border: 1px solid #BBF7D0;
		border-radius: 9999px;
		padding: 0.125rem 0.5rem;
		margin-top: 0.25rem;
	}

	.live-dot {
		width: 0.5rem;
		height: 0.5rem;
		background-color: #22C55E; /* green-500 */
		border-radius: 9999px;
		margin-right: 0.375rem;
	}

	.live-text {
		font-size: 10px;
		font-weight: 700;
		color: #15803D; /* green-700 */
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	/* Input Group */
	.input-group {
		position: relative;
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.input-row {
		background-color: rgba(255, 255, 255, 0.6);
		border: 1px solid #E5E7EB;
		border-radius: 1rem;
		padding: 0.75rem;
		display: flex;
		align-items: center;
		box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
	}

	.input-icon-circle {
		width: 2.5rem;
		height: 2.5rem;
		border-radius: 9999px;
		background-color: #F3F4F6;
		display: flex;
		align-items: center;
		justify-content: center;
		color: #6B7280;
		margin-right: 0.75rem;
		flex-shrink: 0;
	}

	.input-field {
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	.input-field label {
		font-size: 0.75rem;
		color: #6B7280;
		font-weight: 500;
	}

	.input-field input {
		width: 100%;
		background: transparent;
		border: none;
		padding: 0;
		font-size: 1rem;
		font-weight: 600;
		color: var(--color-text-main);
		outline: none;
	}

	.swap-btn {
		position: absolute;
		right: 2rem;
		top: 38%;
		z-index: 10;
		width: 2.5rem;
		height: 2.5rem;
		background-color: white;
		border-radius: 9999px;
		border: 1px solid #E5E7EB;
		display: flex;
		align-items: center;
		justify-content: center;
		color: #6B7280;
		box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
		cursor: pointer;
		transition: transform 0.2s;
	}

	.swap-btn:active {
		transform: rotate(180deg);
	}

	/* Quick Actions */
	.quick-actions {
		display: flex;
		gap: 0.5rem;
		overflow-x: auto;
		padding-bottom: 0.25rem;
	}

	.quick-actions::-webkit-scrollbar {
		display: none;
	}

	.action-chip {
		display: flex;
		align-items: center;
		gap: 0.375rem;
		padding: 0.5rem 0.75rem;
		background-color: rgba(255, 255, 255, 0.5);
		border: 1px solid #E5E7EB;
		border-radius: 0.75rem;
		cursor: pointer;
		transition: transform 0.1s;
	}

	.action-chip:active {
		transform: scale(0.95);
	}

	.action-chip .icon {
		color: #6B7280;
		font-size: 1.125rem;
	}

	.action-chip .label {
		font-size: 0.875rem;
		font-weight: 500;
		color: #374151;
	}

	.rotate-45 {
		transform: rotate(45deg);
	}

	/* Options Row */
	.options-row {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.75rem;
		margin-bottom: 0.5rem;
	}

	.passengers-selector {
		flex: 1;
		background-color: rgba(255, 255, 255, 0.5);
		border: 1px solid #E5E7EB;
		border-radius: 0.75rem;
		padding: 0.5rem 0.75rem;
		cursor: pointer;
	}

	.passengers-selector label {
		font-size: 10px;
		color: #6B7280;
		text-transform: uppercase;
		font-weight: 700;
		letter-spacing: 0.05em;
		display: block;
	}

	.selector-value {
		display: flex;
		align-items: center;
		justify-content: space-between;
	}

	.selector-value span {
		font-size: 0.875rem;
		font-weight: 600;
		color: #111827;
	}

	.selector-value .arrow {
		color: #9CA3AF;
		font-size: 1rem;
	}

	.tourist-toggle-wrapper {
		background-color: rgba(255, 255, 255, 0.5);
		border: 1px solid #E5E7EB;
		border-radius: 0.75rem;
		padding: 0 0.75rem;
		min-width: 140px; /* Ensure visual balance */
		justify-content: center;
	}

	/* CTA Button */
	.cta-btn {
		width: 100%;
		background-color: var(--color-secondary);
		color: white;
		font-weight: 700;
		font-size: 1.125rem;
		padding: 1rem;
		border-radius: 0.75rem;
		border: none;
		box-shadow: 0 4px 20px rgba(255, 107, 0, 0.4);
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		cursor: pointer;
		transition: all 0.2s;
	}

	.cta-btn:hover {
		background-color: #e56000;
	}

	.cta-btn:active {
		transform: scale(0.98);
	}

	.cta-btn .arrow {
		color: rgba(255, 255, 255, 0.8);
		transition: transform 0.2s;
	}

	.group:hover .group-hover-translate {
		transform: translateX(4px);
	}

	/* Bottom Nav */
	.bottom-nav {
		background-color: white;
		border-top: 1px solid #E5E7EB;
		padding: 0.5rem 1.5rem 2rem 1.5rem; /* pb-8 */
		display: flex;
		justify-content: space-between;
		align-items: center;
		border-top-left-radius: 1.5rem;
		border-top-right-radius: 1.5rem;
		box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
		z-index: 20;
	}

	.nav-item {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.25rem;
		color: #9CA3AF; /* gray-400 */
		text-decoration: none;
		transition: color 0.2s;
	}

	.nav-item:hover {
		color: #4B5563;
	}

	.nav-item.active {
		color: var(--color-secondary);
	}

	.nav-icon-circle {
		width: 2.5rem;
		height: 2.5rem;
		border-radius: 9999px;
		background-color: #FFF7ED; /* orange-50 */
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.nav-item.active .nav-icon-circle {
		background-color: #FFEDD5; /* orange-100 */
	}

	.nav-label {
		font-size: 10px;
		font-weight: 500;
	}

	.nav-item.active .nav-label {
		font-weight: 700;
	}

	@keyframes pulse {
		50% { opacity: .5; }
	}

	.animate-pulse {
		animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
	}

    @keyframes fade-in-up {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .animate-fade-in-up {
        animation: fade-in-up 0.5s ease-out forwards;
    }
</style>
