---
import MainLayout from '../layouts/MainLayout.astro';
import RouteCalculator from '../components/RouteCalculator.astro';

const title = "Dashboard";
---

<MainLayout title={title} useMap={true}>
    <!-- Real Interactive Map (Background Layer) -->
    <div class="fixed inset-0 z-0 h-full w-full">
        <div id="map-container" class="h-full w-full"></div>
    </div>

    <!-- Dashboard Overlay -->
	<div class="dashboard-container pointer-events-none">
		<div class="glass-panel-wrapper animate-fade-in-up pointer-events-auto">
			<RouteCalculator />
		</div>
    </div>

</MainLayout>

<script>
    import { coordinatesStore } from '../lib/CoordinatesStore';

    let map: any;
    let layerGroup: any;

    async function initLeaflet() {
        if(typeof (window as any).L === 'undefined') return;
        const container = document.getElementById('map-container');
        if(!container || (container as any)._leaflet_id) return;

        const L = (window as any).L;
        const isDark = document.documentElement.classList.contains('dark');

        map = L.map('map-container', {
            zoomControl: false,
            attributionControl: false
        }).setView([21.1619, -86.8515], 13);

        L.tileLayer(
            isDark
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            { subdomains: 'abcd', maxZoom: 20 }
        ).addTo(map);

        layerGroup = L.layerGroup().addTo(map);
        
        // Key location markers
        await coordinatesStore.init();
        const db = coordinatesStore.getDB() || {};
        Object.entries(db).forEach(([name, coords]) => {
            if(["El Crucero", "Plaza Las Am√©ricas", "La Rehoyada", "Zona Hotelera"].includes(name)) {
                L.circleMarker(coords, {
                    radius: 5,
                    fillColor: '#F97316',
                    color: '#FFF',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(layerGroup).bindPopup(
                    `<div style="font-family: Inter, sans-serif; font-weight: 700; font-size: 13px;">${name}</div>`
                );
            }
        });
    }

    // Handle View Switching
    window.addEventListener('VIEW_STATE_CHANGE', (e) => {
        const state = (e as CustomEvent).detail;
        const container = document.querySelector('.dashboard-container');
        if (state === 'MAP_ACTIVE') {
            container?.classList.add('map-mode');
        } else {
            container?.classList.remove('map-mode');
        }
        setTimeout(() => map?.invalidateSize(), 400);
    });

    // Route rendering on map
    window.addEventListener('SHOW_ROUTE_ON_MAP', (event) => {
        const data = (event as CustomEvent).detail;
        if (!map || !layerGroup) return;
        const L = (window as any).L;

        layerGroup.clearLayers();
        const allCoords: any[] = [];
        
        if (data.legs) {
            data.legs.forEach((leg: any) => {
                if (leg.stops_info) {
                    const legCoords = leg.stops_info.map((s: any) => [s.lat, s.lng]);
                    L.polyline(legCoords, {
                        color: '#F97316',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(layerGroup);
                    allCoords.push(...legCoords);
                }
            });
        }

        if (allCoords.length > 0) {
            map.fitBounds(allCoords, { padding: [50, 50] });
        }
    });

    // GPS location updates
    window.addEventListener('USER_LOCATION_UPDATE', (event) => {
        const { lat, lng, focus } = (event as CustomEvent).detail;
        if (!map) return;
        const L = (window as any).L;

        L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'user-location-marker',
                html: '<div class="pulse"></div>',
                iconSize: [20, 20]
            })
        }).addTo(map);

        if (focus) {
            map.setView([lat, lng], 15);
        }
    });

    // Init on load
    if (document.readyState === 'complete') {
        initLeaflet();
    } else {
        window.addEventListener('load', initLeaflet);
    }
    
    // Re-init on view transition
    document.addEventListener('astro:page-load', initLeaflet);
</script>

<style>
/* Dashboard Shell */
.dashboard-container {
    position: fixed;
    inset: 0;
    z-index: 10;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 1rem;
    padding-bottom: calc(5rem + env(safe-area-inset-bottom));
}

.glass-panel-wrapper {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
    transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

/* Map Mode Adjustments */
.dashboard-container.map-mode .glass-panel-wrapper {
    transform: translateY(10%) scale(0.95);
    opacity: 0.9;
}

@media (min-width: 1024px) {
    .dashboard-container {
        justify-content: center;
        align-items: flex-start;
        padding-left: 2rem;
        padding-top: 2rem;
    }
    
    .glass-panel-wrapper {
        margin: 0;
    }
}

/* Animations */
@keyframes fade-in-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in-up {
    animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* User Location Marker */
:global(.user-location-marker) {
    background: none;
    border: none;
}

:global(.user-location-marker .pulse) {
    width: 14px;
    height: 14px;
    background: #3B82F6;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
}

:global(.user-location-marker .pulse::after) {
    content: '';
    position: absolute;
    inset: -4px;
    background: rgba(59, 130, 246, 0.4);
    border-radius: 50%;
    animation: marker-pulse 2s infinite;
}

@keyframes marker-pulse {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(2.5); opacity: 0; }
}
</style>
