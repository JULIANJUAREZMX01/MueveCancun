---
import MainLayout from '../layouts/MainLayout.astro';
import RouteCalculator from '../components/RouteCalculator.astro';

const title = "Dashboard";
---

<MainLayout title={title} useMap={true}>
    <!-- Real Interactive Map (Background Layer) -->
    <div class="fixed inset-0 z-0 h-full w-full">
        <div id="map-container" class="h-full w-full"></div>
    </div>

    <!-- Dashboard Overlay -->
	<div class="dashboard-container pointer-events-none">
		<div class="glass-panel-wrapper animate-fade-in-up pointer-events-auto">
			<RouteCalculator />
		</div>
    </div>

</MainLayout>

<script>
    import { coordinatesStore } from '../lib/CoordinatesStore';

    let map: any;
    let layerGroup: any;

    async function initLeaflet() {
        if(typeof (window as any).L === 'undefined') return;
        const container = document.getElementById('map-container');
        if(!container || (container as any)._leaflet_id) return;

        const L = (window as any).L;
        const isDark = document.documentElement.classList.contains('dark');

        map = L.map('map-container', {
            zoomControl: false,
            attributionControl: false
        }).setView([21.1619, -86.8515], 13);

        L.tileLayer(
            isDark
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            { subdomains: 'abcd', maxZoom: 20 }
        ).addTo(map);

        layerGroup = L.layerGroup().addTo(map);
        
        // Key location markers
        await coordinatesStore.init();
        const db = coordinatesStore.getDB() || {};
        Object.entries(db).forEach(([name, coords]) => {
            if(["El Crucero", "Plaza Las Am√©ricas", "La Rehoyada", "Zona Hotelera"].includes(name)) {
                L.circleMarker(coords, {
                    radius: 5,
                    fillColor: '#F97316',
                    color: '#FFF',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(layerGroup).bindPopup(
                    `<div style="font-family: Inter, sans-serif; font-weight: 700; font-size: 13px;">${name}</div>`
                );
            }
        });
    }

    // Handle View Switching
    window.addEventListener('VIEW_STATE_CHANGE', (e) => {
        const state = (e as CustomEvent).detail;
        const container = document.querySelector('.dashboard-container');
        if (state === 'MAP_ACTIVE') {
            container?.classList.add('map-mode');
        } else {
            container?.classList.remove('map-mode');
        }
        setTimeout(() => map?.invalidateSize(), 400);
    });

    // Route rendering on map
    window.addEventListener('SHOW_ROUTE_ON_MAP', (event) => {
        const data = (event as CustomEvent).detail;
        if (!map || !layerGroup) return;
        const L = (window as any).L;

        layerGroup.clearLayers();
        const allCoords: any[] = [];
        const allLegs = data.legs || [];

        allLegs.forEach((leg: any, legIndex: number) => {
            const legCoords: any[] = [];
            leg.stops_info?.forEach((s: any) => {
                const c = [s.lat, s.lng];
                legCoords.push(c);
                allCoords.push(c);
            });
            
            if(legCoords.length > 0) {
                // Shadow line
                L.polyline(legCoords, {
                    color: '#0f172a', weight: 10, opacity: 0.15,
                    lineJoin: 'round', lineCap: 'round'
                }).addTo(layerGroup);

                // Main line
                const isFirst = legIndex === 0;
                L.polyline(legCoords, {
                    color: isFirst ? '#22C55E' : '#0EA5E9',
                    weight: 5, opacity: 1,
                    dashArray: '12, 16',
                    lineJoin: 'round', lineCap: 'round',
                    className: 'route-line-animated'
                }).addTo(layerGroup);

                // Marker A (Start)
                if (legIndex === 0) {
                    const startIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="map-pin map-pin-start">A</div>`,
                        iconSize: [36, 44], iconAnchor: [18, 44]
                    });
                    L.marker(legCoords[0], { icon: startIcon, zIndexOffset: 1000 }).addTo(layerGroup);
                }

                // Marker B (End)
                if (legIndex === allLegs.length - 1) {
                    const endIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="map-pin map-pin-end">B</div>`,
                        iconSize: [36, 44], iconAnchor: [18, 44]
                    });
                    L.marker(legCoords[legCoords.length - 1], { icon: endIcon, zIndexOffset: 1000 }).addTo(layerGroup);
                }

                // Transfer marker
                if (legIndex < allLegs.length - 1 && legCoords.length > 0) {
                    const transferIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div class="map-pin map-pin-transfer"><span class="material-symbols-rounded text-sm">sync_alt</span></div>`,
                        iconSize: [28, 28], iconAnchor: [14, 14]
                    });
                    L.marker(legCoords[legCoords.length - 1], { icon: transferIcon, zIndexOffset: 900 }).addTo(layerGroup);
                }
            }
        });

        if(allCoords.length > 0) {
            map.fitBounds(allCoords, { padding: [80, 80], maxZoom: 16 });
        }
    });

    // Lifecycle
    document.addEventListener('astro:page-load', () => setTimeout(initLeaflet, 200));
</script>

<style>
	.dashboard-container {
		position: relative;
		min-height: calc(100vh - var(--header-h));
		display: flex;
		flex-direction: column;
		justify-content: space-between;
        padding-top: 1rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
	}

    .dashboard-container.map-mode {
        justify-content: flex-end;
    }
    
    .dashboard-container.map-mode .glass-panel-wrapper {
        transform: translateY(-80px);
        max-height: 40vh;
        overflow-y: auto;
    }

    .dashboard-container.map-mode :global(#search-card) {
        max-height: 0;
        opacity: 0;
        margin-bottom: 0;
        pointer-events: none;
        overflow: hidden;
        transition: all 0.5s ease;
    }

    .dashboard-container.map-mode :global(#results-info) {
        position: sticky;
        top: 0;
        z-index: 60;
    }

    :global(#persistent-map-bg) {
        opacity: 0 !important;
        pointer-events: none !important;
    }

	.glass-panel-wrapper {
		margin: 0 0.75rem;
        z-index: 50;
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
	}

    /* Map marker pins */
    :global(.custom-marker) {
        background: transparent !important;
        border: none !important;
    }

    :global(.map-pin) {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 800;
        font-size: 14px;
        font-family: 'Inter', sans-serif;
    }

    :global(.map-pin-start) { background: #22C55E; }
    :global(.map-pin-end) { background: #EF4444; }
    :global(.map-pin-transfer) {
        background: #F59E0B;
        color: #1F2937;
        width: 26px;
        height: 26px;
        animation: pulse-marker 2s infinite;
    }

    @keyframes dash {
        from { stroke-dashoffset: 0; }
        to { stroke-dashoffset: -28; }
    }

    :global(.route-line-animated) {
        animation: dash 1s linear infinite;
    }

    @keyframes pulse-marker {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.15); }
    }

    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up {
        animation: fade-in-up 0.5s ease-out forwards;
    }
</style>
