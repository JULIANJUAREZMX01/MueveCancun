---
import MainLayout from '../layouts/MainLayout.astro';
import RouteCalculator from '../components/RouteCalculator.astro';
import InteractiveMap from '../components/InteractiveMap.astro';
---

<MainLayout title="Inicio">
  <div class="space-y-6 animate-fade-in relative z-10">
    <!-- Hero / Greeting -->
    <section id="hero-section" class="text-center pt-8 pb-4 transition-all duration-700 ease-in-out">
      <h1 class="text-4xl lg:text-5xl font-display font-black text-deep-navy tracking-tight mb-2 leading-tight">
        Â¿Que ruta me lleva? <br class="sm:hidden" />
        <span id="city-swapper" class="text-primary-500 transition-colors duration-500 inline-block">cancÃºn</span>
      </h1>
      <p class="text-slate-500 font-medium text-lg">
        La guÃ­a oficial de transporte pÃºblico.
      </p>
    </section>

    <!-- Calculator Widget -->
    <section id="calculator-section" class="transition-all duration-700 relative z-20">
      <RouteCalculator />
    </section>

    <!-- Map Island -->
    <section id="map-section" class="relative mt-8 h-64 w-full rounded-2xl overflow-hidden shadow-sm border border-slate-100 transition-all duration-700 ease-in-out z-0">
         <InteractiveMap />
         <div id="map-overlay" class="absolute inset-0 bg-slate-50/10 z-10 cursor-pointer"></div>
    </section>

    <!-- Catalog Link -->
    <section id="catalog-link-section" class="text-center pt-2 transition-opacity duration-500">
      <a href="/rutas" class="inline-flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-primary-600 transition-colors border-b border-transparent hover:border-primary-600 pb-0.5">
        <span>ðŸšŒ</span> Ver todas las rutas
      </a>
    </section>

    <!-- Promo / Info (Subtle) -->
    <section id="promo-section" class="text-center py-8 opacity-60 transition-opacity duration-500">
      <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">
        Powered by RouteEngineâ„¢ v2.2 WASM
      </p>
    </section>
  </div>
</MainLayout>

<script>
    // City Swapper Logic
    const cities = [
        { name: 'cancÃºn', color: '#F97316' }, // Primary Orange
        { name: 'playa del carmen', color: '#0ea5e9' }, // Sky Blue
        { name: 'tulum', color: '#14b8a6' }, // Teal
        { name: 'costa mujeres', color: '#FF8200' }, // Deep Orange
        { name: 'puerto morelos', color: '#8b5cf6' } // Violet
    ];

    let currentIndex = 0;

    function initCitySwapper() {
        const swapper = document.getElementById('city-swapper');
        if (!swapper) return;

        // Clear any existing interval to avoid dupes
        if (window.cityInterval) clearInterval(window.cityInterval);

        window.cityInterval = setInterval(() => {
            currentIndex = (currentIndex + 1) % cities.length;
            const city = cities[currentIndex];

            swapper.style.opacity = '0';
            swapper.style.transform = 'translateY(10px)';

            setTimeout(() => {
                swapper.textContent = city.name;
                swapper.style.color = city.color;
                swapper.style.opacity = '1';
                swapper.style.transform = 'translateY(0)';
            }, 250); // Half of duration

        }, 3000);
    }

    // View Manager Logic
    function initViewManager() {
        window.addEventListener('VIEW_STATE_CHANGE', (e) => {
            const state = (e as CustomEvent).detail;

            if (state === 'MAP_ACTIVE') {
                // Collapse Hero
                const hero = document.getElementById('hero-section');
                if (hero) {
                    hero.classList.add('opacity-0', '-translate-y-10', 'pointer-events-none', 'h-0', 'overflow-hidden', 'py-0');
                    hero.classList.remove('pt-8', 'pb-4');
                }

                // Hide sections
                const catalog = document.getElementById('catalog-link-section');
                if (catalog) catalog.classList.add('opacity-0', 'pointer-events-none');
                const promo = document.getElementById('promo-section');
                if (promo) promo.classList.add('opacity-0', 'pointer-events-none');

                // Expand Map
                const mapSection = document.getElementById('map-section');
                if (mapSection) {
                    mapSection.classList.remove('relative', 'mt-8', 'h-64', 'rounded-2xl', 'shadow-sm', 'border');
                    mapSection.classList.add('fixed', 'inset-0', 'h-screen', 'w-screen', 'z-0', 'rounded-none');
                }
                const mapOverlay = document.getElementById('map-overlay');
                if (mapOverlay) mapOverlay.classList.add('hidden');

                // Trigger Header Tetris
                window.dispatchEvent(new CustomEvent('BRAND_UPDATE', { detail: { phase: 3 } }));

                // Invalidate Map Size
                setTimeout(() => {
                    if (window.map) window.map.invalidateSize();
                }, 800);
            }
            else if (state === 'SEARCH_ACTIVE') {
                // Revert logic (Expand Hero, Shrink Map)
                 const hero = document.getElementById('hero-section');
                if (hero) {
                    hero.classList.remove('opacity-0', '-translate-y-10', 'pointer-events-none', 'h-0', 'overflow-hidden', 'py-0');
                    hero.classList.add('pt-8', 'pb-4');
                }
                const mapSection = document.getElementById('map-section');
                if (mapSection) {
                    mapSection.classList.add('relative', 'mt-8', 'h-64', 'rounded-2xl', 'shadow-sm', 'border');
                    mapSection.classList.remove('fixed', 'inset-0', 'h-screen', 'w-screen', 'z-0', 'rounded-none');
                }
                 const mapOverlay = document.getElementById('map-overlay');
                if (mapOverlay) mapOverlay.classList.remove('hidden');

                // Reset Catalog/Promo visibility
                 const catalog = document.getElementById('catalog-link-section');
                if (catalog) catalog.classList.remove('opacity-0', 'pointer-events-none');
                 const promo = document.getElementById('promo-section');
                if (promo) promo.classList.remove('opacity-0', 'pointer-events-none');
            }
        });

        document.getElementById('map-overlay')?.addEventListener('click', () => {
             if (window.showToast) window.showToast("Traza una ruta para interactuar con el mapa", "info");
        });
    }

    document.addEventListener('astro:page-load', () => {
        initCitySwapper();
        initViewManager();
    });
</script>

<style>
    /* Add transition utility for transform */
    #city-swapper {
        transition-property: color, opacity, transform;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 500ms;
    }
</style>
