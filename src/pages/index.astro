---
import MainLayout from '../layouts/MainLayout.astro';
import RouteCalculator from '../components/RouteCalculator.astro';
import InteractiveMap from '../components/InteractiveMap.astro';
import VerticalHub from '../components/VerticalHub.astro';
---

<MainLayout title="Inicio">

  <!-- Map Layer (Persistent Background) -->
  <div id="map-layer" class="fixed inset-0 z-0" transition:persist>
    <InteractiveMap />
    <!-- Overlay for Map when in Hero Mode (adds tint/blur if needed, or handles click to expand) -->
    <div id="map-overlay" class="absolute inset-0 bg-slate-50/10 backdrop-blur-[2px] z-10 cursor-pointer transition-opacity duration-500"></div>
  </div>

  <!-- UI Layer (Foreground) -->
  <div class="relative z-10 w-full min-h-screen flex flex-col pointer-events-none">

    <!-- Hero / Search Section -->
    <section id="hero-section" class="flex flex-col items-center pt-8 transition-all duration-700 ease-in-out pointer-events-auto">

      <!-- City Rotator Heading -->
      <div id="hero-header" class="text-center mb-6 transition-opacity duration-500">
        <h1 class="text-4xl lg:text-6xl font-display font-black text-deep-navy tracking-tight mb-2 leading-tight drop-shadow-sm">
          ¿Que ruta me lleva? <br class="sm:hidden" />
          <span id="city-swapper" class="text-primary-500 transition-colors duration-500 inline-block filter drop-shadow-sm">cancún</span>
        </h1>
        <p class="text-slate-500 font-medium text-lg lg:text-xl max-w-md mx-auto leading-relaxed">
          La guía oficial de transporte público.
        </p>
      </div>

      <!-- Search Widget Container -->
      <div id="search-container" class="w-full max-w-md px-4 transition-all duration-700 ease-in-out transform translate-y-0">
        <RouteCalculator />
      </div>

    </section>

    <!-- Vertical Hub (Results Sidebar) -->
    <VerticalHub />

  </div>

</MainLayout>

<script>
    // City Swapper Logic
    const cities = [
        { name: 'cancún', color: '#F97316' }, // Primary Orange
        { name: 'playa del carmen', color: '#0ea5e9' }, // Sky Blue
        { name: 'tulum', color: '#14b8a6' }, // Teal
        { name: 'costa mujeres', color: '#FF8200' }, // Deep Orange
        { name: 'puerto morelos', color: '#8b5cf6' } // Violet
    ];

    let currentIndex = 0;

    function initCitySwapper() {
        const swapper = document.getElementById('city-swapper');
        if (!swapper) return;

        // Clear any existing interval to avoid dupes
        if (window.cityInterval) clearInterval(window.cityInterval);

        window.cityInterval = setInterval(() => {
            currentIndex = (currentIndex + 1) % cities.length;
            const city = cities[currentIndex];

            swapper.style.opacity = '0';
            swapper.style.transform = 'translateY(10px)';

            setTimeout(() => {
                swapper.textContent = city.name;
                swapper.style.color = city.color;
                swapper.style.opacity = '1';
                swapper.style.transform = 'translateY(0)';
            }, 250);

        }, 3000);
    }

    // View Manager Logic
    function initViewManager() {
        // Initial state check?
        // If we navigated back, maybe we want to reset?
        // For now, default is Hero visible.

        const handleViewState = (e) => {
            const state = e.detail.state || e.detail; // Handle object or string

            const heroHeader = document.getElementById('hero-header');
            const searchContainer = document.getElementById('search-container');
            const mapOverlay = document.getElementById('map-overlay');
            const mapLayer = document.getElementById('map-layer');

            if (state === 'map' || state === 'MAP_ACTIVE') {
                // Hide Header
                if (heroHeader) {
                    heroHeader.classList.add('opacity-0', '-translate-y-20', 'pointer-events-none', 'absolute');
                }

                // Move Search Container?
                // Actually, VerticalHub replaces the search container for results.
                // But we might want to keep the search bar visible?
                // For this version ("Grand Merge"), let's fade out the main search
                // and assume VerticalHub has its own controls or displays the query.

                if (searchContainer) {
                    searchContainer.classList.add('opacity-0', 'translate-y-20', 'pointer-events-none');
                    // Optional: scale down
                }

                // Expand Map (Remove Overlay)
                if (mapOverlay) {
                    mapOverlay.classList.add('opacity-0', 'pointer-events-none');
                }

                // Map Layer is already full screen, just fully interactive now
            }
            else if (state === 'search' || state === 'SEARCH_ACTIVE') {
                // Restore Hero
                if (heroHeader) {
                    heroHeader.classList.remove('opacity-0', '-translate-y-20', 'pointer-events-none', 'absolute');
                }
                if (searchContainer) {
                    searchContainer.classList.remove('opacity-0', 'translate-y-20', 'pointer-events-none');
                }
                if (mapOverlay) {
                    mapOverlay.classList.remove('opacity-0', 'pointer-events-none');
                }
            }
        };

        window.addEventListener('VIEW_STATE_CHANGE', handleViewState);

        // Map Overlay Click -> Expand Map (Optional "Explore Mode")
        document.getElementById('map-overlay')?.addEventListener('click', () => {
             // For now, just hint.
             // Or we could trigger 'map' state without search?
             // window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: 'map' }));
             if (window.showToast) window.showToast("Realiza una búsqueda para ver rutas", "info");
        });
    }

    document.addEventListener('astro:page-load', () => {
        initCitySwapper();
        initViewManager();
    });
</script>

<style>
    #city-swapper {
        transition-property: color, opacity, transform;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 500ms;
    }
</style>
