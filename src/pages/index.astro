---
import MainLayout from '../layouts/MainLayout.astro';
import RouteCalculator from '../components/RouteCalculator.astro';
import VerticalHub from '../components/VerticalHub.astro';
---

<MainLayout title="Inicio">

  <!-- Compact Summary Bar -->
  <div id="summary-bar" class="fixed left-4 right-4 z-[60] transition-transform duration-500 flex justify-center pointer-events-none bottom-20 lg:bottom-auto lg:top-24">
      <div class="bg-white/90 backdrop-blur-md shadow-lg shadow-slate-200/50 rounded-full px-4 py-2.5 flex items-center gap-4 border border-slate-200/60 pointer-events-auto max-w-md w-full justify-between">
          <div class="flex items-center gap-2 overflow-hidden flex-1">
             <div class="flex items-center gap-1.5 min-w-0 shrink">
                <span class="text-xs text-slate-400 shrink-0">üìç</span>
                <span id="sb-origin" class="text-xs font-bold text-slate-700 truncate block max-w-[80px] sm:max-w-[100px]">Origen</span>
             </div>
             <span class="text-slate-300 text-[10px] shrink-0">‚ûî</span>
             <div class="flex items-center gap-1.5 min-w-0 shrink">
                <span class="text-xs text-slate-400 shrink-0">üèÅ</span>
                <span id="sb-dest" class="text-xs font-bold text-slate-700 truncate block max-w-[80px] sm:max-w-[100px]">Destino</span>
             </div>
          </div>

          <button id="sb-edit-btn" class="shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 hover:bg-primary-50 text-slate-400 hover:text-primary-500 border border-slate-100 transition-colors active:scale-95" title="Editar b√∫squeda">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" />
              </svg>
          </button>
      </div>
  </div>

  <!-- DESKTOP VIEW: Floating Dock -->
  <aside id="desktop-dock" class="hidden lg:flex flex-col fixed left-5 top-24 bottom-5 w-[420px] z-20 gap-4 pointer-events-none transition-opacity duration-300">
     <!-- Search -->
     <div id="desktop-search-card" class="pointer-events-auto shadow-2xl rounded-3xl transition-all duration-300">
       <RouteCalculator />
     </div>

     <!-- Results Hub -->
     <div id="desktop-results-card" class="flex-1 min-h-0 glass-panel rounded-3xl pointer-events-auto overflow-hidden flex flex-col backdrop-blur-xl bg-white/80 dark:bg-slate-900/80 border border-white/20 transition-all duration-300">
       <VerticalHub />
     </div>
  </aside>

  <!-- MOBILE VIEW: Bottom Sheet Strategy -->
  <div id="mobile-view-manager" class="lg:hidden pointer-events-none fixed inset-0 z-30 flex flex-col justify-end">

      <!-- Search Sheet (Always visible at bottom) -->
      <div id="mobile-search-sheet" class="pointer-events-auto p-4 pb-6 transition-transform duration-500 transform translate-y-0 z-40">
          <RouteCalculator />
      </div>

      <!-- Results Drawer -->
      <div id="mobile-results-drawer" class="fixed inset-x-0 bottom-0 h-[70vh] bg-white dark:bg-slate-900 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] transform translate-y-[110%] transition-transform duration-500 cubic-bezier(0.32, 0.72, 0, 1) z-50 flex flex-col pointer-events-auto">

          <!-- Handle -->
          <div class="w-full p-3 flex justify-center items-center border-b border-slate-100 dark:border-slate-800 cursor-pointer" id="drawer-handle">
              <div class="w-12 h-1.5 bg-slate-300 dark:bg-slate-600 rounded-full"></div>
          </div>

          <!-- Content -->
          <div class="flex-1 overflow-hidden relative">
              <VerticalHub />
          </div>
      </div>
  </div>

  <script>
    // Elements
    const summaryBar = document.getElementById('summary-bar');
    const sbOrigin = document.getElementById('sb-origin');
    const sbDest = document.getElementById('sb-dest');
    const sbEditBtn = document.getElementById('sb-edit-btn');

    const desktopDock = document.getElementById('desktop-dock');
    const desktopSearchCard = document.getElementById('desktop-search-card');
    const desktopResultsCard = document.getElementById('desktop-results-card');
    const mobileSearchSheet = document.getElementById('mobile-search-sheet');
    const mobileResultsDrawer = document.getElementById('mobile-results-drawer');
    const drawerHandle = document.getElementById('drawer-handle');

    // State Management
    window.addEventListener('VIEW_STATE_CHANGE', (e) => {
        const state = e.detail.state;

        if (state === 'map') {
            // Hide Search UI but keep Results Visible
            desktopSearchCard?.classList.add('hidden');
            mobileSearchSheet?.classList.add('translate-y-[200%]'); // Move down offscreen

            // Show Summary Bar
            summaryBar?.classList.add('is-visible');
        } else if (state === 'search') {
            // Show Search UI
            desktopSearchCard?.classList.remove('hidden');
            desktopDock?.classList.remove('opacity-0', 'pointer-events-none'); // Ensure dock is visible
            mobileSearchSheet?.classList.remove('translate-y-[200%]');

            // Hide Summary Bar
            summaryBar?.classList.remove('is-visible');

            // Hide Results Drawer on Mobile (optional, but cleaner)
            mobileResultsDrawer?.classList.add('translate-y-[110%]');
        }
    });

    window.addEventListener('SEARCH_COMPLETED', (e) => {
        const { query } = e.detail;
        if (query) {
            if (sbOrigin) sbOrigin.textContent = query.from || 'Origen';
            if (sbDest) sbDest.textContent = query.to || 'Destino';
        }

        // Mobile: Slide up the drawer (Upstream Logic preserved)
        if (window.innerWidth < 1024 && mobileResultsDrawer) {
            mobileResultsDrawer.classList.remove('translate-y-[110%]');
            mobileResultsDrawer.classList.add('translate-y-0');
        }
    });

    sbEditBtn?.addEventListener('click', () => {
        window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: { state: 'search' } }));
    });

    // Close/Collapse Drawer Logic
    drawerHandle?.addEventListener('click', () => {
        mobileResultsDrawer?.classList.add('translate-y-[110%]');
        mobileResultsDrawer?.classList.remove('translate-y-0');
    });

    // Also listen to CLEAR_MAP to hide drawer and restore search
    window.addEventListener('CLEAR_MAP', () => {
        mobileResultsDrawer?.classList.add('translate-y-[110%]');
        mobileResultsDrawer?.classList.remove('translate-y-0');
        window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: { state: 'search' } }));
    });

    // Hub Close Button logic (from VerticalHub)
    const closeBtn = document.getElementById('hub-close-btn');
    closeBtn?.addEventListener('click', () => {
         // Also restore search view when closing hub
         window.dispatchEvent(new CustomEvent('VIEW_STATE_CHANGE', { detail: { state: 'search' } }));
    });

  </script>

  <style>
    #summary-bar {
        transform: translateY(200%); /* Mobile: hidden (down) */
    }
    @media (min-width: 1024px) {
        #summary-bar {
            transform: translateY(-200%); /* Desktop: hidden (up) */
        }
    }
    #summary-bar.is-visible {
        transform: translateY(0) !important;
    }
  </style>
</MainLayout>
