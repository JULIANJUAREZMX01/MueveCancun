---
import MainLayout from '../layouts/MainLayout.astro';
import RouteCalculator from '../components/RouteCalculator.astro';
import InteractiveMap from '../components/InteractiveMap.astro';
---

<MainLayout title="Inicio">
  <!-- View Manager Container -->
  <div id="view-manager" class="view-search relative min-h-[calc(100vh-80px)]">

    <!-- Hero & Search State -->
    <div id="search-view" class="space-y-8 animate-fade-in transition-all duration-500">
      <!-- Hero / Greeting -->
      <section class="text-center pt-6 pb-2">
        <h1 class="text-3xl font-display font-black text-deep-navy tracking-tight mb-2 flex justify-center">
          <span class="brand-container" data-original="true">Canc√∫n<span class="text-primary-500">Mueve</span></span>
        </h1>
        <p class="text-slate-500 font-medium">
          Encuentra la mejor ruta en transporte p√∫blico.
        </p>
      </section>

      <!-- Calculator Widget -->
      <section class="relative z-10">
        <RouteCalculator />
      </section>

      <!-- Catalog Link -->
      <section class="text-center pt-2">
        <a href="/rutas" class="inline-flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-primary-600 transition-colors border-b border-transparent hover:border-primary-600 pb-0.5">
          <span>üöå</span> Ver todas las rutas
        </a>
      </section>

      <!-- Promo / Info (Subtle) -->
      <section class="text-center py-8 opacity-60">
        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">
          Powered by RouteEngine‚Ñ¢ v2.2 WASM
        </p>
      </section>
    </div>

    <!-- Map State (Hidden initially) -->
    <div id="map-view" class="hidden absolute inset-0 z-0 bg-slate-50 pt-2 flex-col h-full animate-fade-in">
       <div class="flex-1 relative w-full h-full">
          <InteractiveMap />
       </div>
       <!-- Floating Close Button for Map View -->
       <button id="close-map-btn" class="absolute bottom-24 right-4 z-[1001] bg-white text-slate-800 p-3 rounded-full shadow-xl border border-slate-200 font-bold flex items-center gap-2 hover:bg-slate-50 active:scale-95 transition-transform">
          <span>‚ùå</span> Cerrar Mapa
       </button>
    </div>

  </div>

  <script is:inline>
    // View Manager Logic
    window.handleViewChange = window.handleViewChange || ((state) => {
        const searchView = document.getElementById('search-view');
        const mapView = document.getElementById('map-view');
        const mainContainer = document.querySelector('main'); // Astro main container

        if (state === 'MAP') {
            searchView.classList.add('hidden');
            mapView.classList.remove('hidden');
            mapView.classList.add('flex'); // Enable flex layout

            // Expand main container
            if (mainContainer) mainContainer.classList.add('!max-w-none', '!px-0', '!pt-16');

            // Trigger Map Resize
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
                // Specific event for InteractiveMap if needed, but resize usually handles Leaflet
                const mapContainer = document.getElementById('map-container');
                if (mapContainer && window.map) {
                   window.map.invalidateSize();
                }
            }, 100);

        } else { // SEARCH
            mapView.classList.add('hidden');
            mapView.classList.remove('flex');
            searchView.classList.remove('hidden');

            // Restore main container
            if (mainContainer) mainContainer.classList.remove('!max-w-none', '!px-0', '!pt-16');
        }
    });

    // Event Listeners for State Changes
    document.addEventListener('astro:page-load', () => {
        window.addEventListener('CHANGE_VIEW', (e) => {
            window.handleViewChange(e.detail.state);
        });

        document.getElementById('close-map-btn')?.addEventListener('click', () => {
            window.handleViewChange('SEARCH');
        });

        // Intercept SHOW_ROUTE_ON_MAP to switch view automatically
        window.addEventListener('SHOW_ROUTE_ON_MAP', () => {
             window.handleViewChange('MAP');
        });
    });

    // ---------------------------------------------------------
    // Legacy Brand Update Logic (Preserved & Globalized)
    // ---------------------------------------------------------
    window.handleBrandUpdate = window.handleBrandUpdate || ((e) => {
        const phase = e.detail.phase;
        const containers = document.querySelectorAll('.brand-container');

        containers.forEach(container => {
            if (phase === 1) {
                if (container.dataset.phase === '1') return;
                container.innerHTML = `Canc√∫n<span class="text-[#006847] animate-pop-in inline-block mx-[1px]">EN</span><span class="text-primary-500">Mueve</span>`;
                container.dataset.phase = '1';
            } else if (phase === 2) {
                if (container.dataset.phase === '2') return;
                container.innerHTML = `Canc√∫n<span class="text-[#006847] mx-[1px]">EN</span><span class="text-primary-500">Mueve</span><span class="text-[#CE1126] animate-pop-in inline-block">TE</span>`;
                container.dataset.phase = '2';
            } else if (phase === 3) {
                if (container.dataset.phase === '3') return;
                container.innerHTML = `
                  <div class="flex items-center gap-1.5 leading-none">
                      <span class="text-[#006847] animate-tetris-1">¬°MUEVETE</span>
                      <span class="text-slate-900 bg-white border border-slate-900 px-1 rounded text-[0.8em] animate-tetris-2 self-center">EN</span>
                      <span class="text-[#CE1126] animate-tetris-3">CANCUN!</span>
                  </div>
                `;
                container.dataset.phase = '3';
            }
        });
    });

    document.addEventListener('astro:page-load', () => {
        window.removeEventListener('BRAND_UPDATE', window.handleBrandUpdate);
        window.addEventListener('BRAND_UPDATE', window.handleBrandUpdate);
    });
  </script>

  <style is:global>
    @keyframes pop-in {
      0% { transform: scale(0); opacity: 0; }
      80% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); }
    }
    .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

    @keyframes fall-down {
      0% { transform: translateY(-20px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    .animate-tetris-1 { animation: fall-down 0.5s ease-out forwards; display: inline-block; }
    .animate-tetris-2 { animation: fall-down 0.5s ease-out 0.2s forwards; opacity: 0; display: inline-block; }
    .animate-tetris-3 { animation: fall-down 0.5s ease-out 0.4s forwards; opacity: 0; display: inline-block; }
  </style>
</MainLayout>
