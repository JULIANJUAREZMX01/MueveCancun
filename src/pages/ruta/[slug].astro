---
export const prerender = true;
import MainLayout from '../../layouts/MainLayout.astro';
import routesData from '../../data/routes.json';

export async function getStaticPaths() {
  const routes = routesData.rutas;

  const slugify = (text) => {
    return text
      .toString()
      .toLowerCase()
      .normalize('NFD') // Remove accents
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, '-')
      .replace(/[^\w\-]+/g, '')
      .replace(/\-\-+/g, '-')
      .replace(/^-+/, '')
      .replace(/-+$/, '');
  };

  const slugMap = new Map();

  routes.forEach(route => {
    let origin = "Origen";
    let destination = "Destino";

    // Logic to determine Origin/Destination names
    // Prioritize "paradas" array
    if (route.paradas && route.paradas.length > 0) {
       const first = route.paradas[0];
       const last = route.paradas[route.paradas.length - 1];
       origin = first.nombre || first.parada || "Inicio";
       destination = last.nombre || last.parada || "Fin";

       // Heuristic: If origin name contains "La Rehoyada / Villas Otoch", simplify?
       // For now, keep full name to be precise, slugify handles the rest.
    } else {
        // Fallback or skip
        return;
    }

    const slug = `de-${slugify(origin)}-a-${slugify(destination)}`;

    if (!slugMap.has(slug)) {
        slugMap.set(slug, { originName: origin, destinationName: destination, routes: [] });
    }
    slugMap.get(slug).routes.push(route);
  });

  return Array.from(slugMap.entries()).map(([slug, data]) => {
      return {
          params: { slug },
          props: data
      };
  });
}

const { routes, originName, destinationName } = Astro.props;

const mainRoute = routes[0]; // Use the first route for main metadata if multiple
const title = `Ruta de ${originName} a ${destinationName} | Canc√∫n Mueve`;
const description = `Descubre c√≥mo llegar de ${originName} a ${destinationName}. ${routes.length} ruta(s) disponible(s) con horarios y tarifas actualizadas.`;

// JSON-LD for the first route (or list?)
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BusTrip",
  "name": mainRoute.nombre,
  "departureStation": {
    "@type": "BusStation",
    "name": originName
  },
  "arrivalStation": {
    "@type": "BusStation",
    "name": destinationName
  },
  "provider": {
    "@type": "Organization",
    "name": "Canc√∫n Mueve"
  },
  "description": description
};
---


<MainLayout title={title} description={description}>
  <div class="space-y-6">
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-2xl font-display font-black text-deep-navy mb-2 leading-tight">
            ¬øC√≥mo llegar de {originName} a {destinationName}?
        </h1>
        <p class="text-slate-500 font-medium text-sm">
            Encontramos <span class="font-bold text-primary-600">{routes.length} opci√≥n(es)</span> de transporte directo.
        </p>
    </div>

    {routes.map(route => (
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-primary-500">
            <div class="border-b border-slate-100 pb-4 mb-4">
                <h2 class="text-lg font-bold text-deep-navy mb-1">{route.nombre}</h2>
                <div class="flex gap-2">
                    {route.tipo_transporte && (
                        <span class="inline-block px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 text-[10px] font-bold uppercase">
                            {route.tipo_transporte.replace('_', ' ')}
                        </span>
                    )}
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-50 p-3 rounded-lg">
                    <span class="block text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Tarifa</span>
                    <span class="text-xl font-bold text-deep-navy">${route.tarifa} <span class="text-xs font-normal">{route.moneda || 'MXN'}</span></span>
                </div>
                <div class="bg-slate-50 p-3 rounded-lg">
                    <span class="block text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Frecuencia</span>
                    <span class="text-xl font-bold text-deep-navy">{route.frecuencia_minutos} min</span>
                </div>
            </div>

            {route.horario && (
                <div class="mb-6">
                    <h3 class="font-bold text-deep-navy mb-2 flex items-center gap-2 text-sm">
                        ‚è±Ô∏è Horario
                    </h3>
                    <div class="bg-slate-50 p-3 rounded-lg text-xs text-slate-600">
                        {typeof route.horario === 'string' ? route.horario : (
                            <ul class="space-y-1">
                                <li><span class="font-bold">Inicio:</span> {route.horario.inicio || route.horario.inicio_oficial}</li>
                                <li><span class="font-bold">Fin:</span> {route.horario.fin || route.horario.fin_oficial}</li>
                                {route.horario.guardia_nocturna && (
                                    <li class="text-orange-600 font-medium mt-1">üåô Guardia Nocturna: {route.horario.guardia_nocturna}</li>
                                )}
                            </ul>
                        )}
                    </div>
                </div>
            )}

            <div class="mb-4">
                 <details class="group">
                    <summary class="flex justify-between items-center font-medium cursor-pointer list-none text-sm text-primary-600 hover:text-primary-700">
                        <span>Ver paradas ({route.paradas.length})</span>
                        <span class="transition group-open:rotate-180">
                            <svg fill="none" height="24" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M6 9l6 6 6-6"></path></svg>
                        </span>
                    </summary>
                    <div class="text-slate-600 mt-3 group-open:animate-fadeIn">
                        <div class="relative pl-4 border-l-2 border-slate-200 space-y-4">
                            {route.paradas.map((parada, index) => (
                                <div class="relative">
                                    <div class={`absolute -left-[21px] top-1.5 w-3 h-3 rounded-full border-2 border-white shadow-sm ${index === 0 ? 'bg-green-500' : index === route.paradas.length - 1 ? 'bg-red-500' : 'bg-slate-300'}`}></div>
                                    <p class="font-bold text-slate-700 text-xs">{parada.nombre || parada.parada}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </details>
            </div>
        </div>
    ))}

    <div class="pt-4">
        <a href="/" class="block w-full bg-primary-500 hover:bg-primary-600 text-white font-bold text-center py-3 rounded-xl transition-colors shadow-lg shadow-primary-500/30">
            üîç Buscar otra ruta en el mapa
        </a>
    </div>
  </div>

  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
</MainLayout>
