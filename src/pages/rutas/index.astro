---
import MainLayout from '../../layouts/MainLayout.astro';
import { getAllRoutes } from '../../lib/routes';
import { getTransportLabel } from '../../lib/transport';

const rawRoutes = await getAllRoutes();

// Types for UI transformation
interface UIRoute {
  id: string;
  name: string;
  price: number;
  transport_type: string;
  operator?: string;
  frequency?: string;
  schedule?: string;
  duration?: string;
  badges: string[];
  stops: string[];
  origin_hub?: string;
  dest_hub?: string;
}



const transformRoute = (raw: any): UIRoute => {
  let transport_type = raw.tipo_transporte || raw.tipo || "Bus";
  
  // Format Schedule
  let schedule = "06:00 - 23:00"; // Default
  if (raw.horario) {
     if (typeof raw.horario === 'string') {
        schedule = raw.horario;
     } else {
        const start = raw.horario.inicio || raw.horario.inicio_oficial || "06:00";
        const end = raw.horario.fin || raw.horario.fin_oficial || "23:00";
        schedule = `${start} - ${end}`;
     }
  }

  const stops = raw.paradas ? raw.paradas.map((p: any) => p.nombre || p.parada) : [];

  return {
    id: raw.id,
    name: raw.nombre,
    price: raw.tarifa || 15,
    transport_type,
    operator: raw.operador || raw.empresa || "Consorcio Urbano",
    frequency: raw.frecuencia_minutos ? `${raw.frecuencia_minutos} min` : "10 min",
    schedule,
    duration: raw.duracion_minutos ? `${raw.duracion_minutos} min` : "45 min est.",
    badges: raw.tags || raw.social_alerts || [],
    stops,
    origin_hub: stops[0] || "Origen",
    dest_hub: stops[stops.length - 1] || "Destino"
  };
};

const routes: UIRoute[] = rawRoutes.map(transformRoute);
---

<MainLayout title="Catálogo de Rutas">
  <div class="space-y-6 animate-fade-in pb-20">
    <!-- Header -->
    <div class="pt-6">
      <h1 class="text-3xl font-display font-black text-slate-900 dark:text-slate-100 tracking-tight mb-1">
        Red de Transporte
      </h1>
      <p class="text-slate-600 dark:text-slate-300 font-medium text-sm">
        Explora las {routes.length} rutas oficiales de Cancún y Riviera Maya.
      </p>
    </div>

    <!-- List Container -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       {routes.map(route => {
          let stopsPreview = `${route.origin_hub} ➔ ${route.dest_hub}`; // Updated arrow to match previous rendering if needed, but keeping consistent with what I saw

          return (
          <a href={`/ruta/${route.id}`} class="glass-card p-5 group hover:border-primary-300 transition-all active:scale-[0.98] no-underline block overflow-hidden relative stagger-item" style={`animation-delay: ${routes.indexOf(route) * 60}ms`}>
            
            <!-- Background Badge (inline SVG instead of material icon font) -->
            <div class="absolute -right-4 -top-4 opacity-[0.03] group-hover:opacity-[0.08] transition-opacity">
                <svg width="96" height="96" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4S4 2.5 4 6v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6H6V6h12v5z"/></svg>
            </div>

            <div class="flex justify-between items-start relative z-10">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-2">
                    <span class="px-2 py-0.5 rounded-md bg-primary-100 text-primary-700 text-[10px] font-black uppercase tracking-widest">
                      {route.id}
                    </span>
                    <span class="text-[10px] font-bold text-slate-600 dark:text-slate-400 uppercase tracking-widest">
                      {getTransportLabel(route.transport_type)}
                    </span>
                </div>
                
                <h3 class="font-bold text-slate-900 dark:text-slate-100 group-hover:text-primary-600 transition-colors truncate pr-4">{route.name}</h3>

                <!-- Meta Info Row -->
                <div class="mt-3 flex flex-wrap gap-x-4 gap-y-2 text-[10px] font-bold text-slate-600 dark:text-slate-400 uppercase tracking-tighter">
                    <div class="flex items-center gap-1">
                        <svg class="w-3.5 h-3.5 text-slate-400 dark:text-slate-500" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M13.05 9.79L10 7.5v-6h2v4.59l2.59 1.96-1.54 1.74zM12 2C6.49 2 2 6.49 2 12s4.49 10 10 10 10-4.49 10-10S17.51 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                        <span>{route.frequency}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <svg class="w-3.5 h-3.5 text-slate-400 dark:text-slate-500" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                        <span>{route.schedule}</span>
                    </div>
                </div>
              </div>

              <div class="text-right shrink-0">
                <div class="text-xl font-black text-emerald-600 dark:text-emerald-400 font-mono">
                    ${route.price}<span class="text-xs">.00</span>
                </div>
                <div class="text-[9px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-tighter">EFECTIVO</div>
              </div>
            </div>

            <!-- Stops Preview -->
            <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between">
                <div class="flex items-center gap-1.5 min-w-0">
                    <svg class="w-3 h-3 text-primary-500 shrink-0" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                    <span class="text-[11px] font-medium text-slate-600 dark:text-slate-400 truncate italic">{stopsPreview}</span>
                </div>
                <svg class="w-5 h-5 text-slate-400 dark:text-slate-500 group-hover:text-primary-500 group-hover:translate-x-1 transition-all shrink-0" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </div>
          </a>
          );
       })}
    </div>

  </div>
</MainLayout>

<style>
  .animate-fade-in {
    animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
