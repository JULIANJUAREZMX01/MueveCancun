---
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="Mi Tarjeta">
  <div class="space-y-8 animate-fade-in pb-10">
    
    <!-- Balance Card Section -->
    <section class="relative group max-w-xl mx-auto">
      <div class="absolute -inset-1 bg-gradient-to-r from-primary-600 to-primary-400 rounded-3xl blur opacity-25 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
      
      <div class="relative bg-slate-900 rounded-3xl p-8 shadow-2xl overflow-hidden border border-slate-800">
        <!-- Abstract patterns -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-primary-500/10 rounded-full -mr-32 -mt-32 blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-500/10 rounded-full -ml-24 -mb-24 blur-3xl"></div>
        
        <div class="relative z-10 flex flex-col h-full justify-between">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Saldo Disponible</p>
              <h2 id="balance-amount" class="text-5xl font-black text-white tracking-tighter">$180.00</h2>
              <p class="text-xs text-slate-500 font-bold mt-1">MXN Peso Mexicano</p>
            </div>
            <div class="px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-black rounded-full uppercase tracking-wider">
              Activo
            </div>
          </div>

          <div class="mt-12 flex gap-4">
            <button id="open-recharge" class="flex-1 bg-white hover:bg-slate-100 text-slate-900 font-black py-4 rounded-2xl transition-all active:scale-95 shadow-xl shadow-white/5">
              RECARGAR
            </button>
            <button class="px-6 bg-slate-800 hover:bg-slate-700 text-white font-black py-4 rounded-2xl transition-all active:scale-95 border border-slate-700">
              <span class="text-xl">ðŸ“Š</span>
            </button>
          </div>
        </div>
        
        <!-- Animated Wave (Decorative) -->
        <div class="absolute -bottom-4 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-primary-500/50 to-transparent blur-sm"></div>
      </div>
    </section>

    <!-- Recent Transactions -->
    <section class="max-w-xl mx-auto">
      <div class="flex items-center justify-between mb-4 px-2">
        <h3 class="text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Ãšltimos Movimientos</h3>
        <button class="text-[10px] font-black text-primary-600 dark:text-primary-400 uppercase tracking-wider">Ver Todo</button>
      </div>

      <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
        <div id="transactions-container">
          <div class="p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl flex items-center justify-center text-emerald-600 dark:text-emerald-400 text-lg">
                ðŸ’¸
              </div>
              <div>
                <p class="text-sm font-bold text-slate-800 dark:text-slate-200">Recarga mediante OXXO</p>
                <p class="text-[10px] font-medium text-slate-400 dark:text-slate-500 lowercase">Hoy, 10:24 am</p>
              </div>
            </div>
            <span class="text-sm font-black text-emerald-600 dark:text-emerald-400">+$100.00</span>
          </div>
          
          <div class="p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-center text-slate-600 dark:text-slate-400 text-lg">
                ðŸšŒ
              </div>
              <div>
                <p class="text-sm font-bold text-slate-800 dark:text-slate-200">Ruta R-2 (Mercado 28)</p>
                <p class="text-[10px] font-medium text-slate-400 dark:text-slate-500 lowercase">Ayer, 06:15 pm</p>
              </div>
            </div>
            <span class="text-sm font-black text-slate-900 dark:text-white">-$12.00</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Monthly Stats -->
    <section class="max-w-xl mx-auto grid grid-cols-2 gap-4">
      <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm text-center">
        <p class="text-2xl font-black text-primary-500">12</p>
        <p class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mt-1">Viajes este mes</p>
      </div>
      <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm text-center">
        <p class="text-2xl font-black text-emerald-500">4.8</p>
        <p class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mt-1">Rating de PuntuaciÃ³n</p>
      </div>
    </section>

  </div>

  <!-- Recharge Dialog -->
  <dialog id="recharge-dialog" class="bg-white dark:bg-slate-900 rounded-3xl p-0 shadow-2xl w-[90%] max-w-sm border border-slate-200 dark:border-slate-800 backdrop:bg-slate-900/50 backdrop:backdrop-blur-sm overflow-hidden translate-y-4 open:translate-y-0 transition-transform duration-300">
    <div class="p-6">
      <h3 class="text-xl font-black text-slate-800 dark:text-white mb-2">Recargar Saldo</h3>
      <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">El monto se acreditarÃ¡ instantÃ¡neamente a tu billetera virtual.</p>
      
      <div class="grid grid-cols-3 gap-3 mb-8">
        <button class="amount-option py-4 rounded-xl border-2 border-slate-100 dark:border-slate-800 font-black text-slate-600 dark:text-slate-400 hover:border-primary-500 active:scale-95 transition-all outline-none" data-amount="20">$20</button>
        <button class="amount-option py-4 rounded-xl border-2 border-primary-500 bg-primary-50/50 dark:bg-primary-900/20 font-black text-primary-600 dark:text-primary-400 active:scale-95 transition-all outline-none" data-amount="50" id="default-amount">$50</button>
        <button class="amount-option py-4 rounded-xl border-2 border-slate-100 dark:border-slate-800 font-black text-slate-600 dark:text-slate-400 hover:border-primary-500 active:scale-95 transition-all outline-none" data-amount="100">$100</button>
      </div>

      <div class="flex flex-col gap-3">
        <button id="confirm-recharge" class="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-4 rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all uppercase tracking-widest">
          CONFIRMAR PAGO
        </button>
        <button id="close-recharge" class="w-full bg-transparent text-slate-400 dark:text-slate-500 py-2 font-bold text-xs uppercase tracking-widest">
          CANCELAR
        </button>
      </div>
    </div>
  </dialog>

  <script>
    import { getWalletBalance, setWalletBalance, updateWalletBalance } from '../utils/db';

    async function setupWallet() {
      const balanceAmount = document.getElementById('balance-amount');
      const openBtn = document.getElementById('open-recharge');
      const closeBtn = document.getElementById('close-recharge');
      const dialog = document.getElementById('recharge-dialog') as HTMLDialogElement;
      const confirmBtn = document.getElementById('confirm-recharge');
      const amountOptions = document.querySelectorAll('.amount-option');

      let selectedAmount = 50;

      async function updateBalanceUI() {
          // Use IndexedDB as single source of truth
          const walletData = await getWalletBalance();
          const balance = walletData?.amount ?? 180.00;
          if (balanceAmount) balanceAmount.textContent = `$${balance.toFixed(2)}`;
      }

      // Initial load - wait for IndexedDB to be ready
      await updateBalanceUI();

      openBtn?.addEventListener('click', () => dialog?.showModal());
      closeBtn?.addEventListener('click', () => dialog?.close());

      amountOptions.forEach(opt => {
          opt.addEventListener('click', () => {
              amountOptions.forEach(o => o.classList.remove('border-primary-500', 'bg-primary-50/50', 'dark:bg-primary-900/20', 'text-primary-600', 'dark:text-primary-400'));
              amountOptions.forEach(o => o.classList.add('border-slate-100', 'dark:border-slate-800', 'text-slate-600', 'dark:text-slate-400'));

              opt.classList.remove('border-slate-100', 'dark:border-slate-800', 'text-slate-600', 'dark:text-slate-400');
              opt.classList.add('border-primary-500', 'bg-primary-50/50', 'dark:bg-primary-900/20', 'text-primary-600', 'dark:text-primary-400');

              selectedAmount = parseInt(opt.getAttribute('data-amount') || '50');
          });
      });

      confirmBtn?.addEventListener('click', async () => {
          // Use IndexedDB as single source of truth
          const walletData = await getWalletBalance();
          const currentBalance = walletData?.amount ?? 180.00;
          const newBalance = currentBalance + selectedAmount;

          // Update IndexedDB
          await setWalletBalance(newBalance);

          // Update UI
          if (balanceAmount) balanceAmount.textContent = `$${newBalance.toFixed(2)}`;

          // Dispatch Global Sync Event
          window.dispatchEvent(new CustomEvent('BALANCE_UPDATED'));

          dialog?.close();

          if (window.showToast) {
            window.showToast(`Â¡Recarga exitosa! +$${selectedAmount}`, "success");
          }
      });
    }

    document.addEventListener('astro:page-load', setupWallet);
    if (document.readyState === 'complete') setupWallet();
    else window.addEventListener('load', setupWallet);
  </script>
</MainLayout>
