---
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="Mi Tarjeta">
  <div class="space-y-8 animate-fade-in pb-10">
    
    <!-- Balance Card Section -->
    <section class="relative group max-w-xl mx-auto">
      <div class="absolute -inset-1 bg-gradient-to-r from-primary-600 to-primary-400 rounded-3xl blur opacity-25 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
      
      <div class="relative bg-slate-900 rounded-3xl p-8 shadow-2xl overflow-hidden border border-slate-800">
        <!-- Abstract patterns -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-primary-500/10 rounded-full -mr-32 -mt-32 blur-3xl"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-500/10 rounded-full -ml-24 -mb-24 blur-3xl"></div>
        
        <div class="relative z-10 flex flex-col h-full justify-between">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Saldo Disponible</p>
              <h2 id="balance-amount" class="text-5xl font-black text-white tracking-tighter">$180.00</h2>
              <p class="text-xs text-slate-500 font-bold mt-1">MXN Peso Mexicano</p>
            </div>
            <div class="px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-[10px] font-black rounded-full uppercase tracking-wider">
              Activo
            </div>
          </div>

          <div class="mt-12 flex gap-4">
            <button id="open-recharge" popovertarget="recharge-popover" class="flex-1 bg-white hover:bg-slate-100 text-slate-900 font-black py-4 rounded-2xl transition-all active:scale-95 shadow-xl shadow-white/5">
              RECARGAR
            </button>
            <button class="px-6 bg-slate-800 hover:bg-slate-700 text-white font-black py-4 rounded-2xl transition-all active:scale-95 border border-slate-700">
              <span class="text-xl">ðŸ“Š</span>
            </button>
          </div>
        </div>
        
        <!-- Animated Wave (Decorative) -->
        <div class="absolute -bottom-4 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-primary-500/50 to-transparent blur-sm"></div>
      </div>
    </section>

    <!-- Recent Transactions -->
    <section class="max-w-xl mx-auto">
      <div class="flex items-center justify-between mb-4 px-2">
        <h3 class="text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Ãšltimos Movimientos</h3>
        <button class="text-[10px] font-black text-primary-600 dark:text-primary-400 uppercase tracking-wider">Ver Todo</button>
      </div>

      <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
        <div id="transactions-container">
          <div class="p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl flex items-center justify-center text-emerald-600 dark:text-emerald-400 text-lg">
                ðŸ’¸
              </div>
              <div>
                <p class="text-sm font-bold text-slate-800 dark:text-slate-200">Recarga mediante OXXO</p>
                <p class="text-[10px] font-medium text-slate-400 dark:text-slate-500 lowercase">Hoy, 10:24 am</p>
              </div>
            </div>
            <span class="text-sm font-black text-emerald-600 dark:text-emerald-400">+$100.00</span>
          </div>
          
          <div class="p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-800">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-center text-slate-600 dark:text-slate-400 text-lg">
                ðŸšŒ
              </div>
              <div>
                <p class="text-sm font-bold text-slate-800 dark:text-slate-200">Ruta R-2 (Mercado 28)</p>
                <p class="text-[10px] font-medium text-slate-400 dark:text-slate-500 lowercase">Ayer, 06:15 pm</p>
              </div>
            </div>
            <span class="text-sm font-black text-slate-900 dark:text-white">-$12.00</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Monthly Stats -->
    <section class="max-w-xl mx-auto grid grid-cols-2 gap-4">
      <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm text-center">
        <p class="text-2xl font-black text-primary-500">12</p>
        <p class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mt-1">Viajes este mes</p>
      </div>
      <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm text-center">
        <p class="text-2xl font-black text-emerald-500">4.8</p>
        <p class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mt-1">Rating de PuntuaciÃ³n</p>
      </div>
    </section>

  </div>

  <!-- Recharge Popover -->
  <div id="recharge-popover" popover class="bg-white dark:bg-slate-900 rounded-3xl p-0 shadow-2xl w-[90%] max-w-sm border border-slate-200 dark:border-slate-800 overflow-hidden graffiti-dialog-popover">
    <div class="p-6">
      <h3 class="text-xl font-black text-slate-800 dark:text-white mb-2">Recargar Saldo</h3>
      <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">El monto se acreditarÃ¡ instantÃ¡neamente a tu billetera virtual.</p>
      
      <div class="grid grid-cols-3 gap-3 mb-8 graffiti-radio-group">
        <label class="amount-label" tabindex="0">
            <input type="radio" name="recharge-amount" value="20" class="sr-only amount-radio" />
            <span class="amount-text">$20</span>
        </label>

        <label class="amount-label" tabindex="0">
            <input type="radio" name="recharge-amount" value="50" class="sr-only amount-radio" checked />
            <span class="amount-text">$50</span>
        </label>

        <label class="amount-label" tabindex="0">
            <input type="radio" name="recharge-amount" value="100" class="sr-only amount-radio" />
            <span class="amount-text">$100</span>
        </label>
      </div>

      <div class="flex flex-col gap-3">
        <button id="confirm-recharge" class="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-4 rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all uppercase tracking-widest">
          CONFIRMAR PAGO
        </button>
        <button id="close-recharge" popovertarget="recharge-popover" popovertargetaction="hide" class="w-full bg-transparent text-slate-400 dark:text-slate-500 py-2 font-bold text-xs uppercase tracking-widest">
          CANCELAR
        </button>
      </div>
    </div>
  </div>

  <style>
    /*
     * GRAFFITI WARRIOR: CSS5 LOGIC
     * Native Popover instead of polyfilled dialogs.
     * Uses `@starting-style` for sweet, native animations.
     */
    .graffiti-dialog-popover {
      margin: auto; /* Centered in viewport */

      /* Base Animation State */
      opacity: 0;
      transform: translateY(1rem) scale(0.95);
      transition: opacity 0.3s ease-out, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), overlay 0.3s allow-discrete, display 0.3s allow-discrete;

      /* Open State */
      &:popover-open {
        opacity: 1;
        transform: translateY(0) scale(1);

        @starting-style {
          opacity: 0;
          transform: translateY(1rem) scale(0.95);
        }
      }

      /* Backdrop Styling & Animation */
      &::backdrop {
        background: rgba(15, 23, 42, 0.5); /* slate-900/50 */
        backdrop-filter: blur(4px);
        opacity: 0;
        transition: opacity 0.3s ease-out, overlay 0.3s allow-discrete, display 0.3s allow-discrete;
      }

      &:popover-open::backdrop {
        opacity: 1;

        @starting-style {
          opacity: 0;
        }
      }
    }

    /*
     * Native Radio Group Styling
     * Uses `:has()` and `:checked` to eliminate JS state toggling
     */
    .graffiti-radio-group {
      .amount-label {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem 0; /* py-4 equivalent */
        border-radius: 0.75rem; /* rounded-xl equivalent */
        border: 2px solid #f1f5f9; /* border-slate-100 */
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        user-select: none;

        /* Dark mode border fallback */
        @media (prefers-color-scheme: dark) {
            border-color: #1e293b; /* border-slate-800 */
        }

        /* Hover State */
        &:hover {
          border-color: #f97316; /* border-primary-500 */
        }

        /* Active State */
        &:active {
          transform: scale(0.95);
        }

        /* Focus State for Accessibility */
        &:focus-within, &:focus-visible {
          outline: 2px solid #f97316; /* primary-500 */
          outline-offset: 2px;
        }

        .amount-text {
          font-weight: 900; /* font-black */
          color: #475569; /* text-slate-600 */

          /* Dark mode text fallback */
          @media (prefers-color-scheme: dark) {
            color: #94a3b8; /* text-slate-400 */
          }
        }
      }

      /* Checked State Logic using Native CSS */
      .amount-label:has(.amount-radio:checked) {
        border-color: #f97316; /* border-primary-500 */
        background-color: rgba(249, 115, 22, 0.1); /* bg-primary-50/50 approx */

        @media (prefers-color-scheme: dark) {
            background-color: rgba(249, 115, 22, 0.2); /* bg-primary-900/20 approx */
        }

        .amount-text {
          color: #ea580c; /* text-primary-600 */

          @media (prefers-color-scheme: dark) {
            color: #fb923c; /* text-primary-400 */
          }
        }
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>

  <script>
    import { getWalletBalance, setWalletBalance } from '../utils/db';

    async function setupWallet() {
      const balanceAmount = document.getElementById('balance-amount');
      const confirmBtn = document.getElementById('confirm-recharge');
      const popover = document.getElementById('recharge-popover');

      async function updateBalanceUI() {
          // Use IndexedDB as single source of truth
          const walletData = await getWalletBalance();
          const balance = walletData?.amount ?? 180.00;
          if (balanceAmount) balanceAmount.textContent = `$${balance.toFixed(2)}`;
      }

      // Initial load - wait for IndexedDB to be ready
      await updateBalanceUI();

      confirmBtn?.addEventListener('click', async () => {
          // Native Radio check
          const selectedRadio = document.querySelector('input[name="recharge-amount"]:checked') as HTMLInputElement;
          const selectedAmount = selectedRadio ? parseInt(selectedRadio.value) : 50;

          // Use IndexedDB as single source of truth
          const walletData = await getWalletBalance();
          const currentBalance = walletData?.amount ?? 180.00;
          const newBalance = currentBalance + selectedAmount;

          // Update IndexedDB
          await setWalletBalance(newBalance);

          // Update UI
          if (balanceAmount) balanceAmount.textContent = `$${newBalance.toFixed(2)}`;

          // Dispatch Global Sync Event
          window.dispatchEvent(new CustomEvent('BALANCE_UPDATED'));

          // Native Popover Hide
          if (popover && popover.matches(':popover-open')) {
            // @ts-ignore
            popover.hidePopover();
          }

          // @ts-ignore
          if (window.showToast) {
            // @ts-ignore
            window.showToast(`Â¡Recarga exitosa! +$${selectedAmount}`, "success");
          }
      });
    }

    document.addEventListener('astro:page-load', setupWallet);
    if (document.readyState === 'complete') setupWallet();
    else window.addEventListener('load', setupWallet);
  </script>
</MainLayout>
